// Workflow Builder Client Script Library
// Alfa-XP, Michael Isipciuc, 2012.
//
RMC.WorkflowBuilder=function(c,b,a){this.$p=c;this.$body=$(document.body);this.data=b;this.ticket=this.data.ticket||"";this.name=this.data.w||"";this._window=a;if(a){a.setBackground("#d8e6f7")}this.xn_steps=[];if(!this.name&&!this.ticket){this.enterNewName()}else{this.prepareInit()}};RMC.WorkflowBuilder.prototype={prepareInit:function(){if(!RMC.WorkflowBuilder.template){$.get(RMC.Path+"WorkflowBuilder/designer.aspx",$createDelegate(function(a){RMC.WorkflowBuilder.template=a;this.init()},this))}else{this.init()}},init:function(){this.$p.html(RMC.WorkflowBuilder.template);if(this.name&&this.name.indexOf(";")>0){this.name=this.name.replace(";","/")}var a='{"ticket":"'+this.ticket+'","name":"'+this.name+'"}';ExecuteService(a,RMC.Path+"WorkflowBuilder/SupportService.asmx/LoadXml",$.proxy(this.onLoadState,this),_fm_onHandlerError);this.$canvas=$("div#canvas",this.$p);this.$canvas.addHandler("click",this.canvas_click,this);$("div#buttons",this.$p).addHandler("click",this.btn_click,this);$("a#btnLog",this.$p).toggle(this.ticket?true:false);this.$canvas.addHandler("mousedown",this.canvas_onclick,this);this.$code=$("textarea#code",this.$p);this.$code.addHandler("change",this.set_changed,this);this.toolbar_init($("div.wf-toolbar",this.$p));this.$btnTrash=$("#btnTrash",this.$p);$("a#btnPrint",this.$p).addHandler("click",this.btn_click,this)},onLoadState:function(a){var b=a.d;if(b.Error!=null){AX.Window.alert("Initialization",b.Error);this.$p.find("div#buttons").hide();return}this.WorkflowName=b.Value;if(this._window){this._window.setHeader(this.WorkflowName+" - Workflow Schema Viewer")}this.xmlParser=xml_createParser();this.loadXmlSchema(b.Data);this.redraw();this.set_changed(false);if(this.ticket){var c='{"ticket":"'+this.ticket+'"}';ExecuteService(c,RMC.Path+"WorkflowBuilder/SupportService.asmx/GetInfo",$createDelegate(this.onGetInfo,this))}},loadXmlSchema:function(a){this.sourceXml=a;this.xmlDoc=xml_loadXML(this.xmlParser,a);this.$xnworkflow=$(":first",this.xmlDoc);$("#pnlInfo",this.$p).text("last modified on "+(this.$xnworkflow.attr("modified")||"").replace("T"," ")+" by "+this.$xnworkflow.attr("author"))},redraw:function(){this.xn_steps=[];var b=$("Sequence:first",this.$xnworkflow);var a=this.buildSequence(b,"",true);$("div#canvas",this.$p).empty().html(a)},onGetInfo:function(b){var g=b.d;if(g.Error!=null){AX.Window.alert("Initialization",g.Error);return}var g=b.d;var h=g.Data.split(",");var d=null;for(var f=0;f<h.length;f++){var e=h[f];d=this.$p.find("#activity_"+e);d.append("<a class='state' key='"+e+"' title='Show assigned data'></a>")}if(d){d.addClass("selected")}var a=g.Value;if(a){var c=$("<div style='position:absolute;top:75px;left:10px;'><a class='fm' style='font-weight:bold;' title='Open Parent Scheme'>"+a+"</a><i> / Sub Workflow</i><div>");this.$p.append(c);$(c.children()[0]).click(function(){RMC_OpenWorkflowBuilder(a)})}},loadStateInfo:function(c){var a=c.getAttribute("key");var b='{"ticket":"'+this.ticket+'","key":"'+a+'"}';ExecuteService(b,RMC.Path+"WorkflowBuilder/SupportService.asmx/GetStepInfo",$createDelegate(this.onLoadStepInfo,this))},onLoadStepInfo:function(a){var b=a.d;if(b.Error!=null){AX.Window.alert("Initialization",b.Error);return}var b=a.d;AX.Window.alert(b.Value+" - Assigned Data",b.Data)},buildSequence:function(f,h,a){var g="<table class='sequence' cellpadding='0' cellspacing='0' level='"+h+"'><tr>";if(a){g+="<td><div class='start'/></td>"}g+="<td class='arrow'><div class='arrow' index='"+h+"-1'/></td>";var b=f.children();for(var d=0;d<b.length;d++){var e=b[d];var c=e.tagName;g+="<td>";if(c=="Switch"){g+=this.buildSwitch($(e),h,d)}else{g+=this.buildActivity($(e),c)}g+="</td>";g+="<td class='arrow'><div class='arrow' index='"+h+d+"'/></td>"}if(b.length==0){g+="<td style='vertical-align:middle;font-style:italic;font-size:7pt;'><div class='layout-line' style='width:118px;'>drag an activity here</div></td>";g+="<td class='arrow'><div class='arrow' index='"+h+"-1'/></td>"}if(a){g+="<td><div class='end'/></td>"}g+="</tr></table>";return g},buildActivity:function(g,e){var d="";var c=$("Settings",g);var a=g.attr("name");var h=g.attr("title");var f="";switch(e){case"Invoke":h=h||"FORM";d=g.attr("control");if(d=="Form"){d=c.attr("table")+"<br/>"+c.attr("form");f="<a class='frm_ico' t='"+c.attr("table")+"' f='"+c.attr("form")+"' title='Customize form'></a>"}else{e="InvokeControl"}break;case"UpdateRecord":h=h||"UPDATE";d=c.attr("table")+"<br/>"+c.attr("form");break;case"CreateRecord":h=h||"CREATE";d=c.attr("table")+"<br/>"+c.attr("form");break;case"XmlIsland":h=h||"SELECT";d=c.attr("table");break;case"ExecuteRequest":var b=g.attr("type");d="";break;case"ExecStoredProcedure":h="SP";d=c.attr("method");if(!d){d="[SQL]"}break;case"SubWorkflow":d="<a class='sw'>"+c.attr("workflow")+"</a>";break;default:e="Step";break}return"<div id='activity_"+a+"' class='activity activity-"+e+"'><label>"+h+"</label><div class='activity-sep' /><span>"+a+"<br/><br/>"+d+"</span>"+f+"</div>"},buildSwitch:function(f,a,e){var h="<div class='switch_panel' style='position:relative;border:solid 1px #ebebe9;' index='"+a+e+"'>";h+="<table class='switch' cellpadding='0' cellspacing='0'>";var j=f.children();var d=j.length;for(var c=0;c<d;c++){var b=$(j[c]);h+="<tr>";h+="<td><div style='width:50px;'/></td>";if(c==0){h+="<td style='height:160px;vertical-align:bottom;padding:0;width:1px;'><div class='layout-T-line'></div></td>"}else{if(c==d-1){h+="<td style='height:155px;vertical-align:top;padding:0;width:1px;'><div class='layout-L-line'></div></td>"}else{h+="<td style='height:155px;padding:0;width:1px;'><div class='layout-I-line'></div></td>"}}h+="<td style='vertical-align:middle;'><div style='width:40px;' class='layout-line'></div></td>";if(b[0].tagName=="Case"){var g=b.attr("test");g=g.replace(/"/g,"''");h+="<td><div class='branch' title=\""+g+"\" i='"+a+e+"' bi='"+c+"'/></td>"}else{h+="<td style='vertical-align:middle;'><div class='layout-line'></div></td>"}h+="<td>";h+=this.buildSequence($(b.children()[0]),a+e+"."+c+".",false);h+="</td>";h+="</tr>"}h+="</table>";h+="<div class='switch' style='position:absolute;left:0;top:50%;margin-top:-50px'></div>";h+="</div>";return h},canvas_onclick:function(a){var b=a.target;if(this.ismoving){this.canvasOnMoveEnd(a);return}if(b.tagName=="SPAN"||b.tagName=="LABEL"){b=b.parentNode}if(b.tagName=="DIV"){this.is_new=false;if(b.className.indexOf("activity")==0){this.node_mousedown(a,b)}else{if(b.className=="switch"){this.node_mousedown(a,b.parentNode)}}}},node_mousedown:function(a,b){a.stopPropagation();a.preventDefault();this.moving_pos=a.pageX+a.pageY;this.moving_event=a;this.$dragNode=$(b);this.$dragNode.on("mousemove",$.proxy(this.node_mousemove,this));this.$dragNode.on("mouseup",$.proxy(this.node_onclick,this));this.$dragNode.addClass("clicked")},node_mousemove:function(a){if(Math.abs(a.pageX+a.pageY-this.moving_pos)>6){this.$dragNode.removeClass("clicked");this.$dragNode.off("mousemove").off("mouseup");this.startMoving()}},node_onclick:function(e){this.$dragNode.removeClass("clicked");this.$dragNode.off("mousemove").off("mouseup");var $xn_node=this.findXmlNodeByUI(this.$dragNode);if($isNull($xn_node)){return}var designer=this;var tagName=$xn_node[0].tagName;if(tagName=="CreateRecord"){tagName="UpdateRecord"}else{if(tagName=="ExecuteRequest"&&$xn_node.attr("type")=="MailService"){tagName="MailService"}else{if(tagName=="Invoke"&&$xn_node.attr("control")!="Form"){tagName="CustomControl"}}}var dlgName="RMC.WB_"+tagName;RMC_OpenOrCreate(dlgName,tagName+" Properties",500,480,RMC.Path+"WorkflowBuilder/Dialogs/"+tagName+".ascx",[RMC.Path+"WorkflowBuilder/Dialogs/properties.js"],function(wnd){var dialogType=window.eval("RMC.WB_"+tagName);wnd.component=new dialogType(wnd)},function(wnd){wnd.component.LoadState(designer,$xn_node)},$createDelegate(this.properties_closed,this))},properties_closed:function(b){if(!b){return}var a=this.findXmlNodeByUI(this.$dragNode);if($isNull(a)){return}var c=this.buildActivity(a,a[0].tagName);this.$dragNode.html($(c).html())},branch_onclick:function(f,g){var d=g.getAttribute("i");var c=g.getAttribute("bi");var b=this.findXmlNode(d);if($isNull(b)){return}var a=$(b.children()[parseInt(c)]);RMC.WorkflowBuilder.OpenConditionDialog(this.xmlDoc,a,$createDelegate(function(){this.set_changed(true)},this))},startMoving:function(){var a=this.moving_event;this.ismoving=true;if(!this._dragElement){this._dragElement=$("<div style='position:absolute;z-Index:1000;' class='fm-shadow'></div>");this.$p.append(this._dragElement)}if(this.is_new){this._dragElement.html("<div class='wf-toolitem' style='margin:3px;background-color:#FFF'>"+this.$dragNode.html()+"</div>")}else{this._dragElement.html(this.$dragNode.parent().html())}if(!this.is_new){this.$btnTrash.show()}this.$p.focus();this.$p.on({keypress:$.proxy(this.onkeypress,this),mousemove:$.proxy(this.canvasOnMove,this),mouseup:$.proxy(this.canvasOnMoveEnd,this),mouseover:$.proxy(this.canvasOnMoveOver,this)});if(this.$dragNode[0].className=="switch_panel"){this.$dragNode.css("visibility","hidden");this.$dragNode.parent().css("background-color","#f9f9f9")}else{this.$dragNode.css("opacity",0.2)}this.canvasOnMove(a);this._dragElement.css("display","")},onkeypress:function(a){if(a.keyCode==27){this._dragToNode=null;this.canvasOnMoveEnd(null)}},canvasOnMove:function(b){var a=b.pageX;var c=b.pageY;this._dragElement.css({left:(a+5)+"px",top:(c+5)+"px"})},dragNodeOnMoveOver:function(a){a.stopPropagation();a.preventDefault();var b=$(this._dragElement.children()[1]);this._dragToNode=null},canvasOnMoveOver:function(c){var b=this._dragElement;var d=c.target;if(d.tagName=="TD"&&d.className=="arrow"){d=d.firstChild}if(d.tagName=="DIV"&&d.className=="layout-line"){d=d.parentNode.previousSibling.firstChild}if(d.tagName=="DIV"&&d.className=="arrow"){if(this._dragPointer&&this._dragPointer!=d){this._dragPointer.className="arrow"}this._dragPointer=d;d.className="arrow-bullet"}},canvasOnMoveEnd:function(g){this.ismoving=false;this.$p.off("keypress").off("mouseup").off("mousemove").off("mouseover");this._dragElement.css("display","none");this.$btnTrash.hide();if(this._dragPointer){this._dragPointer.className="arrow"}if(this.$dragNode[0].className=="switch_panel"){this.$dragNode.css("visibility","visible");this.$dragNode.parent().css("background-color","")}else{this.$dragNode.css("opacity",1)}if(!g){return}if(g.target.id=="btnTrash"){var a=this.findXmlNodeByUI(this.$dragNode);if($isNull(a)){return}a.remove();this.set_changed(true);this.redraw()}else{if(this._dragPointer){var f=this._dragPointer;this._dragPointer=null;var a;if(this.is_new){a=RMC.WorkflowBuilder.createActivity(this.xmlDoc,this.$dragNode.attr("n"))}else{a=this.findXmlNodeByUI(this.$dragNode);if($isNull(a)){return}}if($isNull(a)){return}var c=f.getAttribute("index");var d="after";var b=this.findXmlNode(c);if($isNull(b)){return}if(c.indexOf("-1")!=-1){d="append";if(b.children().length>0){d="before";b=$(b.children()[0])}}if(b[0]==a[0]){return}if(d=="after"){a.insertAfter(b)}else{if(d=="before"){a.insertBefore(b)}else{if(d=="append"){b.append(a)}}}this.set_changed(true);this.redraw()}}},findXmlNodeByUI:function(b){var a=b.parent().next().children()[0].getAttribute("index");return this.findXmlNode(a)},findXmlNode:function(b){var a=b.split(".");var e=$("Sequence:first",this.$xnworkflow);for(var f=0;f<a.length;f++){var d=a[f];if(d=="-1"){return e}var c=e.children()[parseInt(d)];if(c.tagName=="Case"||c.tagName=="Otherwise"){e=$("Sequence:first",c)}else{e=$(c)}}return $(c)},checkForChildren:function(b){if(b.children().length==0){var a=b.parent().children()[0];a.className="";b.css("display","none")}},set_changed:function(a){this.is_changed=(a==false)?false:true;window.status=this.is_changed?"changed":""},properties_onsave:function(a){if(a){this.set_changed(true);this.redraw()}},openProperties:function(){var a=this;var b=this.$xnworkflow;RMC_OpenOrCreate("RMC.WB_Properties","Workflow Properties",450,405,RMC.Path+"WorkflowBuilder/Dialogs/Properties.ascx",[RMC.Path+"WorkflowBuilder/Dialogs/properties.js"],function(c){c.component=new RMC.WB_Properties(c)},function(c){c.component.LoadState(a,b)},null)},openLogViewer:function(){if(!this.traceLogWindow){var b=$("<textarea style='width:99%;height:99%;'></textarea>");this.traceLogWindow=AX.Window.createPopupWindow("Trace Log Viewer",600,500,true,false);this.traceLogWindow.loadElement(b);this.traceLogWindow.$tb=b}var a='{"ticket":"'+this.ticket+'"}';ExecuteService(a,RMC.Path+"WorkflowBuilder/SupportService.asmx/LoadTraceLog",$createDelegate(function(c){this.traceLogWindow.$tb.val(c.d)},this));this.traceLogWindow.$tb.val("");this.traceLogWindow.show()},toggleToSourceEditor:function(){if(!this.SourceCodeMode){this.SourceCodeMode=true;$("div#canvas",this.$p).parent().hide();this.$code.parent().show();$("a#btnSource",this.$p).text("Back to schema");if(!this.$code){}if(this.is_changed){this.sourceXml=xml_convertToString(this.xmlDoc);this.set_changed(false)}this.$code.val(this.sourceXml)}else{this.SourceCodeMode=false;$("div#canvas",this.$p).parent().show();this.$code.parent().hide();$("a#btnSource",this.$p).text("View code");if(this.is_changed){this.loadXmlSchema(this.$code.val().trim());this.set_changed(false);this.redraw()}}},Save:function(){if(this.SourceCodeMode){this.sourceXml=this.$code.val().trim()}else{if(this.is_changed){this.sourceXml=xml_convertToString(this.xmlDoc);this.set_changed(false)}}var a='{"ticket":"'+this.ticket+'","name":"'+this.name+'","xmlData":"'+jsonEncode(this.sourceXml)+'"}';ExecuteService(a,RMC.Path+"WorkflowBuilder/SupportService.asmx/SaveXml",$createDelegate(function(b){if(b.d.Error){alert(b.d.Error);return}AX.Window.alert("","Workflow schema has been saved.",this.Close,this)},this))},toolbar_init:function(a){this.$toolbar=a;this.$toolbar.addHandler("mousedown",this.toolbar_mousedown,this)},toolbar_mousedown:function(a){var b=a.target;if(b.tagName=="SPAN"||b.tagName=="IMG"){b=b.parentNode}if(b.className=="wf-toolitem"){this.is_new=true;this.node_mousedown(a,b)}},Close:function(){if(this._window){this._window.close()}else{window.close()}},PrintSchema:function(){var a="/ASP.Net/FM/DataViewer/Print/FileDownloader.aspx?url=../../Explorer/Diagnostics/Print/Report.aspx?workflow="+this.WorkflowName;window.parent.AX.Window.createFrameWindow(a,"Workflow Schema Report",480,250)},enterNewName:function(){var f=$createDelegate(function(g){if(g){window.location.href="#WorkflowBuilder/w="+g;return true}else{return false}},this);var d="Workflow";var b=$('<div><div style="white-space:nowrap;margin:30px 20px;"><div style="white-space:nowrap;margin:10px 20px;"><label style="width:90px" class="fm-lbl">Name:</label><input class="fm" style="width:230px;height:22px;" /></div></div>');var a=b.find("INPUT:first");var c=function(){var g=a.val().trim();return f(g)};var e=RMC_createDialog("New "+d,"Please type the name for the new "+d,b,400,200,c);e.show();a.focus()},canvas_click:function(c){var d=c.target;if(d.tagName=="A"){if(d.className=="state"){this.loadStateInfo(d)}else{if(d.className=="frm_ico"){RMC_OpenFormBuilder(d.getAttribute("t"),d.getAttribute("f"))}else{if(d.className=="sw"){var a=$(d).text();var b=window.parent.FM.SubWorkflowDialog;if(!b){b=window.parent.FM.SubWorkflowDialog=new window.parent.AX.Window(false);b.setSize(1140,670)}b.loadURL(FM.Path+"Explorer/#WorkflowBuilder/w="+a);b.show()}}}}else{if(d.tagName=="DIV"&&d.className=="branch"){this.branch_onclick(c,d)}}},btn_click:function(a){switch(_fm_getCommand(a)){case"XML_EDITOR":this.toggleToSourceEditor();break;case"LOG":this.openLogViewer();break;case"PROPERTIES":this.openProperties();break;case"PRINT":this.PrintSchema();break;case"saveX":this.Save();break;case"X":this.Close();break}}};RMC.WorkflowBuilder.OpenConditionDialog=function(c,a,b){var d=RMC.WorkflowBuilder.ConditionDialog;if(!d){window.Runtime_Library.createObject("RMC.WB_SwitchConditionDialog",[RMC.Path+"WorkflowBuilder/Dialogs/properties.js",FM.Path+"Explorer/WorkflowBuilder/Dialogs/switch_condition.js"],function(e){RMC.WorkflowBuilder.ConditionDialog=e;e.Show(c,a,b)})}else{d.Show(c,a,b)}};RMC.WorkflowBuilder.promptDialog=function(d,e){var c=$('<div><div style="white-space:nowrap;margin:10px 20px;"><label style="width:90px" class="fm-lbl">Name:</label><input class="fm" style="width:230px;height:22px;" /></div></div>');var b=c.find("INPUT");var a=$(b[0]);AX.Window.dialog("Add field",c,function(){var f=a.val().trim();if(f==""){return false}e(f);return true},this);a.focus()};RMC.WorkflowBuilder.createActivity=function(h,g){var d=null;var e,b;switch(g){case"Invoke/Form":b="FORM"+xml_random(1000);d=xml_createNode(h,"Invoke");d.attr("name",b).attr("title","FORM").attr("control","Form");e=xml_appendNode(h,d,"Settings");e.attr("table","").attr("form","");xml_appendNode(h,d,"Assign");break;case"Invoke/Control":b="Control"+xml_random(1000);d=xml_createNode(h,"Invoke");d.attr("name",b).attr("title","CONTROL").attr("control","SERVERCONTROL").attr("controlInfo","");e=xml_appendNode(h,d,"Settings");e.attr("table","").attr("form","");xml_appendNode(h,d,"Assign");break;case"XmlIsland":b="DATA"+xml_random(1000);d=xml_createNode(h,"XmlIsland");d.attr("name",b).attr("title","Select");e=xml_appendNode(h,d,"Settings");e.attr("table","");xml_appendNode(h,d,"FieldSet");xml_appendNode(h,d,"Assign");break;case"UpdateRecord":b="Update"+xml_random(1000);d=xml_createNode(h,"UpdateRecord");d.attr("name",b).attr("title","Modify");e=xml_appendNode(h,d,"Settings");e.attr("table","").attr("form","");xml_appendNode(h,d,"Assign");break;case"ExecStoredProcedure":b="SP"+xml_random(1000);d=xml_createNode(h,"ExecStoredProcedure");d.attr("name",b).attr("title","SP");e=xml_appendNode(h,d,"Settings");e.attr("method","");xml_appendNode(h,d,"Assign");break;case"ExecuteRequest/MailService":b="Mail"+xml_random(1000);d=xml_createNode(h,"ExecuteRequest");d.attr("name",b).attr("title","Send Mail").attr("type","MailService");e=xml_appendNode(h,d,"Settings");e.attr("method","Send");xml_appendNode(h,d,"Assign");break;case"ExecuteRequest/WebService":b="Service"+xml_random(1000);d=xml_createNode(h,"ExecuteRequest");d.attr("name",b).attr("title","Web Service").attr("type","WebService").attr("url","HelloWorldService.asmx");e=xml_appendNode(h,d,"Settings");e.attr("method","HelloWorld").attr("namespace","http://tempuri.org/");xml_appendNode(h,d,"Assign");break;case"SubWorkflow":b="SubWorkflow"+xml_random(100);d=xml_createNode(h,"SubWorkflow");d.attr("name",b).attr("title","Sub Workflow");e=xml_appendNode(h,d,"Settings");e.attr("workflow","");var c=xml_appendNode(h,d,"Assign");var i=xml_appendNode(h,c,"Field");i.attr("name","id").attr("value","");break;case"Switch":d=xml_createNode(h,"Switch");var a=xml_appendNode(h,d,"Case");a.attr("test","");xml_appendNode(h,a,"Sequence");var f=xml_appendNode(h,d,"Otherwise");xml_appendNode(h,f,"Sequence");break}return d};