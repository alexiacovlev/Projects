RMC.FieldPropertiesDialog=function(b){this._window=b;var a=b.$content;$("#_bottomButtons",a).addHandler("click",this.btn_click,this);this.$btnChangeType=$("#btnChangeType",a);this.$tb_title=$("#tb_title",a);this.$tb_name=$("#tb_name",a);this.$tb_type=$("#tb_type",a);this.$tb_description=$("#tb_description",a);this.$cb_required=$("#cb_required",a);this.$cb_readonly=$("#cb_readonly",a);this.$panelText=$("#panelText",a);this.$panelNumber=$("#panelNumber",a);this.$panelPicklist=$("#panelPicklist",a);this.$panelExtract=$("#panelExtract",a);this.$panelRelation=$("#panelRelation",a);this.$panelDateTime=$("#panelDateTime",a);this.$panelBoolean=$("#panelBoolean",a);this.$panelFile=$("#panelFile",a);this.$panelEditableGrid=$("#panelEditableGrid",a);this.$panelDbType=$("#panelDbType",a);this.$listDbType=$("select#listDbType",this.$panelDbType);this.new_mode=false;this.$btnChangeType.addHandler("click",this.changeType_click,this);this.$tb_title.addHandler("keyup",function(c){if(this.isNew){this.$tb_name.val(this.$tb_title.val().replace(/ /g,"_"))}},this)};RMC.FieldPropertiesDialog.prototype={LoadState:function(l,x,d,n){this.xmlNode=l;this.$xmlNode=$(l);this.designer=x;this.OnChanged=d;this.autoUpdate=n;var g=this.$xmlNode;var y=l.getAttribute("name");var e=l.getAttribute("type");var u=l.getAttribute("dbtype");var v=(!y);this.isNew=v;this.togglePanels(e,u,v);var r=l.getAttribute("format");this.$tb_title.val(l.getAttribute("title"));this.$tb_name.val(l.getAttribute("name"));this.$tb_description.val(l.getAttribute("description"));this.$tb_type.val(e);this.$cb_required.prop("checked",l.getAttribute("required")=="true");this.$cb_readonly.prop("checked",l.getAttribute("readonly")=="true");var k=460;var s=450;var m=null;switch(e){case"Text":if(u!="Guid"){$("#tb_text_length",this.$panelText).val(l.getAttribute("size"));$("#cb_text_max",this.$panelText).prop("checked",l.getAttribute("size")=="");$("#cb_text_unicode",this.$panelText).prop("checked",u=="StringUnicode");$("#cb_text_textarea",this.$panelText).prop("checked",l.getAttribute("format")=="textarea")}m=["String","Guid","Int32","Decimal","Double","Boolean","DateTime"];break;case"Float":case"Money":if(!this.$ddl_precision){this.$ddl_precision=$("#ddl_precision",this.$panelNumber)}if(!this.$tb_sign){this.$tb_sign=$("#tb_sign",this.$panelNumber)}if(!this.panel_FloatFormat){this.panel_FloatFormat=new FM.RadioGroup($("#panel_FloatFormat",this.$panelNumber))}this.panel_FloatFormat.setValue(e);this.$ddl_precision.val(l.getAttribute("size")||"");m=["Decimal","Double"];break;case"Picklist":if(!this.rb_picklist_mode){this.rb_picklist_mode=new FM.RadioGroup($("#rb_picklist_mode",this.$panelPicklist));this.$listPicklistSource=$("select#listPicklistSource",this.$panelPicklist);this.$listPicklistSource.change($createDelegate(function(){var h=this.$listPicklistSource.val()=="DB";$("tr#tr_picklist_1",this.$panelPicklist).toggle(!h);$("tr#tr_picklist_2",this.$panelPicklist).toggle(h)},this));$("a#linkOptions",this.$panelPicklist).addHandler("click",this.openStaticOptions,this);this.$lookup_extract_table2=new FM.LookupTextControl($("#lookup_extract_table2",this.$panelPicklist));this.$tb_extract_view2=$("#tb_extract_view2",this.$panelPicklist)}var o=g.find("extract");var z=!$isNull(o);this.$listPicklistSource.val(z?"DB":"");this.rb_picklist_mode.setValue(r);this.$lookup_extract_table2.setValue(z?(o.attr("table")||""):"");this.$tb_extract_view2.val(z?(o.attr("view")||""):"");this.$listPicklistSource.change();m=["Int32","Guid","String"];break;case"Lookup":this.loadExtract(g.find("extract"));var j=g.find("relation");if(!$isNull(j)||r=="multi"){this.loadRelation(g,j,e,r);s=545}m=["Int32","Guid","String"];break;case"Checkboxlist":this.loadExtract(g.find("extract"));var j=g.find("relation");this.loadRelation(g,j,e,r);break;case"DateTime":if(!this.$rb_datetime_mode){var a=this.$rb_datetime_mode=new FM.RadioGroup($("#rb_datetime_mode",this.$panelDateTime));var c=this.$tb_format=$("#tb_format",this.$panelDateTime);$("#list_formats>A",this.$panelDateTime).click(function(){c.val(this.getAttribute("format"));a.setValue("custom")})}if(r=="datetime"||r==""){this.$rb_datetime_mode.setValue(r);this.$tb_format.val("")}else{this.$rb_datetime_mode.setValue("custom");this.$tb_format.val(r)}break;case"Boolean":if(!this.$rb_boolean_mode){this.$rb_boolean_mode=new FM.RadioGroup($("#rb_boolean_mode",this.$panelBoolean))}this.$rb_boolean_mode.setValue(r);break;case"Image":if(!this.$rb_image_mode){this.$rb_image_mode=new FM.RadioGroup($("#rb_image_mode",this.$panelFile))}if(!this.$tb_file){this.$tb_file=$("#tb_file",this.$panelFile)}if(r!=""&&r.indexOf("attachment:")==0){this.$tb_file.val(r.substring(r.indexOf(":")+1));this.$rb_image_mode.setValue("attachment")}else{this.$tb_file.val("");this.$rb_image_mode.setValue("photo")}break;case"EditableGrid":if(!this.lookup_slavegrid_table){this.lookup_slavegrid_table=new FM.LookupTextControl($("#lookup_slavegrid_table",this.$panelEditableGrid));this.$tb_slavegrid_view=$("#tb_slavegrid_view",this.$panelEditableGrid);this.$tb_slavegrid_parentkey=$("input#tb_slavegrid_parentkey",this.$panelEditableGrid);this.$panel_eg_list=$("#panel_eg_list",this.$panelEditableGrid)}var f=xml_getOrCreate(this.designer.xmlDoc,g,"slavegrid");this.lookup_slavegrid_table.setValue(f.attr("table")||"");this.$tb_slavegrid_view.val(f.attr("grid")||"");var t="";this.$panel_eg_list.empty();var b=f.children();for(var q=0;q<b.length;q++){var p=b[q];var y=p.getAttribute("name");var e=p.getAttribute("type");if(e=="parentkey"){t=y}else{this.$panel_eg_list.append('<div><input class="fm" style="width:150px;margin-left:5px;" disabled="disabled" value="'+y+'"/><input class="fm" style="width:100px;margin-left:5px;" disabled="disabled" value="'+p.getAttribute("value")+'"/></div>')}}this.$tb_slavegrid_parentkey.val(t);s=500;break}if(v){this.new_mode=true;this.$tb_name[0].className="fm";this.$tb_name.removeAttr("readonly");this.$btnChangeType.hide();if(u!=""){if(m==null){m=[];m.push(u)}this.$listDbType.empty();for(var q=0;q<m.length;q++){this.$listDbType.append("<option value='"+m[q]+"'>"+m[q]+"</option>")}this.$listDbType.val(u);this.$panelDbType.show();s+=20}else{this.$panelDbType.hide()}}else{if(this.new_mode){this.new_mode=false;this.$tb_name[0].className="fm ro";this.$tb_name.attr("readonly","true");this.$btnChangeType.show();this.$panelDbType.hide()}}this._window.setSize(k,s);this._window.setHeader(e+" - Field Properties");this._window.show();this._window.$content.fadeIn(100);this.$tb_title.focus()},saveState:function(){var p=this.xmlNode;var k=this.$xmlNode;var E=p.getAttribute("name");var B=(!E);var c=p.getAttribute("type");var A=p.getAttribute("dbtype");if(B){if($("input#cbVirtual").prop("checked")){p.setAttribute("dbtype",A="")}E=this.$tb_name.val().trim();var g=this.$tb_name;if(E==""){return FM.Validators.notify(g,"","Please, provide the field's name",-25,-3)}if(!FM.Validators.checkName(E)){return FM.Validators.notify(g,"","The field name must begin with an english letter",-25,-3)}if(this.fieldExists(E)){return AX.Window.alert("Field Registration","The field with the name <b>"+E+"</b> already exists.<br/><br/>Please, define another name.",function(){g.focus()})}}var f=A!="";var o=(B&&f);p.setAttribute("title",this.$tb_title.val().trim());p.setAttribute("description",this.$tb_description.val().trim());var m=this.$cb_required.is(":checked")?"true":"false";if(m!=p.getAttribute("required")){p.setAttribute("required",m);o=true}p.setAttribute("readonly",this.$cb_readonly.is(":checked")?"true":"false");switch(c){case"Text":var r=$("#tb_text_length",this.$panelText).val().trim();if($("#cb_text_max",this.$panelText).is(":checked")){r=""}if(r!=p.getAttribute("size")){p.setAttribute("size",r);o=true}var y=p.getAttribute("format");var h=$("#cb_text_textarea",this.$panelText).prop("checked");if(!y||y=="textarea"){p.setAttribute("format",h?"textarea":"")}if(f){var e="String";if(B){e=this.$listDbType.val()}if($("#cb_text_unicode",this.$panelText).is(":checked")){e="StringUnicode"}if(A!=e){p.setAttribute("dbtype",e);o=true}}break;case"Float":case"Money":var r=this.$ddl_precision.val();p.setAttribute("size",r);var j=this.panel_FloatFormat.getValue();if(j!=c){p.setAttribute("type",c=j);if(B&&f){p.setAttribute("dbtype",A=(j=="Money")?"Decimal":"Double")}}p.setAttribute("format",this.$tb_sign.val().trim());break;case"Picklist":p.setAttribute("format",this.rb_picklist_mode.getValue());var F=this.$listPicklistSource.val()=="DB";var s=k.find("extract");if(F){if($isNull(s)){s=xml_appendNode(this.designer.xmlDoc,k,"extract")}s.attr("table",this.$lookup_extract_table2.getValue());s.attr("view",this.$tb_extract_view2.val())}else{if(!$isNull(s)){s.remove()}}break;case"Lookup":var l=k.find("relation");var D=!$isNull(l);var s=this.saveExtract(k,D);if($isNull(s)){return}if(D){if(!l.attr("table")){AX.Window.alert("Field Registration","Please, configure <b>Relation Db Table</b> for the field.");return}p.setAttribute("format",this.$rb_lookup_mode.getValue())}break;case"Checkboxlist":var s=this.saveExtract(k,false);if($isNull(s)){return}var l=k.find("relation");if(!l.attr("table")){AX.Window.alert("Field Registration","Please, configure <b>Relation Db Table</b> for the field.");return}break;case"DateTime":var y=this.$rb_datetime_mode.getValue();if(y=="custom"){y=this.$tb_format.val().trim()}p.setAttribute("format",y);break;case"Boolean":p.setAttribute("format",this.$rb_boolean_mode.getValue());break;case"Image":var y="";if(this.$rb_image_mode.getValue()=="attachment"){y="attachment:"+this.$tb_file.val().trim()}p.setAttribute("format",y);break;case"EditableGrid":var d=k.find("slavegrid");var q=this.lookup_slavegrid_table.getValue().trim();var n=this.$tb_slavegrid_view.val().trim()||"default";var z=this.$tb_slavegrid_parentkey.val().trim();if(!q){return AX.Window.alert("Field Registration","To complete the registration, you should specify the <b>Table Name</b>.")}if(!z){return AX.Window.alert("Field Registration","To complete the registration, you should specify the <b>Primary Key</b>.")}d.attr("table",q).attr("grid",n);var a=d.children();var x=null;for(var w=0;w<a.length;w++){var u=a[w];if(u.getAttribute("type")=="parentkey"){x=$(u)}}if(x==null){x=xml_appendNode(this.designer.xmlDoc,d,"column")}x.attr("name",z).attr("type","parentkey");break}if(B){p.setAttribute("name",E)}if(this.autoUpdate){var b=xml_convertToString(p);var C='{"tableName":"'+this.designer.tableName+'","db_update":'+(o&&f)+',"xmlData":"'+jsonEncode(b)+'"}';FM.ProgressBar.Show("Updating",true);ExecuteService(C,RMC.Path+"TableBuilder/SupportService.asmx/UpdateFieldXml",$createDelegate(this.onAutoUpdate,this))}else{this._window.close();this.OnChanged(p,B,(o&&f))}},onAutoUpdate:function(a){FM.ProgressBar.Hide();if(a.d){AX.Window.alert(a.d)}else{this._window.close()}},loadExtract:function(b){var c=b.attr("table");var a=b.attr("view");if(!this.$lookup_extract_table){this.$lookup_extract_table=new FM.LookupTextControl($("#lookup_extract_table",this.$panelExtract))}this.$lookup_extract_table.setValue(c||"");if(!this.$tb_extract_view){this.$tb_extract_view=$("#tb_extract_view",this.$panelExtract)}this.$tb_extract_view.val(a||"");var e=b.attr("dialog");if(!this.$tb_extract_dialog){this.$tb_extract_dialog=$("#tb_extract_dialog",this.$panelRelation);this.$cb_extract_dialog=$("#cb_extract_dialog",this.$panelRelation);this.$cb_extract_dialog.change($createDelegate(function(){this.$tb_extract_dialog.toggle(this.$cb_extract_dialog.is(":checked"))},this))}this.$cb_extract_dialog.prop("checked",e!=null&&e!="").change();this.$tb_extract_dialog.val(e||"")},saveExtract:function(f,a){var e=this.$lookup_extract_table.getValue();var c=this.$tb_extract_view.val().trim();var g=this.$tb_extract_dialog.val().trim();if(!this.$cb_extract_dialog.is(":checked")){g=""}if(a){if(!e&&!g){AX.Window.alert("Field Registration","To complete the registration, you should specify<br/><b>lookup table</b> or <b>multi-typed dialog</b> with the collection<br/>of lookup views.");return}}else{if(!e){AX.Window.alert("Field Registration","To complete the registration, you should specify the <b>lookup table</b>.");return}}var b=xml_getOrCreate(this.designer.xmlDoc,f,"extract");b.attr("table",e);b.attr("view",c);if(a){xml_updateAttr(b,"dialog",g)}return b},loadRelation:function(c,b,a,d){if(!this.$panelRelationLookup){this.$panelRelationLookup=$("#panelRelationLookup",this.$panelRelation)}this.$panelRelationLookup.toggle(a=="Lookup");if($isNull(b)){b=xml_appendNode(this.designer.xmlDoc,c,"relation")}if(!this.$rb_lookup_mode){this.$rb_lookup_mode=new FM.RadioGroup($("#rb_lookup_mode",this.$panelRelation));this.$labelRelationTable=$("#labelRelationTable",this.$panelExtract_relation);$("a#linkRelation",this.$panelRelation).addHandler("click",this.openRelation,this)}this.$labelRelationTable.text(b.attr("table")||"not configured");this.$rb_lookup_mode.setValue(d);this.$panelRelation[0].style.display=""},openRelation:function(){var f=this.$lookup_extract_table.getValue();var e=this.$xmlNode;var a=this.$tb_name.val().trim();var b=this.designer;var d=$createDelegate(function(g){this.$labelRelationTable.text(g.attr("table")||"not configured")},this);var c=AX.Window.createPopupWindow("Field Relation Settings",550,350,false,true);c.loadASCX(RMC.Path+"TableBuilder/Dialogs/dlg_Relation.ascx",null,function(){new RMC.LookupRelationEditor(c,b,e,a,f,d)});c.show()},openStaticOptions:function(){var b=this.$tb_name.val();if(!b){AX.Window.alert("Please, enter the name for the field, before filling-up the list.");return}var a=this.designer.tableName;var c=AX.Window.createPopupWindow("Static Options",440,440,false,true);c.loadASCX(RMC.Path+"TableBuilder/Dialogs/dlg_StaticOptions.ascx",null,function(){new RMC.StaticOptionsEditor(c,a,b)});c.show()},togglePanels:function(c,b,a){this.$panelText[0].style.display=(c=="Text"&&b!="Guid")?"":"none";this.$panelNumber[0].style.display=(c=="Float"||c=="Money")?"":"none";this.$panelPicklist[0].style.display=(c=="Picklist")?"":"none";this.$panelExtract[0].style.display=(c=="Lookup"||c=="Checkboxlist")?"":"none";this.$panelDateTime[0].style.display=(c=="DateTime")?"":"none";this.$panelBoolean[0].style.display=(c=="Boolean")?"":"none";this.$panelFile[0].style.display=(c=="Image")?"":"none";this.$panelEditableGrid[0].style.display=(c=="EditableGrid")?"":"none";this.$panelRelation[0].style.display="none";var d=(a&&b!="")},fieldExists:function(a){var c=this.designer.$xnfields.children();a=a.toLowerCase();for(var b=0;b<c.length;b++){if(c[b].getAttribute("name").toLowerCase()==a){return true}}return false},changeType_click:function(){var f=this.xmlNode.getAttribute("type");var b=this.xmlNode.getAttribute("dbtype");var a=[f];switch(f){case"Text":a.push("Lookup","Picklist","Integer","Float","Money","DateTime","Boolean");break;case"Lookup":a.push("Picklist",((b=="Int32")?"Integer":"Text"));break;case"Picklist":a.push("Lookup",((b=="Int32")?"Integer":"Text"));break;case"Integer":a.push("Text","Lookup","Picklist");break;case"Float":a.push("Text","Money");break;case"Money":a.push("Text","Float");break;case"Boolean":a.push("Text");break;case"DateTime":a.push("Text");break}var e="";e+="<div class='fm-dlg'>";for(var d=0;d<a.length;d++){e+="<label class='fm-chk' style='display:block;margin:5px;'><input type=\"radio\" name=\"ChangeType\"";if(d==0){e+=" checked"}e+=' value="'+a[d]+'" />'+a[d]+"</label>"}e+="</div>";var c=$(e);var g=new FM.RadioGroup(c);var h=$createDelegate(this.onChangeType,this);AX.Window.dialog("Change Field Type",c,function(){h(f,g.getValue());return true},this)},onChangeType:function(a,b){if(a==b){return}this.$xmlNode.attr("type",b);if(b=="Text"&&(a=="Lookup"||a=="Picklist")){this.$xmlNode.find("extract").remove()}this.LoadState(this.xmlNode,this.designer,this.OnChanged,this.autoUpdate)},btn_click:function(a){switch(_fm_getCommand(a)){case"OK":this.saveState();break;case"X":this._window.close();break}}};