// RecordsManagement Admin Client Script Library
// Alfa-XP,	Michael	Isipciuc,	2012.
// this object has private instance for each view
RMC.TableBuilder=function(c,b,a){this.$p=c;this.data=b;this.tableName=this.data.t;this._window=a;if(a){a.setHeader(b.t+" - Table Settings")}if(!RMC.TableBuilder.template){$.get(RMC.Path+"TableBuilder/designer.aspx",$createDelegate(function(d){RMC.TableBuilder.template=d;this.init()},this))}else{this.init()}};RMC.TableBuilder.prototype={init:function(){this.$p.html(RMC.TableBuilder.template);var b=this.$p;this.$info_TableName=$("#info_TableName",b);this.$info_TableInfo=$("#info_TableInfo",b);this.$info_Title=$("#info_Title",b);this.$info_Description=$("#info_Description",b);this.$panel_Database=$("#panel_Database tbody",b);this.$panel_Related=$("#panel_Related tbody",b);this.$panel_UserDefined=$("#panel_UserDefined tbody",b);this.$count_Database=$("#count_Database",b);this.$count_Related=$("#count_Related",b);this.$count_UserDefined=$("#count_UserDefined",b);var a=$createDelegate(this.field_onclick,this);this.$panel_Database.click(a);this.$panel_UserDefined.click(a);this.$panel_Related.click(a);this.tabBar=new RMC.TB_TabBar($("div.fm-dlg-tabbar",b));$("div.fm-dlg-footer",b).addHandler("click",this.btn_click,this);var c=$createDelegate(this.add_click,this);$("a#btnAdd_Database",b).click(c);$("a#btnAdd_Related",b).click(c);$("a#btnAdd_UserDefined",b).click(c);this.Reload()},Reload:function(){var a='{"tableName":"'+this.tableName+'"}';ExecuteService(a,RMC.Path+"TableBuilder/SupportService.asmx/LoadXml",$.proxy(this.onLoadState,this))},onLoadState:function(k){var r=k.d;if(r.Error!=null){AX.Window.alert("Initialization",r.Error);return}this.xmlParser=xml_createParser();this.xmlDoc=xml_loadXML(this.xmlParser,r.Data);this.$xnsettings=$(":first",this.xmlDoc);this.$xnfields=this.$xnsettings.find("fields");var m=this.$xnfields.children();var g=$("datasource",this.$xnsettings);this.$info_TableName.text(g.attr("name"));if(g.attr("sqlview")){this.$info_TableInfo.text("/Grid Sql View: "+g.attr("sqlview"))}else{if(g.attr("sqlquery")){this.$info_TableInfo.text("/Grid Sql Query: [INLINE_SQL_QUERY]")}}this.$info_Title.val($("header",this.$xnsettings).attr("title"));this.$info_Description.val($("description",this.$xnsettings).attr("title"));var j=$("primarykey",this.$xnsettings).text();var p="";var n="";var e="";var f=0;var h=0;var c=0;var a;var l;for(var o=0;o<m.length;o++){l=m[o];var s=l.getAttribute("name");var d=l.getAttribute("type");var q=l.getAttribute("dbtype");a=this.buildFieldRowHtml(l,s,(j==s));if(q!=""){p+=a;f+=1}else{if(d=="EditableGrid"||d=="Checkboxlist"){n+=a;h+=1}else{if(d=="Lookup"){var b=$(l).find("relation");if(b.length==1){n+=a;h+=1}else{e+=a;c+=1}}else{e+=a;c+=1}}}}this.$panel_Database.html(p);this.$count_Database.text(f);this.$panel_Related.html(n);this.$count_Related.text(h);this.$panel_UserDefined.html(e);this.$count_UserDefined.text(c);this.db_new_fields=[];this.db_update_fields=[];if(f==0&&c>0){this.tabBar.select(2)}},buildFieldRowHtml:function(c,b,h){var i=c.getAttribute("title");var d=c.getAttribute("description");var f=c.getAttribute("type");var k=c.getAttribute("dbtype");var j=c.getAttribute("format");var e=c.getAttribute("required");var g=(e=="true")?"*":"";if(k!=""){f=f+" ("+k+")"}var a=b;if(h){a=b+" (Primary Key)"}return"<tr n='"+b+"'"+(h?" style='font-weight:bold;'":"")+"><td class='r'>"+g+"</td><td class='n'>"+a+"</td><td>"+f+"</td><td>"+j+"</td><td>"+d+"</td></tr>"},field_onclick:function(c){var d=c.target;if(d.tagName=="TD"){d=d.parentNode}if(d.tagName!="TR"){return}this._clickedRow=d;var a=d.getAttribute("n");var b=this.$xnfields.find("field[name='"+a+"']:first");if(b.length==0){return}this._clickedXmlNode=b[0];this.showFieldProperties(this._clickedXmlNode)},showFieldProperties:function(c){var b=this;var a=$createDelegate(this.OnFieldChanged,this);RMC_OpenOrCreate("RMC.FieldPropertiesDialog","Field Properties",480,420,RMC.Path+"TableBuilder/Dialogs/properties.ascx",[RMC.Path+"Dialogs/dialogs_utils.js",RMC.Path+"TableBuilder/Dialogs/properties.js"],function(d){d.component=new RMC.FieldPropertiesDialog(d)},function(d){d.component.LoadState(c,b,a,false)},null)},OnFieldChanged:function(d,f,c){var a=d.getAttribute("name");if(f){if(c){this.db_new_fields.push(a)}this.$xnfields.append(d);var h=d.getAttribute("type");var l=d.getAttribute("dbtype");var e=null;var b=0;if(l!=""){e=this.$panel_Database}else{var j=$(d).find("relation");if(h=="EditableGrid"||h=="Checkboxlist"||j.length==1){e=this.$panel_Related;b=1}else{e=this.$panel_UserDefined;b=2}}var i=this.buildFieldRowHtml(d,a,false);var g=$(i);g.css("font-weight","bold").css("font-style","italic");e.append(g);var n=e.parent().parent();this.tabBar.select(b);n.animate({scrollTop:n.prop("scrollHeight")},500)}else{if(c){this.db_update_fields.push(a)}var m=this._clickedRow;if(!m||!d){return}var k=d.getAttribute("format");$(this._clickedRow.cells[3]).text(k)}},Save:function(c){$("header",this.$xnsettings).attr("title",this.$info_Title.val().trim());$("description",this.$xnsettings).attr("title",this.$info_Description.val().trim());this.closeOnSave=c;var a=xml_convertToString(this.xmlDoc);var b='{"tableName":"'+this.tableName+'","db_new_fields":"'+this.db_new_fields.join(",")+'","db_update_fields":"'+this.db_update_fields.join(",")+'","xmlData":"'+jsonEncode(a)+'"}';ExecuteService(b,RMC.Path+"TableBuilder/SupportService.asmx/SaveXml",$createDelegate(this.onSaveState,this))},onSaveState:function(a){var b=a.d;if(b.Error!=null){AX.Window.alert("Operation Cancelled",b.Error);return}if(this._window){this._window.returnValue=true}if(this.closeOnSave){window.setTimeout($createDelegate(this.Close,this),50)}else{this.$p.find("#lblInfo").text("Configuration has been saved.").show().css({opacity:1}).animate({opacity:0},2000);if(this.db_new_fields.length>0||this.db_update_fields.length>0){AX.Window.alert("Database Registration","The database modification has been done successfuly.")}this.db_new_fields=[];this.db_update_fields=[]}},Close:function(a){if(this._window){this._window.close()}else{window.close()}},Syncronize:function(){var a=AX.Window.createFrameWindow(RMC.Path+"TableBuilder/DbSync.aspx?t="+this.tableName,"Database Syncronization",800,500);a.onclose=$createDelegate(function(b){if(b){this.Reload()}},this)},add_click:function(d){var c=RMC.TableBuilder.addFieldDialog;var b=this;var a=$createDelegate(this.showFieldProperties,this);var f=(d.target.getAttribute("id")=="btnAdd_UserDefined")?"DUMMY":"DB";if(!c){c=AX.Window.createPopupWindow("Add New Field",570,580,false,false);c.loadASCX(RMC.Path+"TableBuilder/Dialogs/add_field.ascx",[RMC.Path+"TableBuilder/Dialogs/add_field.js"],function(){c.component=new RMC.AddFieldDialog(c);c.component.loadState(b,f,a)});RMC.TableBuilder.addFieldDialog=c}else{c.component.loadState(b,f,a)}},wf_events:function(c){var a=this.tableName;var b=AX.Window.createPopupWindow("Table WF Events",560,400,false,false);b.loadASCX(RMC.Path+"TableBuilder/Dialogs/wf_events_list.ascx",[RMC.Path+"TableBuilder/Dialogs/wf_events_list.js"],function(){b.component=new RMC.WFEventsDialog(b);b.component.loadState(a)})},open_more:function(c){var a=this;var b=AX.Window.createPopupWindow("More Settings",460,300,false,false);b.loadASCX(RMC.Path+"TableBuilder/Dialogs/more_properties.ascx",[RMC.Path+"TableBuilder/Dialogs/more_properties.js"],function(){b.component=new RMC.TableMorePropertiesDialog(b);b.component.LoadState(a)})},btn_click:function(a){switch(_fm_getCommand(a)){case"sync":AX.Window.confirm("Database Syncronization","Please, be sure you've saved the changes<br/>before start syncronization process.<br/><br/>Continue ?",function(){this.Syncronize()},this);break;case"wf_events":this.wf_events(a);break;case"audit":this.open_more(a);break;case"save":this.Save(false);break;case"saveX":this.Save(true);break;case"X":this.Close();break}}};RMC.TB_TabBar=function(a){this.$tabBar=a;this._tabs=a.next().children();this.tabs_click=function(c){c.preventDefault();var d=c.target;if(d.tagName=="LABEL"){d=d.parentNode}if(d.tagName=="SPAN"){var b=$(d);this.$tabBar.children().each(function(){$(this).removeClass("tabOn")});b.addClass("tabOn");this._tabs.each(function(){this.style.display="none"});this._tabs[b.index()].style.display="block"}},this.select=function(b){$(this.$tabBar.children()[b]).mousedown()};this.$tabBar.addHandler("mousedown",this.tabs_click,this)};