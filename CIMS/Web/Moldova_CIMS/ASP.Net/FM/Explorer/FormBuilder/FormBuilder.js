// RecordsManagement Admin Client Script Library
// Alfa-XP,	Michael	Isipciuc,	2012.
//
RMC.FormBuilder=function(c,b,a){this.$p=c;this.data=b;this.tableName=this.data.t;this.formName=this.data.f;this._window=a;if(!RMC.FormBuilder.template){$.get(RMC.Path+"FormBuilder/designer.aspx",$createDelegate(function(d){RMC.FormBuilder.template=d;this.init()},this))}else{this.init()}};RMC.FormBuilder.prototype={init:function(){this.$p.html(RMC.FormBuilder.template);this.$canvas=this.$p.children(":first");this.$tabBar=$("div#tabBar",this.$p);this.$tabPanel=$("div#tabPanel",this.$p);this.tabBar=new FM.Tabbar(this.$tabBar);this.$toolbarFields=$("div#toolbarFields",this.$p);this.$toolbarHidden=$("div#toolbarHidden",this.$p);this.$footer=this.$p.find("div.fm-dlg-footer");this.$footer.addHandler("click",this.onbuttonclick,this);var c='{"tableName":"'+this.tableName+'","formName":"'+this.formName+'"}';ExecuteService(c,RMC.Path+"FormBuilder/SupportService.asmx/LoadXml",$.proxy(this.onLoadState,this),_fm_onHandlerError);if(this._window){this._window.setHeader(this.tableName+" / "+this.formName+" - Form Builder.")}var a=this.tableName;this.$dragElement=$("div#dragElement",this.$p);var b=this.$dragElement.children();this.$dragElement_text=$(b[0]);this.$dragElement_comment=$(b[1]);this._drag_ismoving=this._drag_wait=false;this.$canvas.addHandlers({mousedown:this.onmousedown,keydown:this.drag_onkeypress,mousemove:this.drag_onmousemove,mouseup:this.onmouseup,mouseover:this.onmouseover,mouseout:this.onmouseout},this);this.$p.contextmenu(function(d){d.preventDefault();return false});this.$toolbarFields.preventSelection();$("#linkSettings",this.$p).addHandler("click",this.openTableSettings,this);this.$linkEvent=this.$p.find("#linkEvent",this.$p);this.$linkEvent.addHandler("click",this.openFormProperties,this);this.$linkTriggers=this.$p.find("#linkTriggers",this.$p);this.$linkTriggers.addHandler("click",this.openFormProperties,this);this._drag_prepare_timeout=$createDelegate(this.drag_prepare_timeout,this)},onLoadState:function(a){var d=a.d;if(d.Error!=null){AX.Window.alert("Initialization",d.Error);return}this.registerSettingsXml(d.Data,false);this.xmlParser=xml_createParser();this.xmlDoc=xml_loadXML(this.xmlParser,d.Value);this.$xnform=$(":first",this.xmlDoc);this.$xntabs=this.$xnform.children("tabs:first");var c=this.$xntabs.children();for(var b=0;b<c.length;b++){this.ui_appendTab($(c[b]),b,b==0)}this.$tab_new=$('<span class="tab tab_new" title="Add new tab">&nbsp;</span>');this.$tabBar.append(this.$tab_new);this.$tab_new.mousedown($createDelegate(this.new_tab_click,this));this.$linkEvent.toggle(this.$xnform.children("handlers").length>0);this.$linkTriggers.toggle(this.$xnform.children("triggers").length>0);this.$xnhidden=this.$xnform.children("hidden:first");this.redrawHiddenFields();this.redrawAvailableFields()},registerSettingsXml:function(e,j){this.xdSettings=xml_loadXML(xml_createParser(),e);this.$xnfields=$("fields",this.xdSettings);var b=this.fields;var l=this.$xnfields.children();var g=[];var m=[];for(var c=0;c<l.length;c++){var d=l[c];var a=d.getAttribute("name");var k="#"+a.toLowerCase();var h={xmlNode:d,name:a,title:d.getAttribute("title"),type:d.getAttribute("type")};if(j&&b[a]){h.used=b[a].used}g[k]=h;m.push(k)}this.fields=g;this.field_names=m},ui_appendTab:function(f,a,c){var g=$('<span class="tab" i="'+a+'">'+f.attr("title")+"</span>");this.$tabBar.append(g);var e=$('<div class="tab"></div>');this.$tabPanel.append(e);var h=f.find(":first").children();for(var b=0;b<h.length;b++){this.ui_appendSection(e,$(h[b]))}e[0].$xmlNode=f;var d=$('<div class="rmc-fb-section-new">Click here to add new section</div>');d.addHandler("click",this.new_section_click,this);e.append(d);if(c){g.addClass("tabOn");e.show()}return g},ui_appendSection:function(d,c){var b=$('<div class="rmc-fb-section" n="'+c.attr("name")+'"></div>');var a=$('<div class="rmc-fb-sec-header"></div>');var e=$('<div class="rmc-fb-sec-body"></div>');b.append(a);b.append(e);d.append(b);this.redrawSectionHeader(c,a,true);this.redrawSectionBody(c,e);e[0].$xmlNode=c;return b},redrawSectionHeader:function(f,d){var e=(f.attr("showlabel")!="false");var c=f.attr("decoration");d.css("color",!e?"#cccccc":"");d.css("border",(!e||c!="line")?"0":"");var b=(f.attr("visible")=="false")?" (hidden)":"";var a='<span class="rmc-fb-sec-up"></span><span class="rmc-fb-sec-dn"></span>';d.html('<span class="rmc-fb-sec-lbl">'+f.attr("title")+b+'</span><span class="rmc-fb-sec-toolbar"></span>'+a)},redrawSectionBody:function(C,n){var u="";var q=this.getXmlRows(C);u+='<table class="rmc-fb-table" cellpadding="0" cellspacing="3">';var j=2;u+="<colgroup>";u+="<col /><col />";if(C.attr("columns")==3){u+="<col />";j=3}u+=("</colgroup>");this.rowSpanCell=0;for(var r=0;r<q.length;r++){var m=$(q[r]);var t,b,I,H,e,F,c,k;var x,D,a,G,l,B,p,g;u+="<tr>";var d=m.children();var f=d.length;for(var o=0;o<f;o++){t=d[o];I=t.getAttribute("name");if(I){g=false;l=B=false;var h=null;var v=false;var w=t.childNodes;if(w.length){for(var A=0;A<w.length;A++){a=w[A];if(a.tagName=="content"){g=true}else{if(a.tagName=="properties"){h=a.getAttribute("requiredlevel");if(a.getAttribute("oncreatevalue")||a.getAttribute("onupdatevalue")){B=true}}if(a.tagName=="event"){l=true}}}}if(!g){b=this.getField(I);if(b){b.used=true;e=b.type;if(b.xmlNode.getAttribute("required")=="true"){v=true}}else{e="";p=false;g=""}}H=t.getAttribute("title");c=parseInt(t.getAttribute("colspan"))||1;F=parseInt(t.getAttribute("rowspan"))||1;k=null;if(v||h=="required"){k="color:#990000;"}else{if(h=="recommended"){k="color:#000099;"}}u+="<td";if(c>1){u+=" colspan='"+c+"'"}if(F>1){u+=" rowspan='"+F+"'"}u+=">";u+="<div class='f' n='"+I+"' r='"+r+"' c='"+o+"'>";if(g){var y=$(a).text();var E="Html Element";if(y.indexOf("<control")==0){E=y.substr(1,y.indexOf(">")-1)}var z=(F>1)?("height:"+(19*F+8*(F-1))+"px"):"";if(e==""){u+="<span class='box' style='background-color:#882b2b;color:#f9ecec;"+z+"'>[The cell with the name '"+I+"' contains an unknown field].</span></div>"}else{u+="<span class='box' style='background-color:#fefb8c;"+z+"'>["+E+"]</span></div>"}}else{u+="<b"+(k?(" style='"+k+"'"):"")+">"+H+"</b>";u+="<span class='box'";if(F>1){u+=" style='height:"+(19*F+8*(F-1))+"px'"}u+=">"+I+" ("+e+")</span>";if(B){u+="<span class='dta'/>"}if(l){u+="<span class='evt'/>"}}u+="</div>";u+="</td>"}else{u+="<td>";u+="<div class='f-empty' r='"+r+"' c='"+o+"'></div>";u+="</td>"}}u+="</tr>";if(this.rowSpanCell>0){this.rowSpanCell-=1}}u+="</table>";n.html(u)},toolbar_createFieldHtml:function(a){var b=0;switch(a.type){case"Text":b=16;break;case"Picklist":b=32;break;case"Integer":case"Float":case"Money":b=48;break;case"Lookup":b=64;break;case"EditableGrid":b=80;break;case"DateTime":b=96;break;case"Boolean":b=112;break}return"<div class='tf' n='"+a.name+"'><span class='tf-ico' style='background-position:-"+b+"px'>&nbsp;</span><span>"+a.name+"</span></div>"},toolbar_hiddenFieldHtml:function(a){return"<div class='tf' n='"+a.name+"'><span></span><span>"+a.name+"</span></div>"},onmousedown:function(b){if(this._drag_ismoving){this.onmouseup(b);return}if(this.isQuickEdit){return}if(b.button!=0){this.onrightmouse(b);return}var c=b.target;var d=c.className;var a=c.tagName;if(a=="B"||a=="SPAN"){if(d=="tab tabOn"){this.editTab(c);return}else{if(d=="rmc-fb-sec-lbl"){this.editSection(c);return}}c=c.parentNode;d=c.className;a=c.tagName}if(a=="DIV"&&(d=="f over"||d=="f-empty over"||d=="tf tf-over")){this.drag_wait(c);this._clickedField=c}},drag_wait:function(a){this._drag_ismoving=false;this._dragTo=null;this._dragField=a;this.drag_stop_wait();this._drag_event=null;this._drag_wait=true;this._drag_timer=window.setTimeout(this._drag_prepare_timeout,200)},drag_prepare_timeout:function(){if(!this._drag_wait){return}this._drag_wait=false;this._drag_timer=null;this._drag_ispreparing=true;if(this._drag_event){this.drag_onmousemove(this._drag_event);this._drag_event=null}},drag_stop_wait:function(){if(this._drag_wait){window.clearTimeout(this._drag_timer);this._drag_timer=null;this._drag_wait=false}},onmouseup:function(a){this.drag_stop_wait();var b=a.target;if(this._drag_ismoving){this._drag_ismoving=false;this.$dragElement.css("display","none");this.$dragField.css("opacity",1);this.$dragField=null;if(this._dragTo&&this._dragTo!=this._dragField){this.drag_complete()}this._dragField=null;this._dragTo=null}else{if(this._clickedField){if(b.tagName=="B"||b.tagName=="SPAN"){b=b.parentNode}if(b.tagName=="DIV"&&this._clickedField==b){if(b.className=="f over"){this.showCellProperties(b,a.target.className)}else{if(b.className=="tf tf-over"&&b.parentNode.getAttribute("id")=="toolbarHidden"){this.showHiddenProperties(b)}}}this._clickedField=null}else{if(b.tagName=="SPAN"&&(b.className=="rmc-fb-sec-up"||b.className=="rmc-fb-sec-dn")){this.moveSection(b)}}}this._drag_ispreparing=false},drag_onmousemove:function(b){if(this._drag_ispreparing){this._drag_ispreparing=false;this.drag_start(b);this._drag_ismoving=true}if(this._drag_ismoving){var a=b.pageX;var c=b.pageY;this.$dragElement.css({left:(a-150),top:(c+10)})}else{if(this._drag_wait){this._drag_event=b}}},drag_start:function(b){this.$canvas.focus();this.$dragField=$(this._dragField);this.$dragField.css("opacity",0.3);var a;if(this.$dragField[0].className=="tf tf-over"){a=$(this.$dragField.children()[1]).text()}else{a=this.$dragField.children(":first").text()}if(a.indexOf("[")==0){a="[Html Element]"}this.$dragElement_text.text(a);this.$dragElement_comment.text("");this.$dragElement.css("display","")},drag_complete:function(w,l,n){var B=this._dragTo;if(B.className=="f over"){B.className="f"}else{if(B.className=="f-empty over"){B.className="f-empty"}}var F=(w=="REPLACE");var H=(this._dragField.className=="tf tf-over"||this._dragField.className=="tf");var m=(B.getAttribute("id")=="toolbarHidden");var e=(B.getAttribute("id")=="toolbarFields");var t,i,j,D,z,I,r;if(H){this._dragField.className="tf";var b=this._dragField.parentNode;b.className="rmc-toolbar-body";if(m||e){B.className="rmc-toolbar-body"}var p=(b.getAttribute("id")=="toolbarHidden");if(m&&p||e&&!p){return}var k=this._dragField.getAttribute("n");var u=(k=="[HTML]");var c=(!u)?this.getField(k):new Object();if(p){j=this.$xnhidden.children("cell[name='"+k+"']");j.remove();c.used=false;this.redrawHiddenFields()}else{j=xml_createNode(this.xmlDoc,"cell");if(u){if(m){return}j.attr("name","control_"+xml_random(1000));xml_appendNode(this.xmlDoc,j,"content")}else{j.attr("title",c.title||k);j.attr("name",k)}c.used=true;this.redrawAvailableFields();if(m){this.$xnhidden.append(j);this.redrawHiddenFields()}}if(m||e){return}c.used=true;r=true;t=null;D=z=1}else{t=this._dragField.parentNode.parentNode.parentNode.parentNode.parentNode;i=t.$xmlNode;j=this.getXmlCell(i,this._dragField);I=parseInt(i.attr("columns"));D=parseInt(j.attr("colspan")||1);z=parseInt(j.attr("rowspan")||1);r=D*z==1;if(!r){this.cutAndRestoreXmlCell(j,D,z);j.removeAttr("colspan").removeAttr("rowspan")}else{this.cutXmlCell(j)}if(e||m){B.className="rmc-toolbar-body";this.hideOrDelete(j,m);this.removeEmptyRows(i,I);this.redrawSectionBody(i,$(t));return}}var s=this._dragTo.parentNode.parentNode.parentNode.parentNode.parentNode;var h=s.$xmlNode;var g=this.getXmlCell(h,this._dragTo);var G=parseInt(h.attr("columns"));var x=parseInt(g.attr("rowspan")||1);var E=g.index();var a=!(g.attr("name"));var f=(t==null||s==t);if(!a&&!F){var C=this.getXmlBottomRow(g,x);var A=C.next();var y=(!$isNull(A))?this.getRowSize(A):G;var d=G-y;if(d!=0){this.findAndCompensateRow(A,G)}var q=this.appendEmptyRow(C,y,false);var v=(E>y-1)?y-1:E;g=$(q.children()[v])}this.replaceXmlCell(g,j);if(F){this.expandField(j,l,n,I)}else{if(!r){this.expandField(j,D,z,G)}}this.removeEmptyRows(h,G);if(!f){this.removeEmptyRows(i,I)}this.redrawSectionBody(h,$(s));if(!f){this.redrawSectionBody(i,$(t))}},findAndCompensateRow:function(d,e){var c=20;while(!$isNull(d)&&c-->0){var b=d.next();var a=(!$isNull(b))?this.getRowSize(b):e;if(a<e){d=b}else{d.append(xml_createNode(this.xmlDoc,"cell"));break}}},expandField:function(e,d,g,h){var p=e.parent();var l=e.index();var f=this.getLayoutIndex(l,h,p);var a=d;var n=g;if(f+d>h){d=h-f}if(g>1){var m=p.index();var o=p.parent().children();p=this.expandHorizontally(e,p,l,d,h,true);var k=1;for(var j=1;j<g;j++){var c=p.next();if($isNull(c)){p=this.appendEmptyRow(p,h-d,false)}else{if(!this.prepareEmptyCells(c,d)){var b=this.getRowSize(c);if(b!=h){g=j;break}else{p=this.appendEmptyRow(p,h-d,false)}}else{p=c}}}}else{this.expandHorizontally(e,p,l,d,h,false)}xml_updateAttr(e,"colspan",d>1?d:"");xml_updateAttr(e,"rowspan",g>1?g:"");if(a!=d||g!=n){AX.Window.alert("Notification","Can't expand field to required size.\nThe field has been collapsed to "+d+" columns(s) and "+g+" row(s).")}},appendEmptyRow:function(b,c,e){var d=xml_createNode(this.xmlDoc,"row");for(var a=0;a<c;a++){d.append(xml_createNode(this.xmlDoc,"cell"))}if(e){d.insertBefore(b)}else{d.insertAfter(b)}return d},getXmlBottomRow:function(c,d){var b=c.parent();for(var a=1;a<d;a++){b=b.next()}return b},removeEmptyRows:function(a,e){var h=$(a.children()[0]).children();for(var d=h.length-1;d>0;d--){var g=$(h[d]);var b=g.children();if(b.length==e){var f=false;for(var c=0;c<b.length;c++){if(b[c].getAttribute("name")){f=true}}if(!f){g.remove()}}}},getXmlRows:function(a){return a.find(":first").children("row")},getXmlCell:function(e,f){var d=this.getXmlRows(e);var b=parseInt(f.getAttribute("r"));var g=parseInt(f.getAttribute("c"));var a=$(d[b]);return $(a.children()[g])},getLayoutIndex:function(b,e,d){var c=this.getRowSize(d);var a=e-c;return b+a},getRowSize:function(d){var a=d.children();var c=0;for(var b=0;b<a.length;b++){var e=a[b].getAttribute("colspan");c+=parseInt(e||1)}return c},prepareEmptyCells:function(c,e){var a=c.children();var d=[];for(var b=0;b<a.length;b++){if(!a[b].getAttribute("name")){d.push(a[b])}}if(d.length<e){return false}for(var b=0;b<e;b++){$(d[b]).remove()}return true},expandHorizontally:function(e,o,i,c,f,b){var k=o.children();var n=k.length;var j=i+1;var g=i+c-1;var h=false;for(var m=j;m<=g&&m<n;m++){if(k[m].getAttribute("name")){h=true}}if(h){var d=xml_createNode(this.xmlDoc,"cell");d.insertAfter(e);var l=(!b);o=this.appendEmptyRow(o,f-c+1,l);var a=$(o.children()[i]);e.insertAfter(a);a.remove()}else{for(var m=j;m<=g;m++){$(k[m]).remove()}}return o},cutXmlCell:function(b){var a=xml_createNode(this.xmlDoc,"cell");this.replaceXmlCell(b,a)},replaceXmlCell:function(a,b){b.insertAfter(a);a.remove()},cutAndRestoreXmlCell:function(b,a,c){var k=b.parent();var f=b.index();var g=k.index();b.remove();var e=c*a;var j=k.parent().children();for(var h=g;h<g+c;h++){k=$(j[h]);var d=k.children(":first");for(var i=f;i<f+a;i++){this.appendCell(d,f,k)}}},appendCell:function(d,c,b){var a=xml_createNode(this.xmlDoc,"cell");if(!$isNull(d)){if(c==0){a.insertBefore(d)}else{a.insertAfter(d)}}else{b.append(a)}},hideOrDelete:function(a,b){if(a.children("content").length>0){return}if(b){this.$xnhidden.append(a);this.redrawHiddenFields()}else{this.getField(a.attr("name")).used=false;this.redrawAvailableFields()}},drag_onkeypress:function(a){if(a.keyCode==27){this._dragTo=null;this.onmouseup(a)}},onmouseover:function(b){var c=b.target;if(c.tagName=="B"||c.tagName=="SPAN"){c=c.parentNode}if(c.tagName=="DIV"){var d=c.className;if(this._drag_ismoving||this._drag_wait){if(d=="f"||d=="f-empty"){c.className=d+" over";this._dragTo=c;var a=(d=="f")?"drop AFTER":"drop INTO";if(this._dragTo==this._dragField){a="";this._dragTo=null}this.$dragElement_comment.text(a)}else{if(d=="rmc-fb-tabbar fm-dlg-tabbar"&&b.target.className=="tab"){this.tabBar.tabs_click(b)}else{if(d=="rmc-toolbar-body"||d=="tf"||d=="tf tf-over"){if(d=="tf"||d=="tf tf-over"){c=c.parentNode;d=c.className}c.className="rmc-toolbar-body rmc-toolbar-body-over";this._dragTo=c;this.$dragElement_comment.text("REMOVE")}}}}else{if(d=="f"){c.className=d+" over"}else{if(d=="tf"){c.className="tf tf-over"}}}}},onmouseout:function(a){var b=a.target;if(b.tagName=="B"||b.tagName=="SPAN"){b=b.parentNode}if(b.tagName=="DIV"){var c=b.className;if(c=="f over"){b.className="f"}else{if(c=="f-empty over"){b.className="f-empty"}else{if(this._drag_ismoving||this._drag_wait){if(c=="tf"||c=="tf tf-over"){b=b.parentNode;c=b.className}if(c=="rmc-toolbar-body rmc-toolbar-body-over"){b.className="rmc-toolbar-body"}}else{if(c=="tf tf-over"){b.className="tf"}}}}if(this._drag_ismoving||this._drag_wait){this._dragTo=null;this.$dragElement_comment.text("")}}},getField:function(a){return this.fields["#"+a.toLowerCase()]},redrawHiddenFields:function(){var c=this.$xnhidden.children();var b="";for(var a=0;a<c.length;a++){var e=c[a];var g=e.getAttribute("name");if(!g){continue}var d=this.getField(g);if(!d){continue}d.used=true;b+=this.toolbar_hiddenFieldHtml(d)}this.$toolbarHidden.html(b)},redrawAvailableFields:function(){var c='<div class="tf" n="[HTML]"><span>[Html Element]</span></div>';var b=this.field_names.sort();for(var a=0;a<b.length;a++){var d=this.fields[b[a]];if(!d.used){c+=this.toolbar_createFieldHtml(d)}}this.$toolbarFields.html(c)},new_tab_click:function(g){g.stopPropagation();var d=this.$xntabs.children().length;if(d>=10){AX.Window.alert("Message","You've exceed the maximum count for the tabs on the form.");return}var c=""+(d+1);var f=xml_appendNode(this.xmlDoc,this.$xntabs,"tab");if(this.$xntabs.children("tab[name='tab"+c+"']").length>0){c=""+xml_random(100)+c;if(this.$xntabs.children("tab[name='tab"+c+"']").length>0){return}}var b="tab"+c;f.attr("title",b).attr("name",b);this.appendXmlSection(f,("sec"+c+""+xml_random(1000)),"Section 1");var a=this.ui_appendTab(f,d,false);this.$tab_new.insertAfter(a);g.target=a[0];this.tabBar.tabs_click(g)},new_section_click:function(i){var h=$(i.target);var g=$(i.target.parentNode);var f=g[0].$xmlNode;var b=g.index()+1;var a="sec"+b+""+xml_random(1000);var d=this.appendXmlSection(f,a,"Section "+g.children().length);var c=this.ui_appendSection(g,d);c.insertBefore(h);FM.DialogUtils.scrollBottom(g.parent())},appendXmlSection:function(d,a,e){var c=xml_appendNode(this.xmlDoc,xml_getOrCreate(this.xmlDoc,d,"sections"),"section");c.attr("title",e).attr("name",a).attr("decoration","line").attr("columns","2").attr("showlabel","true");var b=xml_appendNode(this.xmlDoc,xml_appendNode(this.xmlDoc,c,"rows"),"row");b.append(xml_createNode(this.xmlDoc,"cell"));b.append(xml_createNode(this.xmlDoc,"cell"));return c},onrightmouse:function(b){if(b.target.tagName=="B"&&b.target.parentNode.className=="f over"){var f=$(b.target).text();var d=b.target.parentNode;d.style.display="none";var c=d.$input;if(!c){var a=$("<div style='padding:2px 2px 0 4px;'><input class='fm' tabIndex='1'/></div>");a.insertAfter(d);c=a.find(":first");c.addHandler("focusout",this.onChangeTitle,this);d.$input=c}this.activeCell=d;c.parent().show();c[0].value=c[0].initialValue=f;c.focus();this.isQuickEdit=true}},onChangeTitle:function(){this.isQuickEdit=false;var f=this.activeCell;var e=f.$input;e.parent().hide();f.style.display="";var d=e[0].initialValue;var b=e.val().trim();if(b!=d){var a=this.activeCell.getAttribute("n");var c=this.$xnform.find("cell[name='"+a+"']");c.attr("title",b);$(f.firstChild).text(b)}},showCellProperties:function(h,g){this.activeCell=h;var b=h.getAttribute("n");var e=this.$xnform.find("cell[name='"+b+"']");var c=this;var f=this.getField(b);if(f){var d=$(f.xmlNode);var a=0;if(g=="evt"){a=2}else{if(g=="dta"){a=1}}RMC_OpenOrCreate("RMC.FB_CellProperties","",470,540,RMC.Path+"FormBuilder/Dialogs/CellProperties.ascx",[RMC.Path+"FormBuilder/Dialogs/CellProperties.js"],function(i){i.component=new RMC.FB_CellProperties(i)},function(i){i.component.LoadState(c,e,d,a)},$createDelegate(this.onCellChanged,this))}else{RMC_OpenOrCreate("RMC.FB_CustomControlProperties","HTML/Control Properties",550,520,RMC.Path+"FormBuilder/Dialogs/HtmlControlProperties.ascx",null,function(i){i.component=new RMC.FB_CustomControlProperties(i)},function(i){i.component.LoadState(c,e)},$createDelegate(this.onCellChanged,this))}},onCellChanged:function(a){if(!a){return}if(a.layoutChanged){this._dragField=this.activeCell;this._dragTo=this.activeCell;this.drag_complete("REPLACE",a.colspan,a.rowspan)}else{if(a.titleChanged){$(this.activeCell.firstChild).text(a.title)}}},moveSection:function(d){var a=$(d.parentNode);var c=a.parent();var b=this.$xnform.find("section[name='"+c.attr("n")+"']");if($isNull(b)){return}if(d.className=="rmc-fb-sec-up"){if(b.prev().length==0){return}b.insertBefore(b.prev());c.insertBefore(c.prev())}else{if(d.className=="rmc-fb-sec-dn"){if(b.next().length==0){return}b.insertAfter(b.next());c.insertAfter(c.next())}}},showHiddenProperties:function(f){var a=f.getAttribute("n");var d=this.$xnhidden.find("cell[name='"+a+"']");var e=this.getField(a);if(!e){return}var c=$(e.xmlNode);var b=this;RMC_OpenOrCreate("RMC.FB_HiddenProperties","",450,300,RMC.Path+"FormBuilder/Dialogs/HiddenProperties.ascx",null,function(g){g.component=new RMC.FB_HiddenProperties(g)},function(g){g.component.LoadState(b,d,c);g.setHeader(a+" - Hidden Cell Properties")},null)},editTab:function(e){var c=e;var a=$(e).index();var d=$(this.$xntabs.children()[a]);var b=this;RMC_OpenOrCreate("RMC.FB_TabProperties","Tab Properties",470,220,RMC.Path+"FormBuilder/Dialogs/TabProperties.ascx",null,function(f){f.component=new RMC.FB_TabProperties(f)},function(f){f.component.LoadState(b,d,c,a)},null)},editSection:function(g){var f=g.parentNode.parentNode;var b=$(g.parentNode);var a=b.next();var c=f.getAttribute("n");var e=this.$xnform.find("section[name='"+c+"']");if($isNull(e)){return}var d=this;RMC_OpenOrCreate("RMC.FB_SectionProperties","Section Properties",450,500,RMC.Path+"FormBuilder/Dialogs/SectionProperties.ascx",null,function(h){h.component=new RMC.FB_SectionProperties(h)},function(h){h.component.LoadState(d,e,f)},$createDelegate(function(h){if(h&&h.redrawHeader){this.redrawSectionHeader(e,b)}if(h&&h.redrawBody){this.redrawSectionBody(e,a)}},this))},openFormProperties:function(c){var b=this;var a=0;if(c){if(c.target.id=="linkEvent"){a=1}else{if(c.target.id=="linkTriggers"){a=2}}}RMC_OpenOrCreate("RMC.FB_FormProperties","Form Properties",470,520,RMC.Path+"FormBuilder/Dialogs/FormProperties.ascx",null,function(d){d.component=new RMC.FB_FormProperties(d)},function(d){d.component.LoadState(b,a)},null)},openTableSettings:function(){RMC_OpenTableSettings(this.tableName,$createDelegate(function(){var a='{"tableName":"'+this.tableName+'","formName":"'+this.formName+'"}';ExecuteService(a,RMC.Path+"FormBuilder/SupportService.asmx/LoadXml",$createDelegate(this.onReloadFields,this))},this))},onReloadFields:function(a){var b=a.d;if(b.Error!=null){AX.Window.alert("Initialization",b.Error);return}this.registerSettingsXml(b.Data,true);this.redrawAvailableFields()},Save:function(c){this.closeOnSave=c;var a=xml_convertToString(this.xmlDoc);var b='{"tableName":"'+this.tableName+'","formName":"'+this.formName+'","xmlData":"'+jsonEncode(a)+'"}';ExecuteService(b,RMC.Path+"FormBuilder/SupportService.asmx/SaveXml",$.proxy(this.onSaveState,this),_fm_onHandlerError)},onSaveState:function(a){var b=a.d;if(b.Error!=null){AX.Window.alert("Operation Cancelled",b.Error);return}if(this._window){this._window.returnValue=true}if(this.closeOnSave){window.setTimeout($createDelegate(this.Close,this),50)}else{this.$p.find("#lblInfo").text("Configuration has been saved.").show().css({opacity:1}).animate({opacity:0},2000)}},Close:function(a){this._window.close()},onbuttonclick:function(a){switch(_fm_getCommand(a)){case"properties":this.openFormProperties();break;case"save":this.Save(false);break;case"saveX":this.Save(true);break;case"X":this.Close();break}}};