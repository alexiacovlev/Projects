// this object has private instance for each view
// but window dialogs are global.
//
RMC.PreviewBuilder=function(c,b,a){this._mode=b.mode;this.$p=c;this.tableName=b.t;this.viewName=b.v;this._window=a;this._selected=null;if(!RMC.PreviewBuilder.template){$.get(RMC.Path+"PreviewBuilder/designer.aspx",$createDelegate(function(d){RMC.PreviewBuilder.template=d;this.init()},this))}else{this.init()}};RMC.PreviewBuilder.prototype={init:function(){this.$p.html(RMC.PreviewBuilder.template);var b='{"tableName":"'+this.tableName+'","viewName":"'+this.viewName+'","mode":"'+this._mode+'"}';ExecuteService(b,RMC.Path+"PreviewBuilder/SupportService.asmx/LoadXml",$.proxy(this.onLoadState,this),_fm_onHandlerError);var c="";switch(this._mode){case"LOOKUP":c="Lookup View Builder";break;case"EGRID":this.IsEGRID=true;c="Editable Grid Builder";$("#panelFilter").hide();break;default:c="View Builder";break}if(this._window){this._window.setHeader(this.tableName+" / "+this.viewName+" - "+c)}$("#dlgTitle").text(c);var a=this.tableName;$("#btnSettings").click(function(){RMC_OpenTableSettings(a)})},onLoadState:function(j){var f=j.d;if(f.Error!=null){AX.Window.alert("Initialization",f.Error);this.$p.find("div.fm-dlg-footer").hide();return}this.xmlParser=xml_createParser();this.xmlDoc=xml_loadXML(this.xmlParser,f.Value);this.$xnview=$(":first",this.xmlDoc);this.$xnrow=this.$xnview.find("row");this.$xnfetch=this.$xnview.find("fetch");var h=this.$xnrow.children();var g='<table class="rmc-vb-hdr" cellpadding="0" cellspacing="0"></table>';this.$grid=$(g);this.$gridRow=$("<tr></tr>");this.$grid.append(this.$gridRow);this.$autoCell=null;this.$resizeCell=$('<td class="resize-cell"><img src=\''+RMC.Path+"PreviewBuilder/Images/resize-cell.png' /></td>");for(var c=0;c<h.length;c++){var d=h[c];var b=d.getAttribute("width");var a=this.appendColumnUI(d,b,null);if(b==null){this.$autoCell=a;this.$gridRow.append(this.$resizeCell)}}this.$p.find("div.rmc-vb-grid").append(this.$grid).append("<label class='rmc-vb-label'>View results are displayed here.</label>");this.$grid.addHandlers({click:this.onclick,contextmenu:this.contextmenu},this);this.$menu=this.$p.find("div.fm-dlg-toolbar");this.$menu.addHandler("click",this.onmenuclick,this);this.$footer=this.$p.find("div.fm-dlg-footer");this.$footer.addHandler("click",this.onbuttonclick,this);this.xdSettings=xml_loadXML(xml_createParser(),f.Data);this.redrawFilterInfo();this.redrawSortInfo();if(this.IsEGRID){var e=this.$menu[0].firstChild.childNodes;if(e[10].getAttribute("cmd")=="FILTER"){$(e[10]).hide()}}},redrawFilterInfo:function(){var b=$("filter condition",this.$xnfetch);var c="";for(var a=0;a<b.length;a++){if(a>0){c+=", "}c+=b[a].getAttribute("attribute")}if(c==""){$("span#FilterInfo",this.$p).html("<i>not defined</i>")}else{$("span#FilterInfo",this.$p).text(c)}},redrawSortInfo:function(){var b=$("sort column",this.$xnfetch);var c="";for(var a=0;a<b.length;a++){if(a>0){c+=", "}c+=b[a].getAttribute("name")+" ";c+=(b[a].getAttribute("ascending")=="true")?"(ascending)":"(descending)"}$("span#SortInfo",this.$p).text(c)},appendColumnUI:function(b,a,e){var d="<td cell='"+b.getAttribute("name")+"'";if(a==null){d+=' style="width:120px"'}else{d+=' style="width:'+a+'px"'}d+=">"+b.getAttribute("title")+"</td>";var c=$(d);c[0].xmlNode=b;if(e){if(e==this.$autoCell[0]){e=e.nextSibling}c.insertAfter($(e))}else{this.$gridRow.append(c)}return c},onclick:function(b){var c=b.target;if(c==this._selected){this.handleCommand("COLUMN_PROPERTIES");return}var a=c.getAttribute("cell");if(!a){if(c.className=="resize-cell"){c=c.previousSibling}else{return}}if(this._selected){this._selected.className=""}c.className="selected";this._selected=c;this.updateToolbar()},updateToolbar:function(){var b=(this._selected==null);var a=$("div a",this.$menu);$(a[0]).attr("disabled",b);$(a[1]).attr("disabled",b);$(a[2]).attr("disabled",b);$(a[4]).attr("disabled",b)},contextmenu:function(g){g.preventDefault();var h=g.target;var b=h.getAttribute("cell");if(!b){return}var d=$(h);var f=h.xmlNode;var c=d.text();var a=$("<input class='fm'/>").val(c);a.addHandler("blur",function(){var e=a.val().trim();a.parent().html(e);if(e!=c){f.setAttribute("title",e)}},this);d.html(a);a.focus()},getSelected:function(){if(this._selected){return this._selected}AX.Window.alert("Please, select grid column.");return null},onmenuclick:function(b){var a=_fm_getCommand(b);this.handleCommand(a)},moveCell:function(h,b){if(!h){return}var d=$(h);var f;var g=h.xmlNode;var a=(g.getAttribute("width")==null);if(b=="left"){f=d.prev();if($isNull(f)){return}if(f[0].className=="resize-cell"){f=f.prev()}var e=f[0].xmlNode;$(g).insertBefore($(e));d.insertBefore(f);if(a){this.$resizeCell.insertAfter(d)}}else{if(b=="right"){f=d.next();if($isNull(f)){return}if(f[0].className=="resize-cell"){f=f.next()}var c=f[0].xmlNode;$(g).insertAfter($(c));d.insertAfter(f);if(a){this.$resizeCell.insertAfter(d)}}}},showColumnProperties:function(b){if(!b){return}var f=b.xmlNode;var e=this.xmlDoc;$(":first",e).find("row");var a=$(":first",this.xdSettings).find("field[name='"+f.getAttribute("name")+"']");if($isNull(a)){alert("Settings node not found");return}var c=a[0];if(this.IsEGRID){var d=RMC.PreviewBuilder.VB_EGRID_ColumnProperties;if(!d){d=AX.Window.createPopupWindow("Change Column Properties",500,460,false,false);d.loadASCX(RMC.Path+"PreviewBuilder/Dialogs/EGRID_ColumnProperties.ascx",null,function(){d.component=new RMC.VB_EGRID_ColumnProperties(d);d.component.LoadState(e,f,c)});RMC.PreviewBuilder.VB_EGRID_ColumnProperties=d}else{d.component.LoadState(e,f,c)}d.onclose=$createDelegate(this.onColumnPropertiesChanged,this)}else{var d=RMC.PreviewBuilder.VB_ColumnProperties;if(!d){d=AX.Window.createPopupWindow("Change Column Properties",500,400,false,false);d.loadASCX(RMC.Path+"PreviewBuilder/Dialogs/ColumnProperties.ascx",null,function(){d.component=new RMC.VB_ColumnProperties(d);d.component.LoadState(f,c)});RMC.PreviewBuilder.VB_ColumnProperties=d}else{d.component.LoadState(f,c)}d.onclose=$createDelegate(this.onColumnPropertiesChanged,this)}},onColumnPropertiesChanged:function(a){if(!this._selected){return}var e=$(this._selected);var c=this._selected.xmlNode;var d=c.getAttribute("title");e.text(d);if(a=="width"){var b=c.getAttribute("width");if(b==null){this.$autoCell.css("width","100px");this.$autoCell[0].xmlNode.setAttribute("width","100");this.setAutoSize(e,false)}else{e.css("width",b+"px")}}},setAutoSize:function(b,a){if(a){b[0].xmlNode.removeAttribute("width")}b.css("width","120px");this.$autoCell=b;this.$resizeCell.insertAfter(b)},deleteCell:function(a){if(!a){return}if(this.$xnrow.children().length==1){AX.Window.alert("You cannot delete last column, please, add others");return}AX.Window.confirm("Confirmation","Are you sure you want to remove this column <br/>from the view?",function(){var d=a.xmlNode;var c=$(a);var b=(d.getAttribute("width")==null);$(d).remove();$(a).remove();if(b){var e=this.$gridRow.children()[0];if(e.className=="resize-cell"){e=this.$gridRow.children()[1]}this.setAutoSize($(e),true)}this._selected=null;this.updateToolbar()},this)},showAddColumns:function(){var b=RMC.PreviewBuilder.VB_AddColumns;var a=this;if(!b){b=AX.Window.createPopupWindow("Add Columns",550,470,false,false);b.loadASCX(RMC.Path+"PreviewBuilder/Dialogs/AddColumns.ascx",null,function(){b.component=new RMC.VB_AddColumns(b);b.component.ShowList(a)});RMC.PreviewBuilder.VB_AddColumns=b}else{b.component.ShowList(a)}b.onclose=$createDelegate(this.onAddColumnsClosed,this)},onAddColumnsClosed:function(d){if(!d){return}var f=this._selected;for(var b=0;b<d.length;b++){var a=d[b][0];var e=d[b][1];var c=$(this.xmlDoc.createElement("cell"));if(f){c.insertAfter($(f.xmlNode))}else{this.$xnrow.append(c)}c.attr("name",a).attr("title",e).attr("width","100");this.appendColumnUI(c[0],"100",f)}},showSetSort:function(){var b=RMC.PreviewBuilder.VB_SetSort;var a=this;if(!b){b=AX.Window.createPopupWindow("Configure Sort Order",450,300,false,false);b.loadASCX(RMC.Path+"PreviewBuilder/Dialogs/SetSort.ascx",null,function(){b.component=new RMC.VB_SetSort(b);b.component.Show(a)});RMC.PreviewBuilder.VB_SetSort=b}else{b.component.Show(a)}b.onclose=$createDelegate(this.redrawSortInfo,this)},showSetFilter:function(){var b=RMC.PreviewBuilder.VB_SetFilter;var a=this;if(!b){b=AX.Window.createPopupWindow("Configure Filter Criteria",650,340,false,false);b.loadASCX(RMC.Path+"PreviewBuilder/Dialogs/SetFilter.ascx",null,function(){b.component=new RMC.VB_SetFilter(b);b.component.Show(a)});RMC.PreviewBuilder.VB_SetFilter=b}else{b.component.Show(a)}b.onclose=$createDelegate(this.redrawFilterInfo,this)},showViewProperties:function(){if(this.IsEGRID){var b=RMC.PreviewBuilder.VB_EGRID_ViewProperties;var a=this;if(!b){b=AX.Window.createPopupWindow("Editable Grid Properties",530,430,false,false);b.loadASCX(RMC.Path+"PreviewBuilder/Dialogs/EGRID_ViewProperties.ascx",null,function(){b.component=new RMC.VB_EGRID_ViewProperties(b);b.component.LoadState(a)});RMC.PreviewBuilder.VB_EGRID_ViewProperties=b}else{b.component.LoadState(a)}}else{var b=RMC.PreviewBuilder.VB_ViewProperties;var a=this;if(!b){b=AX.Window.createPopupWindow("View Properties",550,460,false,false);b.loadASCX(RMC.Path+"PreviewBuilder/Dialogs/ViewProperties.ascx",null,function(){b.component=new RMC.VB_ViewProperties(b);b.component.LoadState(a)});RMC.PreviewBuilder.VB_ViewProperties=b}else{b.component.LoadState(a)}}b.onclose=$createDelegate(this.onAddColumnsClosed,this)},getSortedFieldsNodes:function(){if(!this._sortedFieldsNodes){this._sortedFieldsNodes=$(":first fields",this.xdSettings).children();this._sortedFieldsNodes.sort(function(e,c){var f=e.getAttribute("title").toLowerCase();var d=c.getAttribute("title").toLowerCase();if(f<d){return -1}else{if(f>d){return 1}else{return 0}}})}return this._sortedFieldsNodes},Save:function(c){this.closeOnSave=c;var a=xml_convertToString(this.xmlDoc);var b='{"tableName":"'+this.tableName+'","viewName":"'+this.viewName+'","mode":"'+this._mode+'","xmlData":"'+jsonEncode(a)+'"}';ExecuteService(b,RMC.Path+"PreviewBuilder/SupportService.asmx/SaveXml",$.proxy(this.onSaveState,this),_fm_onHandlerError)},onSaveState:function(a){var b=a.d;if(b.Error!=null){AX.Window.alert("Operation Cancelled",b.Error);return}this._window.returnValue=true;if(this.closeOnSave){window.setTimeout($createDelegate(this.Close,this),50)}else{this.$p.find("#lblInfo").text("Configuration has been saved.").show().css({opacity:1}).animate({opacity:0},2000)}},Close:function(a){this._window.close()},handleCommand:function(a){switch(a){case"MOVE_LEFT":this.moveCell(this.getSelected(),"left");break;case"MOVE_RIGHT":this.moveCell(this.getSelected(),"right");break;case"VIEW_PROPERTIES":this.showViewProperties();break;case"FILTER":if(this.IsEGRID){alert("Not Applied for Editable Grid")}else{this.showSetFilter()}break;case"SORT":this.showSetSort();break;break;case"GROUP":break;case"ADD":this.showAddColumns();break;case"COLUMN_PROPERTIES":this.showColumnProperties(this.getSelected());break;case"CELL_PROPERTIES":break;case"REMOVE":this.deleteCell(this.getSelected());break;case"ACTIONS":break}},onbuttonclick:function(a){switch(_fm_getCommand(a)){case"save":this.Save(false);break;case"saveX":this.Save(true);break;case"X":this.Close();break}}};