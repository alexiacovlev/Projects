FM.GridMenuBuilder=function(a,b){this._window=a;this.$o=a.$content;this.onsave_callback=b;this.xmlParser=xml_createParser();this.$menu=$("#_menu",this.$o);this.$p=$("#_itemProperties",this.$o);this.itemTitle=$("#itemTitle",this.$p);this.itemTitle.change($.proxy(this.title_onchange,this));this.itemImage=new FM.ImageControl($("#itemImage",this.$p),$("#itemImage_tb",this.$p));this.itemImage.onchange_callback=$createDelegate(this.itemImage_onchange,this);this.itemWindow=new FM.WindowParameters($("#itemWindow",this.$p));this.itemValue=$("#itemValue",this.$p);this.itemCommand=$("#itemCommand",this.$p);this.itemAttributes=$("#itemAttributes",this.$p);this.item_Toolbar=$("#item_Toolbar",this.$p);this.item_Toolbar_Text=$("#item_Toolbar_Text",this.$p);this.item_MoreActions=$("#item_MoreActions",this.$p);this.$menu.click($.proxy(this.onclick,this));$("#_bottomButtons",this.$o).addHandler("click",this.btn_click,this);$("#_toolbar",this.$o).addHandler("click",this.toolbar_click,this)};FM.GridMenuBuilder.prototype={load:function(b){this.$menu.html("");if(b==""){b="<menu></menu>"}this.xmlDoc=xml_loadXML(this.xmlParser,b);this.menuNode=$(":first",this.xmlDoc);this.loadItems();var a=this.$menu.children();if(a.length>0){this.selectItem(a[0])}else{this.$p.css("display","none")}},loadItems:function(){var a=this.menuNode.children();for(var b=0;b<a.length;b++){var c=$(a[b]);if(c.attr("command")){this.$menu.append("<a><img src='/ASP.Net/Images/ico/"+c.attr("image")+"' />"+c.attr("title")+"</a>")}else{this.$menu.append("<a>---</a>")}}},onclick:function(a){var b=a.target;if(b.tagName=="IMG"){b=b.parentNode}if(b.tagName=="A"){this.selectItem(b)}},selectItem:function(f){if(this._item){this._item.className="";this.applyItemChanges()}this._item=f;f.className="sel";var c=$(f);var a=c.index();var d;this.itemNode=d=$(this.menuNode.children()[a]);var b=d.attr("command");if(!b){this.$p.css("display","none");return}this.$p.css("display","");this.itemTitle.val(d.attr("title"));this.itemImage.setValue(d.attr("image"),d.attr("ico")||"");this.itemCommand.val(b);this.itemValue.val(d.attr("value"));this.itemAttributes.val(d.attr("attributes"));var e=d.attr("width")+","+d.attr("height")+","+d.attr("full");this.itemWindow.setValue(e);var g=d.attr("pos");this.item_Toolbar.attr("checked",(g=="out"||g==""));this.item_Toolbar_Text.attr("checked",(d.attr("showoutlabel")=="true"));this.item_MoreActions.attr("checked",(g=="in"||g==""))},title_onchange:function(){if(!this._item){return}var c=this.itemTitle.val().trim();var b=$(this._item);var a=$(b.contents()[1]);a.replaceWith(c)},itemImage_onchange:function(c,b){if(!this._item){return}var d=$(this._item);var a=$(d.children()[0]);a.attr("src",this.itemImage.getSrc())},applyItemChanges:function(){if(!this.itemNode){return}var j=this.itemNode;if(!j.attr("command")){return}var b=this.itemCommand.val();if(b==""){$(this._item).html("---");atr=j[0].attributes;for(var g=0;g<atr.length;g++){j[0].removeAttribute(atr[g].name)}return}var e=this.itemWindow.getValue();var n="";var k="";var l="";if(e!=""){var o=e.split(",");n=o[0];k=o[1];l=(o.length==3&&o[2]=="true")?"true":""}var m="";var d=this.item_Toolbar.attr("checked");var c=this.item_MoreActions.attr("checked");var a=this.item_Toolbar_Text.attr("checked")&&d;if(d&&c){m=""}else{if(d){m="out"}else{if(c){m="in"}}}j.attr("title",this.itemTitle.val().trim());j.attr("image",this.itemImage.getValue());xml_updateAttr(j,"ico",this.itemImage.getLogo());if(b!=null&&b!=""){j.attr("command",b)}j.attr("value",this.itemValue.val());j.attr("attributes",this.itemAttributes.val());j.attr("pos",m);j.attr("width",n!=""?n:"900");j.attr("height",k!=""?k:"550");j.attr("full",l);j.attr("showoutlabel",a?"true":"")},addNode:function(){var a=$("<a><img src='/ASP.Net/Images/ico/star.png'/>New Item</a>");this.$menu.append(a);var b=$(this.xmlDoc.createElement("item"));b.attr("title","New Item").attr("image","star.png").attr("command","EDIT").attr("width","").attr("height","").attr("full","").attr("pos","out").attr("showoutlabel","true");this.menuNode.append(b);this.selectItem(a[0]);FM.DialogUtils.scrollBottom(this.$menu)},deleteNode:function(a){if(!this.itemNode){return}if(a){AX.Window.confirm("Delete Menu Item","Are you sure you want to delete this item?",function(){this.deleteNode(false)},this)}else{this.itemNode.remove();$(this._item).remove();this.itemNode=this._item=null;this.$p.css("display","none")}},moveNode:function(a){if(!this.itemNode){return}var b=$(this._item);if(a=="up"){this.itemNode.insertBefore(this.itemNode.prev());b.insertBefore(b.prev())}else{if(a=="down"){this.itemNode.insertAfter(this.itemNode.next());b.insertAfter(b.next())}}},ReturnXml:function(){if(this._item){this.applyItemChanges()}var a=xml_convertToString(this.xmlDoc);if(a=="<menu></menu>"){a=""}this.onsave_callback(a);this.Close()},Close:function(){this._item=null;this.itemNode=null;this.$p.css("display","none");this._window.close()},toolbar_click:function(a){switch(_fm_getCommand(a)){case"add":this.addNode();break;case"delete":this.deleteNode(true);break;case"up":this.moveNode("up");break;case"down":this.moveNode("down");break}},btn_click:function(a){switch(_fm_getCommand(a)){case"saveX":this.ReturnXml();break;case"X":this.Close();break}}};