// Process Builder Client Script Library
// Alfa-XP, Michael Isipciuc, 2016.
//
FMS={};FMS.Path="/ASP.Net/FM/Explorer/ProcessBuilder/";FMS.DialogsUtilsJS="/ASP.Net/FM/Explorer/Dialogs/dialogs_utils.js";FMS.ProcessDesigner_Load=function(){var a=window.location.hash?window.location.hash.substr(1):"";FMS.designer=new FMS.ProcessDesigner(document.body,a)};FMS.ExecuteService=function(b,d,c,a){ExecuteService(b,"/ASP.Net/FM/Explorer/ProcessBuilder/SupportService.asmx/"+d,c,a||_fm_onHandlerError)};FMS.ProcessDesigner=function(g,c){this.p=g;this.schemaName=c;this.canvasFrame=g.querySelector("#canvasFrame");var a=this.canvasFrame.parentNode.offsetWidth-20;var e=this.canvasFrame.parentNode.offsetHeight-20;var f=this.canvasFrame.contentWindow;var b=this.canvas=f.document.createElement("CANVAS");b.width=a;b.height=e;this.canvasFrame.style.width=a+"px";this.canvasFrame.style.height=e+"px";f.document.body.appendChild(b);if(c){FM.ProgressBar.Show("Loading schema structure");FMS.ExecuteService(JSON.stringify({name:c}),"Load",$createDelegate(this.onloaded,this))}else{var d={Data:"<schema title='' type='1' zoom='100'><settings/><panels><panel title='Panel1' height='500'/></panels><items><item name='Start' type='Start' left='50' top='30'/><item name='End' type='End' left='850' top='400'/></items></schema>"};this.onloaded({d:d})}this.canvasFrame.focus()};FMS.ProcessDesigner.prototype={onloaded:function(a){FM.ProgressBar.Hide();var b=a.d;if(b.Error){AX.Window.alert("Initialization",b.Error);return}this.xmlParser=xml_createParser();this.xmlDoc=xml_loadXML(this.xmlParser,b.Data);this.schema=new FMS.Schema(this,this.canvas,this.canvasFrame,this.xmlDoc);this.init();this.loadSchemaInfo()},init:function(){this.canvas.style.backgroundColor="#f0f8ff";var b=this.p.querySelector("div#toolbar div");this.topmenu=this.p.querySelector("div#topmenu");var a=$createDelegate(this.toolbar_dragStart,this);var c=$createDelegate(this.toolbar_dragEnd,this);b.addEventListener("dragstart",a);b.addEventListener("dragend",function(){window.setTimeout(c,100)});this.canvas.addEventListener("dragover",function(d){d.preventDefault()});this.canvas.addEventListener("dragstart",function(d){d.preventDefault()});this.canvas.addEventListener("dblclick",$createDelegate(this.handleMouseDblClick,this));this.topmenu.addEventListener("click",$createDelegate(this.topmenu_click,this));this.zoomPanel=this.p.querySelector("div#zoomPanel");this.zoomPanel.addEventListener("click",$createDelegate(this.zoom_click,this))},loadSchemaInfo:function(){var e="",g="";if(this.schemaName){g=this.schemaName+" - Business Process Designer";var c=$(this.xmlDoc.documentElement);var f=c.attr("title");var b=c.attr("version");var a=c.attr("modifiedon");if(a){a=a.substr(0,a.indexOf("T"))}var d=c.attr("modifiedby");this.tableName=c.find("settings").attr("table");if(a){e=f+" (v. "+b+"), last revised on "+a+" by "+d}}else{g="[New] - Business Process Designer"}if(window.frameElement&&window.frameElement._window){window.frameElement._window.setHeader(g)}else{window.status=g}this.p.querySelector("div#schemaInfo").innerHTML=e},toolbar_dragStart:function(a){a.dataTransfer.effectAllowed="copy";this.schema.isNewItem=true;this.schema.newItemType=a.target.getAttribute("n")},toolbar_dragEnd:function(a){this.schema.isNewItem=false;this.schema.newItemType=null},defineSwimlane:function(c){var d=0;for(var b=0;b<this.schema.panels.length;b++){var a=this.schema.panels[b];if(c.box.y+30<a.bottomY){return b}}return -1},toggleMenu:function(a,d){var c=$(this.topmenu).children();c[0].style.display=c[1].style.display=c[2].style.display=c[3].style.display=a?"":"none";c[4].style.display=!a?"":"none";this.p.querySelector("div#subTitle").innerHTML=d},topmenu_click:function(a){switch(a.target.getAttribute("cmd")){case"Properties":this.OpenSchemaProperties();break;case"Save":this.SaveSchema(false);break;case"Publish":this.SaveSchema(true);break;case"Back":this.schema.openParentSchema();break;case"Print":this.PrintSchema();break}},zoom_click:function(a){switch(a.target.getAttribute("cmd")){case"in":FMS.zoom(this.schema,+0.05);break;case"out":FMS.zoom(this.schema,-0.05);break;default:FMS.zoom(this.schema,0);break}},handleMouseDblClick:function(e){var designer=this;var schema=this.schema;if(schema.selectedItem){var item=schema.selectedItem;var xd=this.xmlDoc;var type=item.box.type;var dlgName;var lane=0;switch(type){case"RecordState":case"Task":case"MultiTask":case"Data":lane=this.defineSwimlane(item);dlgName="StateProperties";if(type=="Data"){dlgName="DataProperties"}break;case"Start":dlgName="StartProperties";break;case"IfElse":dlgName="IfElseProperties";break;case"Module":case"SendMail":case"StoredProcedure":dlgName="ModuleActivityProperties";break;case"Link":dlgName="LinkProperties";break;default:dlgName="GeneralActivityProperties";break}RMC_OpenOrCreate(dlgName,type+" Properties",530,490,FMS.Path+"Dialogs/"+dlgName+".ascx",[FMS.DialogsUtilsJS,FMS.Path+"Dialogs/fms.dialogs.js"],function(wnd){var dialogType=window.eval("FMS."+dlgName);wnd.component=new dialogType(wnd)},function(wnd){wnd.component.LoadState(xd,item,lane)},function(res){if(res){schema.redraw()}})}else{if(schema.selectedConn){var conn=schema.selectedConn;RMC_OpenOrCreate("FMS.ConnectionProperties","Connection's Properties",400,150,FMS.Path+"Dialogs/ConnectionProperties.ascx",[FMS.DialogsUtilsJS,FMS.Path+"Dialogs/fms.dialogs.js"],function(wnd){wnd.component=new FMS.ConnectionProperties(wnd)},function(wnd){wnd.component.LoadState(designer,conn)},function(res){if(res){schema.redraw()}})}}},OpenSwimlane:function(b,a){var d=this.xmlDoc;var c=this.schema;RMC_OpenOrCreate("FMS.SwimplaneProperties","Swimlane Panels",700,500,FMS.Path+"Dialogs/SwimlaneProperties.ascx",[FMS.DialogsUtilsJS,FMS.Path+"Dialogs/fms.dialogs.js"],function(e){e.component=new FMS.SwimplaneProperties(e)},function(e){e.component.LoadState(d,b,a)},function(e){if(e){c.initPanels();c.redraw()}})},OpenHandlerDesigner:function(c,a,b){if(!this.schemaName){AX.Window.alert("Please, save the process schema to the server first.");return}if(b){c=b.substr(0,b.indexOf(":"));a=b.substr(b.indexOf(":")+1);if(a.indexOf(";")!=-1){a=a.substr(0,a.indexOf(";"))}}if(c=="WORKFLOW"&&a){RMC_OpenWorkflowBuilder(a[0]=="/"?a.substr(1):(this.schemaName+";"+a))}else{if(c=="FORM"){RMC_OpenFormBuilder("","")}else{AX.Window.alert(b)}}},OpenSchemaProperties:function(a,c){var b=this;RMC_OpenOrCreate("FMS.SchemaProperties","Process Schema Properties",520,420,FMS.Path+"Dialogs/SchemaProperties.ascx",[FMS.DialogsUtilsJS,FMS.Path+"Dialogs/fms.dialogs.js"],function(d){d.component=new FMS.SchemaProperties(d)},function(d){d.component.LoadState(b)},function(d){if(d){b.loadSchemaInfo();if(a){b.SaveSchema(c)}}})},SaveSchema:function(b){if(!this.schemaName){this.OpenSchemaProperties(true,b);return}this.schema.saveLayoutXml();var a=xml_convertToString(this.xmlDoc);var c='{"name":"'+this.schemaName+'","publish":"'+b+'","xml":"'+jsonEncode(a)+'"}';var d=(b?"Publishing":"Saving")+" schema structure";FM.ProgressBar.Show(d);FMS.ExecuteService(c,"Save",$createDelegate(function(e){FM.ProgressBar.Hide();var f=e.d;if(f.Error){if(b){AX.Window.alert("Schema is not valid","<div style='padding:15px;line-height:14pt;border:solid 1px #e2e2e2;background-color:#fefee0;padding:5px;'>"+f.Error+"</div>")}else{AX.Window.alert(d,f.Error)}return}else{AX.Window.alert("Schema has been saved"+(b?" and published":""))}},this))},PrintSchema:function(){if(!this.schemaName){AX.Window.alert("Please, save the process schema to the server first.");return}var a="/ASP.Net/FM/DataViewer/Print/FileDownloader.aspx?url=../../Explorer/Diagnostics/Print/Report.aspx?process="+this.schemaName;window.parent.AX.Window.createFrameWindow(a,"Process Schema Report",480,250)}};