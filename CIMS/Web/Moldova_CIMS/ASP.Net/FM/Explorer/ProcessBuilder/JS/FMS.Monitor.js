// Process Builder Client Script Library
// Alfa-XP, Michael Isipciuc, 2016.
//
FMS={};FMS.Path="/ASP.Net/FM/Explorer/ProcessBuilder/";FMS.Monitor_Load=function(c,a,b){FMS.monitor=new FMS.Monitor(document.body,c,a,b)};FMS.MonitorService=function(b,d,c,a){ExecuteService(b,"/ASP.Net/FM/Explorer/ProcessBuilder/MonitorService.asmx/"+d,c,a||_fm_onHandlerError)};FMS.Monitor=function(i,c,f,g){this.p=i;this.schemaName=c;this.instanceId=f;this.stateName=g;this.canvasFrame=i.querySelector("#canvasFrame");var a=this.canvasFrame.parentNode.offsetWidth-20;var d=this.canvasFrame.parentNode.offsetHeight-20;var e=this.canvasFrame.contentWindow;var b=this.canvas=e.document.createElement("CANVAS");b.width=a;b.height=d;this.canvasFrame.style.width=a+"px";this.canvasFrame.style.height=d+"px";e.document.body.appendChild(b);if(!c){return}FM.ProgressBar.Show("Loading schema structure");FMS.MonitorService(JSON.stringify({name:c}),"Load",$createDelegate(this.onloaded,this));this.canvasFrame.focus()};FMS.Monitor.prototype={onloaded:function(a){FM.ProgressBar.Hide();var b=a.d;if(b.Error){AX.Window.alert("Initialization",b.Error);return}this.xmlParser=xml_createParser();this.xmlDoc=xml_loadXML(this.xmlParser,b.Data);this.schema=new FMS.MonitorSchema(this,this.canvas,this.canvasFrame,this.xmlDoc,this.stateName);this.init();this.loadSchemaInfo()},init:function(){this.canvas.style.backgroundColor="#f0f8ff";this.topmenu=this.p.querySelector("div#topmenu");this.topmenu.addEventListener("click",$createDelegate(this.topmenu_click,this));this.zoomPanel=this.p.querySelector("div#zoomPanel");this.zoomPanel.addEventListener("click",$createDelegate(this.zoom_click,this))},setCurrentState:function(a){this.stateName=a},loadSchemaInfo:function(){var a=this.schemaName+" - Business Process Monitor";if(window.frameElement&&window.frameElement._window){window.frameElement._window.setHeader(a)}else{window.status=a}this.p.querySelector("div#schemaInfo").innerHTML=this.stateName},toggleMenu:function(a){var c=$(this.topmenu).children();c[0].style.display=!a?"":"none"},zoom_click:function(a){switch(a.target.getAttribute("cmd")){case"in":FMS.zoom(this.schema,+0.1);break;case"out":FMS.zoom(this.schema,-0.1);break;default:FMS.zoom(this.schema,0);break}},topmenu_click:function(a){switch(a.target.getAttribute("cmd")){case"Back":this.schema.openParentSchema();break}}};FMS.MonitorSchema=function(b,a,e,d,c){this.designer=b;this.canvas=a;this.context=a.getContext("2d");this.frameElement=e;this.xmlDoc=d;this.offsetX=a.offsetLeft;this.offsetY=a.offsetTop;this.canvasWidth=a.width;this.canvasHeight=a.height;this.scale=1;this.scaleText=null;a.addEventListener("mousedown",$createDelegate(this.handleMouseDown,this));window.addEventListener("keydown",$createDelegate(this.handleKeyDown,this));this.frameElement.contentWindow.addEventListener("keydown",$createDelegate(this.handleKeyDown,this));this.loadFromXml($(d.documentElement));this.selected=c;this.redraw()};FMS.MonitorSchema.prototype={loadFromXml:function(d){this.$xnpanels=$("panels:first",d);this.initPanels();this.items=new Array();this.$xnitems=$("items:first",d);var f=this.$xnitems.children();var c=new Array();var g=this.canvasWidth;for(var a=0;a<f.length;a++){var e=f[a];var b=FMS.CreateSchemaBox(e);c[b.name]=a;this.items.push(new FMS.DesignerItem(this,b,a,e));if(b.x>g-50){g=b.x+b.w+50}}if(g>this.canvasWidth){this.resizeCanvas(g,this.canvasHeight)}for(var a=0;a<this.items.length;a++){FMS.CreateSchemaConnections(this.items[a],c)}},initPanels:function(){this.panels=new Array();var d=this.$xnpanels.children();var b=0;for(var a=0;a<d.length;a++){var c=new FMS.SchemaPanel(d[a]);this.panels.push(c);b+=c.height+2}if(b>this.canvasHeight){this.resizeCanvas(this.canvasWidth,b)}},resizeCanvas:function(a,b){this.canvas.width=this.canvasWidth=a;this.canvas.height=this.canvasHeight=b;this.frameElement.style.width=this.canvasWidth+"px";this.frameElement.style.height=this.canvasHeight+"px"},redraw:function(){this.context.clearRect(0,0,this.canvasWidth,this.canvasHeight);FMS.DrawPanels(this);if(this.selected){for(var b=0;b<this.items.length;b++){if(this.items[b].box.name==this.selected){this.drawSelected(this.items[b].box)}}}for(var b=0;b<this.items.length;b++){var d=this.items[b];for(var a=0;a<d.connectionsOut.length;a++){var c=d.connectionsOut[a];c.drawShadow();c.draw(false,false)}}for(var b=0;b<this.items.length;b++){this.items[b].draw()}},drawSelected:function(b){var a=this.context;a.beginPath();a.strokeStyle="#ff2020";a.fillStyle="#fff0f0";a.lineWidth=1;a.roundRect(b.x-14,b.y-14,b.w+28,b.h+28,{upperLeft:6,upperRight:6,lowerRight:6,lowerLeft:6},true,true)},handleMouseDown:function(d){var a=(d.clientX-this.offsetX);var f=(d.clientY-this.offsetY);for(var b=0;b<this.items.length;b++){if(this.items[b].box.type=="SubProcess"){var c=this.items[b].box;if(a>=c.x&&a<=c.x+c.w&&f>=c.y&&f<=c.y+c.h){this.openSubProcess(this.items[b]);this.redraw();return true}}}return false},getState:function(){return{panels:this.panels,items:this.items,$xnpanels:this.$xnpanels,$xnitems:this.$xnitems}},restoreState:function(a){this.panels=a.panels;this.items=a.items;this.$xnpanels=a.$xnpanels;this.$xnitems=a.$xnitems},openSubProcess:function(b){var c=this.getState();c.subprocess=b;if(this.parentState){c.parentState=this.parentState}this.parentState=c;if(b.inner_schema){this.restoreState(b.inner_schema)}else{var a=$("inner_schema:first",b.xn);this.loadFromXml(a)}this.designer.toggleMenu(false);$(this.canvas).hide().fadeIn(300)},openParentSchema:function(){var b=this.parentState;if(!b){return}var a=b.subprocess;a.inner_schema=this.getState();this.parentState=b.parentState;this.restoreState(b);if(!this.parentState){this.designer.toggleMenu(true)}$(this.canvas).hide();this.redraw();$(this.canvas).fadeIn(300)},handleKeyDown:function(a){a.preventDefault();switch(a.keyCode){case 107:FMS.zoom(this,+0.1);break;case 109:FMS.zoom(this,-0.1);break}}};