// Process Builder Client Script Library
// Alfa-XP, Michael Isipciuc, 2016.
//
FMS.Schema=function(b,a,d,c){this.designer=b;this.canvas=a;this.frameElement=d;this.xmlDoc=c;this.offsetX=a.offsetLeft;this.offsetY=a.offsetTop;this.canvasWidth=a.width;this.canvasHeight=a.height;this.mouseX=this.mouseY=0;this.isDown=false;this.moveActive=this.isNewConn=this.isLabelDrag=this.isNewMenu=this.isNewItem=this.isShift=false;this.dragItem=null;this.dragConn=null;this.dragPanel=null;this.selectedItem=null;this.selectedConn=null;this.selectedPort=null;this.hoverItem=this.hoverPort=null;this.alignmentX=this.alignmentY=0;this.context=a.getContext("2d");this.scale=1;a.addEventListener("mousedown",$createDelegate(this.handleMouseDown,this));a.addEventListener("mousemove",$createDelegate(this.handleMouseMove,this));a.addEventListener("mouseup",$createDelegate(this.handleMouseUp,this));a.addEventListener("mouseout",$createDelegate(this.handleMouseOut,this));a.addEventListener("mouseenter",$createDelegate(this.handleMouseEnter,this));if(this.frameElement){window.addEventListener("keydown",$createDelegate(this.handleZoomKeys,this));this.frameElement.contentWindow.addEventListener("keydown",$createDelegate(this.handleKeyDown,this));this.frameElement.contentWindow.addEventListener("keyup",$createDelegate(this.handleKeyUp,this))}else{window.addEventListener("keydown",$createDelegate(this.handleKeyDown,this));window.addEventListener("keyup",$createDelegate(this.handleKeyUp,this))}this.loadFromXml($(":first",c));this.redraw()};FMS.Schema.prototype={loadFromXml:function(d){this.$xnpanels=$("panels:first",d);this.initPanels();this.items=new Array();this.$xnitems=$("items:first",d);var f=this.$xnitems.children();var c=new Array();var g=this.canvasWidth;for(var a=0;a<f.length;a++){var e=f[a];var b=FMS.CreateSchemaBox(e);c[b.name]=a;this.items.push(new FMS.DesignerItem(this,b,a,e));if(b.x>g-50){g=b.x+b.w+50}}if(g>this.canvasWidth){this.resizeCanvas(g,this.canvasHeight)}for(var a=0;a<this.items.length;a++){FMS.CreateSchemaConnections(this.items[a],c)}},initPanels:function(){this.panels=new Array();var d=this.$xnpanels.children();var b=0;for(var a=0;a<d.length;a++){var c=new FMS.SchemaPanel(d[a]);this.panels.push(c);b+=c.height+2}if(b>this.canvasHeight){this.resizeCanvas(this.canvasWidth,b)}},redraw:function(){this.context.clearRect(0,0,this.canvasWidth,this.canvasHeight);if(this.selectedItem){if(this.selectedItem.box.x>this.canvasWidth-80){this.resizeCanvas(this.canvasWidth+120,this.canvasHeight)}else{if(this.selectedItem.box.y>this.canvasHeight-40){this.resizeCanvas(this.canvasWidth,this.canvasHeight+60)}}}FMS.DrawPanels(this);if(this.dragPanel){this.highlitePanel()}for(var b=0;b<this.items.length;b++){var e=this.items[b];for(var a=0;a<e.connectionsOut.length;a++){var d=e.connectionsOut[a];if(d!=this.selectedConn){d.drawShadow()}}}for(var b=0;b<this.items.length;b++){var e=this.items[b];var c=(e==this.selectedItem);for(var a=0;a<e.connectionsOut.length;a++){var d=e.connectionsOut[a];if(d!=this.selectedConn){d.draw(false,c)}}}this.drawAlignmentLines();for(var b=0;b<this.items.length;b++){var e=this.items[b];if(e!=this.selectedItem){e.draw()}}if(this.selectedItem){this.selectedItem.draw(true);this.selectedItem.drawSelectionRect(this.isLabelDrag);this.selectedItem.drawPorts(false)}if(this.isNewConn){if(this.hoverItem){this.hoverItem.drawPorts(true);if(this.hoverPort){this.hoverItem.drawActivePort(this.hoverPort)}}if(this.selectedPort){FMS.ConnectionLine.drawNew(this)}else{if(this.dragConn){FMS.ConnectionLine.drawModified(this)}}}else{if(this.selectedConn){this.selectedConn.drawSelected(this.isLabelDrag)}}this.context.fillStyle="blue";this.context.textAlign="left";for(var b=0;b<FMS.tracelines.length;b++){this.context.fillText(". "+FMS.tracelines[b],900,20+20*b)}FMS.tracelines=[]},drawAlignmentLines:function(){var c=this.alignmentX;var b=this.alignmentY;if(!this.isDown||(c==0&&b==0)){return}var a=this.context;a.strokeStyle="orange";a.setLineDash([5,5]);a.lineWidth=2;a.beginPath();if(c!=0){a.moveTo(c,0);a.lineTo(c,this.canvasHeight)}if(b!=0){a.moveTo(0,b);a.lineTo(this.canvasWidth,b)}a.stroke();a.closePath();a.setLineDash([])},highlitePanel:function(){this.context.drawRect(3,this.dragPanel.bottomY-3,this.canvasWidth-3,3,"#75bdff",null)},resizePanel:function(a){if(this.dragPanel.height+a>80){this.dragPanel.height+=a}this.dragPanel.changed=true},detectAlignmentLine:function(){var g=this.selectedItem.box;var b=g.x+g.cx;var e=g.y+g.cy;this.alignmentX=this.alignmentY=0;for(var d=0;d<this.items.length;d++){var f=this.items[d];if(f==this.selectedItem){continue}var g=f.box;var a=g.x+g.cx;var c=g.y+g.cy;if(b>=a-15&&b<=a+15){this.alignmentX=a}if(e>=c-15&&e<=c+15){this.alignmentY=c}if(this.alignmentX!=0&&this.alignmentY!=0){break}}},alignItem:function(a){if(this.alignmentX!=0){a.box.x=this.alignmentX-a.box.cx}if(this.alignmentY!=0){a.box.y=this.alignmentY-a.box.cy}a.resetConnections();this.alignmentX=this.alignmentY=0},detectHitElement:function(a,k){this.dragItem=this.dragConn=null;this.selectedPort=null;this.isNewConn=this.isLabelDrag=false;if(this.selectedItem!=null){this.selectedPort=this.selectedItem.detectPort(a,k);if(this.selectedPort){if(this.selectedPort&&!this.selectedItem.allowOutConn()){this.selectedPort=false;return false}this.isNewConn=true;return true}}else{if(this.selectedConn!=null){if(this.selectedConn.isPortClicked(a,k)){this.dragConn=this.selectedConn;this.isNewConn=true;return true}else{if(this.selectedConn.isTitleClicked(a,k)){this.isLabelDrag=true;return true}}}}this.selectedItem=this.selectedConn=this.dragPanel=null;for(var e=0;e<this.items.length;e++){var g=this.items[e];if(g.isLabelClicked(a,k)){this.selectedItem=g;this.isLabelDrag=true;return true}var f=g.box;if(a>=f.x&&a<=f.x+f.w&&k>=f.y&&k<=f.y+f.h){this.dragItem=this.selectedItem=g;this.handleInternalHit(g,a,k);return true}}for(var e=0;e<this.items.length;e++){var g=this.items[e];for(var d=0;d<g.connectionsOut.length;d++){var h=g.connectionsOut[d];if(h.isTitleClicked(a,k)){this.selectedConn=h;this.isLabelDrag=true;return true}if(h.containsPixel(a,k)){this.selectedConn=h;return true}}}for(var e=0;e<this.panels.length;e++){var b=this.panels[e].bottomY;if(k>b-12&&k<b){this.dragPanel=this.panels[e];return true}if(a<28&&k<b){this.designer.OpenSwimlane(this.$xnpanels,e);return false}}return false},handleInternalHit:function(b,a,c){if((b.box.type=="RecordState"||b.box.type=="Task")&&b.box.handler&&a<b.box.x+18&&c>b.box.y+54){this.dragItem=null;this.designer.OpenHandlerDesigner(null,null,b.box.handler)}else{if(b.box.type=="SubProcess"&&a>b.box.x+57&&a<b.box.x+83&&c>b.box.y+50){this.dragItem=null;this.openSubProcess(b)}else{if(b.box.type=="Start"&&a>b.box.x+15&&a<b.box.x+32&&c>b.box.y+32){this.dragItem=null;this.designer.OpenHandlerDesigner(null,null,b.box.handler)}}}},detectHoverPort:function(a,e){var b=10;for(var c=0;c<this.items.length;c++){var d=this.items[c].box;if(a>=d.x-b&&a<=d.x+d.w+b&&e>=d.y-b&&e<=d.y+d.h+b){this.hoverItem=this.items[c];if(this.hoverItem.connectionsIn.length>=this.hoverItem.maxIn){return}this.hoverPort=this.hoverItem.detectPort(a,e)}}},handleMouseDown:function(d){var a=new Date();if(this.lastClickTime&&a-this.lastClickTime<300){return}this.lastClickTime=a;if(this.isNewMenu){this.handleNewMenuClick(d);this.cancelAll();this.redraw();return}this.downX=this.mouseX=parseInt(d.clientX-this.offsetX);this.downY=this.mouseY=parseInt(d.clientY-this.offsetY);var c=this.selectedItem;var b=this.selectedConn;this.isDown=this.detectHitElement(this.mouseX,this.mouseY);if(this.isDown||c!=this.selectedItem||b!=this.selectedConn){this.redraw()}},handleMouseUp:function(a){if(this.isNewConn){if(this.hoverPort){if(this.dragConn&&this.hoverItem){this.selectedConn=this.dragConn.reconnect(this.hoverItem.index,this.hoverPort.i)}else{this.selectedItem.addConnection(this.selectedPort.i,this.hoverItem.index,this.hoverPort.i)}}else{if(this.dragConn==null){this.isDown=false;this.isNewMenu=true;this.drawNewMenu();return}}}var b=this.isNewConn||this.isLabelDrag||this.dragPanel||this.isNewMenu;this.cancelAll();if(this.selectedItem&&(this.alignmentX!=0||this.alignmentY!=0)){this.alignItem(this.selectedItem);b=true}if(b){this.redraw()}},handleMouseOut:function(a){if(this.isDown||this.isNewMenu||this.isNewConn){this.handleMouseUp(a)}if(this.isNewMenu){this.cancelAll(true);this.redraw()}},handleMouseMove:function(d){if(!this.isDown){return}var a=d.clientX;var f=d.clientY;if(!this.moveActive){if(Math.abs(this.downX-a)>5||Math.abs(this.downY-f)>5){this.moveActive=true}else{return}}var c=a-this.mouseX;var b=f-this.mouseY;this.mouseX=a;this.mouseY=f;if(this.dragItem!=null){this.dragItem.move(c,b);if(!this.isShift){this.detectAlignmentLine()}}else{if(this.isNewConn){this.detectHoverPort(a,f);if(this.hoverPort&&this.hoverPort==this.selectedPort){this.hoverPort=null}}else{if(this.isLabelDrag){if(this.selectedItem){this.selectedItem.moveLabel(c,b)}else{if(this.selectedConn){this.selectedConn.moveLabel(c,b)}}}else{if(this.dragPanel!=null){this.resizePanel(b)}}}}this.redraw()},handleMouseEnter:function(a){if(this.isNewItem){this.isNewItem=false;this.addSchemaItem(this.newItemType,a.clientX,a.clientY,-1);this.cancelAll();this.redraw()}},handleNewMenuClick:function(c){var k=c.clientX;var j=c.clientY;var a=this.newItemX;var g=this.newItemY;if(!(k>a&&k<a+140&&j>g&&j<g+40)){return}var l=k-a;var d="RecordState";if(l>108){d="End";a+=45;g-=7}else{if(l>80){d="SendMail";a+=45;g-=7}else{if(l>45){d="IfElse";a+=34;g-=8}else{g-=15}}}var h=this.selectedPort.pos;var f=3;switch(h){case 0:f=2;break;case 1:f=3;break;case 2:f=0;break;case 3:f=1;break}if(d==this.selectedItem.type){var b=this.selectedItem.box.x;var i=this.selectedItem.box.y;if(a>b-15&&a<b+15){a=b}if(g>i-15&&g<i+15){g=i}}this.addSchemaItem(d,a,g,f)},cancelAll:function(a){this.moveActive=false;this.dragItem=this.dragConn=this.selectedPort=this.dragPanel=null;this.isDown=false;this.isNewMenu=false;this.hoverItem=this.hoverPort=null;this.isNewConn=this.isLabelDrag=this.isShift=false;if(a){this.selectedItem=this.selectedConn=null}},deleteSelelected:function(){if(this.selectedItem){if(this.selectedItem.box.type=="Start"){AX.Window.alert("You cannot delete Start element from scheme.");return}this.selectedItem.deleteConnections();this.items.splice(this.items.indexOf(this.selectedItem),1);$(this.selectedItem.xn).remove();this.selectedItem=this.dragItem=null;this.redraw()}else{if(this.selectedConn){this.selectedConn.clearSource();this.selectedConn.clearTarget();this.selectedConn=null;this.redraw()}}},drawNewMenu:function(){var c=this.context;var a=this.newItemX=this.mouseX-70;var f=this.newItemY=this.mouseY-20;c.fillStyle="#b6d6fc";c.strokeStyle="#76b1ed";c.dropShadow("#5f5f5f",3,3);c.roundRect(a,f,140,40,{upperLeft:4,upperRight:4,lowerLeft:4,lowerRight:4},true,true);c.dropShadow(null);var b=a+6;var d=f+8;var e=new Image();e.src="images/toolbar/ico_state_small.png";c.drawImage(e,b,d,35,24);b+=40;e=new Image();e.src="images/toolbar/decision_small.png";c.drawImage(e,b,d,30,24);b+=35;e=new Image();e.src="images/toolbar/message_small.png";c.drawImage(e,b,d,24,24);b+=30;e=new Image();e.src="images/toolbar/end_red_small.png";c.drawImage(e,b,d,24,24)},addSchemaItem:function(k,o,l,m){var h=this.items.length;var a=k+(h-1);var q="";var n=a;if(this.parentState){a=this.parentState.subprocess.box.name+"_"+a}for(var e=0;e<h;e++){if(this.items[e].box.name==a){q=xml_random(100);break}}a+=q;n+=q;var f=this.appendXmlItem(this.$xnitems,k,a,n,o,l);var p=new FMS.DesignerItem(this,{x:o,y:l,name:a,text:n,type:k,text_x:0,text_y:0},h,f);this.items.push(p);p.changed=true;if(m==-1){p.box.x-=p.box.cx;p.box.y-=p.box.cy;var c=null;for(var e=0;e<this.items.length-1;e++){var g=this.items[e];for(var d=0;d<g.connectionsOut.length;d++){if(g.connectionsOut[d].containsPixel(o,l)){c=g.connectionsOut[d];break}}}if(c!=null){this.selectedItem=this.selectedConn=null;this.devideConnection(p,{x:o,y:l},c,h);window.setTimeout($createDelegate(function(){this.highliteConnections(true)},p),40);window.setTimeout($createDelegate(function(){this.highliteConnections(false)},p),120)}else{this.selectedItem=p}}else{if(this.selectedItem&&this.selectedPort){var b=p.getCenterPort(m);this.selectedItem.addConnection(this.selectedPort.i,h,b);this.selectedItem=p}}},appendXmlItem:function(f,g,b,i,j,h){var e=this.xmlDoc.createElement("item");var d=$(e);d.attr("name",b).attr("title",i).attr("type",g).attr("left",j).attr("top",h);if(g=="SubProcess"){var c=xml_appendNode(this.xmlDoc,d,"inner_schema");c.append(this.$xnpanels.clone());var a=xml_appendNode(this.xmlDoc,c,"items");this.appendXmlItem(a,"Start",b+"_Enter","",50,30);this.appendXmlItem(a,"Exit",b+"_Exit","",850,400)}f.append(e);return e},updateXmlConnection:function(a,b){if(a==null){a=xml_createNode(this.xmlDoc,"connection")}a.attr("sink",b.targetItem.name);a.attr("port",b.sourcePort.i);a.attr("sinkPort",b.targetPort.i);a.attr("title",b.title).attr("textLeft",b.title_x).attr("textTop",b.title_y);if(b.istimeout){a.attr("type","timeout")}},getState:function(){return{panels:this.panels,items:this.items,$xnpanels:this.$xnpanels,$xnitems:this.$xnitems}},restoreState:function(a){this.panels=a.panels;this.items=a.items;this.$xnpanels=a.$xnpanels;this.$xnitems=a.$xnitems},openSubProcess:function(b){this.saveLayoutXml();this.cancelAll(true);var c=this.getState();c.subprocess=b;if(this.parentState){c.parentState=this.parentState}this.parentState=c;if(b.inner_schema){this.restoreState(b.inner_schema)}else{var a=$("inner_schema:first",b.xn);this.loadFromXml(a)}this.designer.toggleMenu(false,b.box.text);$(this.canvas).hide().fadeIn(300)},openParentSchema:function(){this.saveLayoutXml();var b=this.parentState;if(!b){return}var a=b.subprocess;a.inner_schema=this.getState();this.parentState=b.parentState;this.cancelAll(true);this.restoreState(b);if(this.parentState){this.designer.toggleMenu(false,this.parentState.subprocess.box.text)}else{this.designer.toggleMenu(true,"")}$(this.canvas).hide();this.redraw();$(this.canvas).fadeIn(300)},getPos:function(d,c){var e=0;var b=c.x-d.x;var a=(c.y-d.y);if(Math.abs(b)>Math.abs(a)){e=1;if(c.x>d.x){e=3}}else{e=0;if(d.y>c.y){e=2}}return e},devideConnection:function(k,i,c,f){var g=c.sourcePort.pos;var j=c.points[0];var h=c.points[c.points.length-1];var b=this.getPos(j,i);var a=this.getPos(h,i);var m=k.getCenterPort(b);var l=k.getCenterPort(a);var d=c.targetItem;var e=c.targetPort;c.reconnect(f,m);k.addConnection(l,d.index,e.i)},moveSelected:function(b,a){if(this.selectedItem){this.selectedItem.move(b,a);this.redraw()}},resizeCanvas:function(a,b){this.canvas.width=this.canvasWidth=a;this.canvas.height=this.canvasHeight=b;this.frameElement.style.width=this.canvasWidth+"px";this.frameElement.style.height=this.canvasHeight+"px"},handleZoomKeys:function(a){if(a.keyCode==107||a.keyCode==109){this.handleKeyDown(a)}},handleKeyDown:function(a){a.preventDefault();switch(a.keyCode){case 27:this.selectedConn=this.selectedItem=null;this.cancelAll();this.redraw();break;case 46:this.deleteSelelected();break;case 37:this.moveSelected(-1,0);break;case 38:this.moveSelected(0,-1);break;case 39:this.moveSelected(+1,0);break;case 40:this.moveSelected(0,+1);break;case 16:case 17:case 18:this.isShift=true;if(this.alignmentX!=0||this.alignmentY!=0){this.alignmentX=this.alignmentY=0;this.redraw()}break;case 107:FMS.zoom(this,+0.05);break;case 109:FMS.zoom(this,-0.05);break}},handleKeyUp:function(a){this.isShift=false},saveLayoutXml:function(){for(var f=0;f<this.panels.length;f++){var b=this.panels[f];if(b.changed){b.changed=false;b.xn.setAttribute("height",b.height)}}for(var f=0;f<this.items.length;f++){var h=this.items[f];if(h.changed){h.changed=false;var d=$(h.xn);d.attr("left",h.box.x);d.attr("top",h.box.y);if(h.text_width){d.attr("textLeft",h.box.text_x);d.attr("textTop",h.box.text_y)}d.children("connection").remove();var k=d[0].childNodes;var g=(k.length!=0)?k[0]:null;for(var e=0;e<h.connectionsOut.length;e++){var c=h.connectionsOut[e];var a=xml_createNode(this.xmlDoc,"connection");a.attr("sink",c.targetItem.box.name);a.attr("port",c.sourcePort.i);a.attr("sinkPort",c.targetPort.i);if(c.title){a.attr("title",c.title).attr("textLeft",c.title_x).attr("textTop",c.title_y)}if(c.action){a.attr("action",c.action)}if(c.istimeout){a.attr("type","timeout")}if(c.level){a.attr("level",c.level)}a.attr("points",c.serializePoints());if(g){a.insertBefore(g)}else{d.append(a)}}window.status+=", "+h.box.name}}}};FMS.tracelines=[];FMS.trace=function(b,a){var c=b;if(a){c+=", "+a}FMS.tracelines.push(c)};