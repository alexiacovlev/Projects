// Process Builder Client Script Library
// Alfa-XP, Michael Isipciuc, 2016.
//
FMS.Properties_BaseInit=function(c,b){c._window=b;var a=c.$p=b.$content;c.$tbTitle=$("#tbTitle",a);c.$tbName=$("#tbName",a);c.tbDescription=$("textarea#tbDescription",a);$("div.fm-dlg-buttons",a).click($createDelegate(FMS.Properties_BaseClick,c));var d=$("div.fm-dlg-tabbar",a);if(d.length){c.tabBar=new FM.Tabbar(d)}};FMS.Properties_BaseLoad=function(b,a){b.item=a;var c=b.xn=a.xn;b.title=c.getAttribute("title");b.$tbTitle.val(b.title);b.$tbName.val(c.getAttribute("name"));b.tbDescription.val(c.getAttribute("description"));b._window.returnValue=null;b._window.show();b.$tbTitle.focus()};FMS.Properties_BaseSave=function(b){var a=b.$tbTitle.val().trim();if(a!=b.title){b.xn.setAttribute("title",a);b.item.box.text=a;b.item.initText();b._window.returnValue=true}b.xn.setAttribute("description",b.tbDescription.val().trim());return true};FMS.Properties_BaseClick=function(a){switch(_fm_getCommand(a)){case"OK":if(this.SaveState()){this._window.close()}break;case"X":this._window.close();break}};FMS.AssignPanel=function(e,b,a,d){this.custom=d;if(!a){this.fieldHtml=e.first().html().trim();e.empty()}else{this.fieldHtml=a}this.emptyMessage="No assignments";this.$panel=$("<div></div>");e.append(this.$panel);this.$panel.addHandler("click",this.field_click,this);if(b){var c=$("<a style='float:right;margin-top:5px;margin-right:8px;' class='fm-btn'><img src='/ASP.Net/FM/Common/Images/Menu/16_plus.png'/>Add field</a>");c.addHandler("click",this.add_click,this);e.append(c)}};FMS.AssignPanel.prototype={LoadState:function(f,e,c){this.xmlDoc=f;this.$xn=e;var a=$("assign:first",e);var b=a.children();this.clear();for(var d=0;d<b.length;d++){var g=b[d];var h=g.getAttribute("value");if(c&&!h){continue}this.appendHtmlField(g,g.getAttribute("name"),h,g.getAttribute("text"))}this.showEmptyMessage();return b},clear:function(){this.$panel.empty();this.inputs=[];this.registered=[]},isEmpty:function(){return(this.inputs.length==0)},showEmptyMessage:function(){if(this.inputs.length>0){return}this.$panel.html("<label style='padding:5px;width:120px;display:block;font-style:italic;margin-top:3px;height:16px;'>"+this.emptyMessage+"</label>")},appendHtmlField:function(a,c,f,g){this.registered[c]=true;var e=$(this.fieldHtml);this.$panel.append(e);var d=e.children();$(d[0]).text(c);var b=d[2];if(g){f=g+"("+f+")"}b.value=b.prevValue=f;b.fieldName=c;b.xnf=a;this.inputs.push(b);return b},SaveState:function(m,d,b,j,c){if(this.inputs.length==0){return}if(!j){if(!c){c="assign"}j=$(c+":first",d);if(j.length==0){j=xml_appendNode(m,d,c)}}var g=[];for(var h=0;h<this.inputs.length;h++){var f=this.inputs[h];var k=f.value.trim();if(k==f.prevValue||f.deleted){continue}var l="";if(FMS.DialogUtils.isConstantWithText(k)){var a=k.indexOf("('");if(a>0){l=k.substr(0,a);k=k.substr(a+1,k.length-a-2)}}else{k=FMS.DialogUtils.fixConstant(k)}var e=f.xnf;if(!k&&b){if(e){g.push(e)}}else{this.saveFieldXml(j,e,f,k,l)}}if(b&&g.length>0){for(var h=0;h<g.length;h++){$(g[h]).remove()}}return true},saveFieldXml:function(b,a,c,d,e){var f=c.fieldName;if(a==null){a=xml_appendNode(this.xmlDoc,b,"field")[0];a.setAttribute("name",f)}a.setAttribute("value",d);xml_updateAttribute(a,"text",e)},selectValue:function(a){this._tb=a;if(this.custom){return}if(!FMS.designer.tableName){AX.Window.alert("Please, define table in the schema properties dialog.");return}FM.ProgressBar.Show("loading");FMS.ExecuteService(JSON.stringify({table:FMS.designer.tableName,field:a.fieldName}),"Dialogs_LoadAssignValuesHtml",$createDelegate(this.select_onloaded,this))},select_onloaded:function(b){FM.ProgressBar.Hide();var c=b.d;if(c.Error){AX.Window.alert("Initialization",c.Error);return}if(c.Value){if(!FMS.AssignLookupList.current){FMS.AssignLookupList.current=new FMS.AssignLookupList()}FMS.AssignLookupList.current.Show(c.Value,this._tb)}else{var a=$("<textarea class='fm' style='font-size:10pt' rows='4'></textarea>");a.val(this._tb.value);AX.Window.dialog("Input value",a,function(){this._tb.value=a.val().trim();return true},this);a.focus().select()}},field_click:function(d){var f=d.target;if(!f.tagName=="IMG"){return}var c=f.getAttribute("cmd");if(c=="delete"){var b=$(f.parentNode).children();var a=b[2];this.deleteField(a,true)}else{if(c=="select"){var b=$(f.parentNode).children();var a=b[2];this.selectValue(a)}}},deleteField:function(a,b){if(b){AX.Window.confirm("Delete Confirmation","Are you sure you want to delete this assignment?",function(){this.deleteField(a,false)},this)}else{this.registered[a.fieldName]=null;a.deleted=true;if(a.xnf){$(a.xnf).remove()}$(a.parentNode).remove()}},add_click:function(){if(this.custom){var b=$('<div><div style="white-space:nowrap;margin:10px 20px;"><label style="width:90px" class="fm-lbl">Name:</label><input class="fm" style="width:230px;height:22px;" /></div></div>');var a=$(b.find("INPUT"));AX.Window.dialog("Add field",b,function(){var c=a.val().trim();if(c){this.onadd_field([c])}},this);a.focus()}else{if(!FMS.designer.tableName){AX.Window.alert("Please, define table in the schema properties dialog.");return}if(!FMS.AddFieldDialog.current){FMS.AddFieldDialog.current=new FMS.AddFieldDialog()}FMS.AddFieldDialog.current.Show(FMS.designer.tableName,$createDelegate(this.onadd_field,this))}},onadd_field:function(d){if(!d.length){return}if(this.inputs.length==0){this.$panel.empty()}for(var c=0;c<d.length;c++){var b=d[c];if(!this.registered[b]){var a=this.appendHtmlField(null,b,"","");a.prevValue=null}}},};FMS.StateAssignContainer=function(b,h,g,f,a){var e="<div style='margin:5px;'><label style='width:120px;font-weight:bold;display:inline-block;color:#0464d0;'></label><label>= </label><input class='fm' style='width:250px'/><img cmd='select' style='vertical-align:bottom;margin-left:2px;cursor:pointer' src='/ASP.Net/FM/Common/Images/btn_lookup_off.gif' /></div>";var d="<div style='margin:5px;'><label style='width:120px;display:inline-block;'></label><label>= </label><input class='fm' style='width:273px' disabled='disabled'/></div>";var c="<div style='margin:5px;'><label style='width:120px;display:inline-block;'></label><label>= </label><input class='fm' style='width:273px' /></div>";this.stateAssign=new FMS.AssignPanel($("#"+h,b),false,a?e:c);this.schemaAssign=new FMS.AssignPanel($("#"+g,b),false,d);this.swimlineAssign=new FMS.AssignPanel($("#"+f,b),false,d)};FMS.StateAssignContainer.prototype={LoadState:function(n,g,e,o,f){this.xmlDoc=n;var m=this.schemaAssign.LoadState(n,o,true);this.stateAssign.xmlDoc=n;this.stateAssign.clear();var c=$(e+":first",g).children();var k=[];for(var h=0;h<c.length;h++){var j=c[h];var d=j.getAttribute("value");if(!d){continue}var b=j.getAttribute("name");k[b]=true;this.stateAssign.appendHtmlField(j,b,d,j.getAttribute("text"))}for(var h=0;h<m.length;h++){var j=m[h];var d=j.getAttribute("value");if(!d){var b=j.getAttribute("name");if(!k[b]){this.stateAssign.appendHtmlField(null,b,"","")}}}this.stateAssign.showEmptyMessage();if(f!=-1){var a=$("panels",n.documentElement);var l=$(a.children()[f]);this.swimlineAssign.LoadState(n,l)}},SaveState:function(c,b,a){return this.stateAssign.SaveState(c,b,true,null,a)}};FMS.AddFieldDialog=function(){this.$itemsList=$("<div class='fm_list' style='height:334px;overflow-y:scroll;border:0;'></div>");this.$itemsList.addHandler("click",this.on_click,this);this._window=RMC_createDialog("Add Field","Select the fields from the list below",this.$itemsList,400,430,$createDelegate(this.Apply,this))};FMS.AddFieldDialog.prototype={Show:function(a,b){this.onapply=b;FM.DialogUtils.set_loading(this.$itemsList);this._window.show();FMS.ExecuteService(JSON.stringify({table:a}),"Dialogs_LoadFieldsHtml",$createDelegate(function(c){this.$itemsList.empty().html(c.d.Value)},this))},on_click:function(a){var b=a.target;if(b.tagName=="LABEL"){b=b.parentNode}var c=null;if(b.tagName=="A"){var c=$(b.firstChild);c.attr("checked",!c.attr("checked"))}else{if(b.tagName=="INPUT"){c=$(b)}else{return}}if(c.attr("checked")){c.parent().addClass("sel")}else{c.parent().removeClass("sel")}},Apply:function(d){var c=[];var a=this.$itemsList.children();for(var b=0;b<a.length;b++){var f=$(a[b].firstChild);if(f.attr("checked")){c.push(a[b].getAttribute("n"))}}this.onapply(c);return true}};FMS.AssignLookupList=function(){this.$itemsList=$("<div class='fm_list fms_list' style='height:334px;overflow-y:scroll;border:0;'></div>");this.$itemsList.addHandler("click",this.on_click,this);this.$itemsList.addHandler("dblclick",this.on_dblclick,this);this._window=RMC_createDialog("Lookup Field Data","Select the field's value from the list below",this.$itemsList,400,430,$createDelegate(this.Apply,this))};FMS.AssignLookupList.prototype={Show:function(b,a){this.tb=a;this.selected=null;this.$itemsList.empty().html(b);this._window.show()},on_click:function(a){var b=a.target;if(this.selected){this.selected.className=""}if(b.tagName=="A"){this.selected=b;b.className="sel"}},on_dblclick:function(a){this.Apply();this._window.close()},Apply:function(a){var b=this.selected;this.tb.value=b?b.getAttribute("v"):"";return true}};FMS.DialogUtils={isConstant:function(a){if(!a){return false}return(a[0]=="'"||a[0]=="#")},fixConstant:function(a){if(a&&a.indexOf(":")==-1&&a[0]!="~"&&a[0]!="#"&&a[0]!="'"&&a[0]!="$"&&a[0]!="["){a="'"+a+"'"}return a},isConstantWithText:function(a){if(!a){return false}return(a[0]!="'"&&a[0]!="#"&&a[a.length-1]==")"&&a[a.length-2]=="'")}};