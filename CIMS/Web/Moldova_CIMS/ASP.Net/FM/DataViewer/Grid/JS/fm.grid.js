// Grid Client Script Library
// Alfa-XP, Michael	Isipciuc,	2012, 2013, 2016.
//
FM.Grid=function(i,a,h,e,g,c){this.$container=i;this.$p=$(i[0].firstChild);this.inputParameters=a;var b=this.$p.children();this._info=b[0];this.hasInfo=(this._info.tagName!="SPAN");this._chart=b[1];this.hasChart=(this._chart.tagName!="SPAN");this._search=b[2];this.hasSearch=this.defineSearchMode();this._menu=b[3];this.$menu=$(this._menu);this.hasMenu=(this._menu.tagName!="SPAN");this.$gridPnl=$(b[4]);var f=this.$gridPnl.children();this.$gridBar=$(f[0]);this.$grid=$(f[1]);this.$footer=$(f[2]);this._settings=f[3];this.onrecordhandle=null;this.isBusy=false;this.fireEvent=false;this.selectedIndex=0;this.selectedCount=0;this.selectedRows=[];this._load_handler=$.proxy(this.onLoadData,this);this.initContainer();this.initSettings();if(this.loadOnInit){this.$gridPnl.css({visibility:""});this.loadData()}if(this.hasSearch){this.initSearch()}if(this.hasInfo){this.info_addbtn()}if(this.hasChart){this.loadChart()}if(c){FM.ProgressBar.Show("",true);this.openid=c;window.setTimeout($createDelegate(this.autoopen,this),600)}};FM.Grid.prototype={dispose:function(){$(window).off("resize",this._resize_handler)},initContainer:function(){this.extraHeight=Math.round(this.$p.height());this.rowHeight=this.$footer.height()+5;if(!this.rowHeight){this.rowHeight=20}this.stretchGrid();this._resize_handler=$createDelegate(this.stretchGrid,this);$(window).on("resize",this._resize_handler);this.initSortBar();this.$footer.addHandler("click",this.onPageClick,this);if(this.hasMenu){this.$menu.click($.proxy(this.menu_click,this))}},initSortBar:function(){this.$gridBar.addHandlers({click:this._onColumnClick,mousedown:this._onColumnDown,mouseup:this._onColumnUp},this);this.sortHelper=null;this.isListMode=(this.$gridBar.attr("mode")=="list")},initSettings:function(){var a=this._settings;this.queryID=a.getAttribute("queryID");this.sort=a.getAttribute("sort");this.allowSelect=a.getAttribute("select")=="1";this.allowCheck=a.getAttribute("check")=="1";this.allowMultiSelect=true;this.page=1;this.search="";this.filter=a.getAttribute("filter");this.widths="";this.loadOnInit=a.getAttribute("load")=="1";this.allowGrouping=false;this._initialized=true},settings:function(a){return this._settings.getAttribute(a)},getSelectedID:function(){return this.selectedRows.length>0?this.selectedRows[0].getAttribute("oid"):null},getSelectedIDArray:function(){var e=this.selectedRows;var b=[];for(var c=0;c<e.length;c++){b[c]=e[c].getAttribute("oid")}return b},loadData:function(){$.ajax({type:"POST",url:FM.Path+"DataViewer/Grid/Data.ashx?queryID="+this.queryID+this.getParameters(),contentType:"application/x-www-form-urlencoded; charset=utf-8",dataType:"html",success:this._load_handler,error:function(c,a,b){isBusy=false;alert("Load Data \n"+c.status+": "+b)}})},getParameters:function(){return"&ipp="+this.ipp+"&sort="+this.sort+"&page="+this.page+"&search="+this.search+"&filter="+this.filter+"&widths="+this.widths},onLoadData:function(a){this.$grid.html(a);this.isBusy=false;this.selectedRows=[];this.selectedCount=0;var b=this.$grid.children()[0];if(b.tagName=="TABLE"){this.initInnerGrid(b);this.updateStatusBar(b)}else{this._gridBody=null;this.updateStatusBar(b)}if(this.fireEvent||this.selected){this.fireEvent=false;if(this.OnRefresh){this.OnRefresh()}}if(this.allowCheck&&this.checkAll){this.checkAll.checked=false}},initInnerGrid:function(b){this._gridBody=b;this.$gridBody=$(b);this.rows=b.rows;var a=this.selectedIndex;this.shiftClickedIndex=-1;this.lastPickedIndex=-1;if(this.allowSelect&&!this.allowCheck){var c=null;if(a>0&&a<this.rows.length&&this.rows[a].getAttribute("oid")==this.selectedID){c=this.rows[a]}else{if(this.rows.length>0&&this.rows[0].getAttribute("oid")){c=this.rows[0]}}if(c){this.selectRow(c)}}this.$gridBody.addHandler("click",this.handleRowClick,this);if(this.allowSelect){this.$gridBody.addHandler("mouseover",this.onmouseover,this);this.$gridBody.addHandler("mouseout",this.onmouseout,this)}},updateSelectionInfo:function(){this.$selLabel.text(this.selectedCount)},updateStatusBar:function(c){if(!this.selHtmlNodes){var a=this.$footer.children();var e=$(a[0]);this.selHtmlNodes=e.children();this.$selLabel=$(this.selHtmlNodes[0]);this.$count=$(this.selHtmlNodes[2]);this.$total=$(this.selHtmlNodes[4]);this.pDiv=a[1];var f=$(this.pDiv).children();this.pFirst=f[0];this.pPrev=f[1];this.pNext=f[4];this.pLabel=f[3]}this.$count.text(c.getAttribute("count"));this.$total.text(c.getAttribute("total"));this.updateSelectionInfo();this.more=c.getAttribute("more")||"0";this.pDiv.style.display=(this.more=="0"&&this.page==1)?"none":"";var b=(this.page>1)?"1":"0";this.pFirst.className="page FL"+b;this.pPrev.className="page L"+b;this.pNext.className="page R"+this.more},onPageClick:function(b){var c=b.target;if(c.tagName=="SPAN"){if(this.isBusy){return}var a=c.className;if(!a&&(this.page>1||this.more=="1")){this.inputPage();return}if(a.indexOf("1")==-1){return}if(a.indexOf("R1")>0){this.page+=1}else{if(a.indexOf("FL1")>0&&this.page>1){this.page=1}else{if(a.indexOf("L1")>0&&this.page>1){this.page-=1}else{return}}}$(this.pLabel).text(this.page);this.Refresh(false,false)}},inputPage:function(){$(this.pLabel).html("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");var c=Math.round($(this.pLabel).height());var e=$("<input type='number' style='position:absolute;right:18px;top:0;width:26px;height:"+c+"px;padding:0;margin:0;border:0;text-align:center;outline:0' class='fm' maxlength='3'/>");var b=function(){e.remove();$(this.pLabel).text(this.page)};var a=function(g){if(g.keyCode!=13){return}var f=e.val().trim();if(isNaN(f)){return}this.page=parseInt(f);if(this.page>0){this.Refresh(false,false)}};e.addHandler("focusout",b,this);e.addHandler("keypress",a,this);$(this.pLabel.parentNode).append(e);e.val(this.page).focus()},request:function(){if(this.isBusy){return}this.isBusy=true;if(!this.loadOnInit){this.$menu.css("visibility","");this.$gridPnl.css("visibility","")}this.page=1;$(this.pLabel).text(this.page);this.loadData()},Refresh:function(b,a){if(this.isBusy){return}this.isBusy=true;this.$total.text("...");if(a&&this.selectedRows.length>0){var c=this.selectedRows[0];this.selectedIndex=c.rowIndex;this.selectedID=c.getAttribute("oid")}else{this.selectedIndex=0;this.selectedID=null}this.fireEvent=b;this.loadData()},handleRowClick:function(g){var j=g.target;var i=this.getRow(j);switch(j.tagName){case"INPUT":if(!this.allowSelect){return}if(j.type=="checkbox"){var a=j;if(a.checked){this.handleSelectRow(g,i,true)}else{this.unselectRow(i,true,true)}}break;case"A":var f=j.getAttribute("i");if(f){var c=f.split("=");window.fmOpenHandler("GRID/LOOKUP",this.queryID,c[0],"id="+c[1],null)}break;case"B":var b=j.getAttribute("h");if(b=="preview"||b=="m"){this.details_click(j,i,g,b);break}else{if(b){if(this.allowSelect){this.handleSelectRow(g,i)}this.action_click(j,i,g);break}}default:if(!this.allowSelect||!i){return}if(i.selected){if(this.allowMultiSelect&&g.ctrlKey){this.unselectRow(i,true,true)}else{this.row_dblclick(g)}}else{this.handleSelectRow(g,i)}break}},onmouseover:function(a){var b=this.getRow(a.target);if(!b||b.over||b.selected){return}b.over=true;$(b).addClass("row-over")},onmouseout:function(a){var b=this.getRow(a.target);if(b&&b.over){b.over=null;$(b).removeClass("row-over")}},handleSelectRow:function(c,a,b){if(a.IsDisabled=="1"){return}if(this.allowMultiSelect&&c&&c.ctrlKey){b=true}if(this.allowMultiSelect&&c&&c.shiftKey&&this.lastPickedIndex!=-1){if(this.shiftClickedIndex==-1){this.shiftClickedIndex=this.lastPickedIndex}if(a.rowIndex<this.shiftClickedIndex){this.SelectRecords(a.rowIndex,this.shiftClickedIndex,true)}else{this.SelectRecords(this.shiftClickedIndex,a.rowIndex,true)}}else{if(!b){this.UnselectRecords(a,false)}this.selectRow(a);this.shiftClickedIndex=-1}this.lastPickedIndex=a.rowIndex;this.raiseOnSelectionChanged()},selectRow:function(a,b){if(!a){return false}if(a.selected){return true}if(this.selectedCount>200){alert("TOO_MANY_RECORDS_SELECTED");return false}this.selectedCount++;a.selected=true;a.className="row row-selected";this.selectedRows.push(a);if(this.allowCheck){a.cells[0].firstChild.checked=true}if(b){this.raiseOnSelectionChanged()}return true},unselectRow:function(b,f,e){if(b&&b.selected){this.selectedCount--;b.selected=false;if(this.allowCheck){b.cells[0].firstChild.checked=false;if(f&&this.checkAll){this.checkAll.checked=false}}b.className="row";if(f){var a=this.selectedRows.length;for(var c=0;c<a;c++){if(b.rowIndex==this.selectedRows[c].rowIndex){this.selectedRows.splice(c,1);break}}}if(e){this.raiseOnSelectionChanged()}}},SelectRecords:function(e,h,c){var b;if(!e){e=0}if(!h){h=this.rows.length-1}if(c&&h!=this.rows.length-1&&e!=0){var a=this.selectedRows.length;for(var g=0;g<a;g++){var f=this.selectedRows[g];if(f&&(f.rowIndex<e||f.rowIndex>h)){this.unselectRow(f);this.selectedRows.splice(g,1);g--;a--}}}for(;e<h+1;e++){if(!this.selectRow(this.rows[e])){break}}this.lastPickedIndex=h;this.raiseOnSelectionChanged()},UnselectRecords:function(c,a){var b=this.selectedRows.pop();while(b){this.unselectRow(b);b=this.selectedRows.pop()}if(c){this.selectRow(c)}if(a){this.raiseOnSelectionChanged()}},raiseOnSelectionChanged:function(){this.updateSelectionInfo()},_onColumnClick:function(b){var f=b.target;if(this._gridBody==null){if(f.getAttribute("h")=="refresh"){this.Refresh(true,true)}return}switch(f.tagName){case"INPUT":this.checkAll=f;f.checked?this.SelectRecords():this.UnselectRecords(null,true);return;case"B":if(f.getAttribute("h")=="refresh"){this.Refresh(true,true)}return;case"I":if(f.className&&f.className.indexOf("fm-dg-ff")>0){this.loadFilters(f.parentNode);return}case"SPAN":f=f.parentNode;break}var c=$(f);if(f.getAttribute("f")&&f.getAttribute("o")!="off"){var a=this;if(!this.sortHelper){this.sortHelper=new FM.GridSortHelper(this)}this.sortHelper.HandleClick(c,b&&b.ctrlKey)}},_onColumnDown:function(g){var h=g.target;if(h.tagName=="TD"&&h.className=="fm-sep"){if(!this.h_colgroup){this.h_colgroup=this.$gridBar[0].firstChild.childNodes;this.auto_index=0;for(var c=0;c<this.h_colgroup.length;c++){if(this.h_colgroup[c].width==""){auto_index=c;break}}this._onColumnMoveDlg=$createDelegate(this._onColumnMove,this)}var b=$(h);var a=b.index()-1;this.h_right=(a>=auto_index);if(this.h_right){a+=2}this.h_col=this.h_colgroup[a];this.h_w=parseInt(this.h_col.width);this.h_pageX=g.pageX;this.$gridBar.on("mousemove",this._onColumnMoveDlg);this.$gridBar.css("cursor","col-resize");this.$h_next=b.next();if(this.$h_next.attr("o")!="off"){this.$h_next.css("pointer-events","none")}else{this.$h_next=null}this.$h_prev=b.prev();if(this.$h_prev.attr("o")!="off"){this.$h_prev.css("pointer-events","none")}else{this.$h_prev=null}this.d_col=null;if(this._gridBody!=null){var f=parseInt(this.h_col.getAttribute("i"));this.d_col=this._gridBody.firstChild.childNodes[f]}this.is_resize=true}},_onColumnMove:function(b){if(this.is_resize){var a=this.h_right?(this.h_pageX-b.pageX):(b.pageX-this.h_pageX);if(this.h_w+a>1){this.h_col.setAttribute("width",this.h_w+a);if(this.d_col){this.d_col.setAttribute("width",this.h_w+a+2)}}}},_onColumnUp:function(b){if(this.is_resize){this.is_resize=false;this.$gridBar.off("mousemove");this.$gridBar.css("cursor","default");if(this.$h_next){this.$h_next.css("pointer-events","auto")}if(this.$h_prev){this.$h_prev.css("pointer-events","auto")}this.widths="";for(var a=0;a<this.h_colgroup.length;a++){if(this.h_colgroup[a].getAttribute("i")){this.widths+=this.h_colgroup[a].width+";"}}}},getRow:function(a){if(this.isListMode){while(a!=null){if(a.tagName=="TABLE"&&a.className=="fm-dg-report"){return null}if(a.tagName=="DIV"&&a.className=="rep"){a=a.parentNode.parentNode;break}a=a.parentNode}if(a==null){return null}}else{while(a!=null&&a.tagName!="TR"){if(a.tagName=="TABLE"){return null}a=a.parentNode}}return(a.getAttribute("oid"))?a:null},stretchGrid:function(){if(this._settings.getAttribute("height")){this.dataHeight=parseInt(this._settings.getAttribute("height"))}else{this.dataHeight=this.$container.height()-this.extraHeight}this.$grid.height(this.dataHeight);this.ipp=Math.floor((this.dataHeight-3)/this.rowHeight)},row_dblclick:function(b){var a=this;if(typeof(FM.Grid.DblClick)=="function"){FM.Grid.DblClick(a,b)}else{FM.Grid.call_external(function(){FM.Grid.DblClick(a,b)})}},menu_click:function(b){var c=b.target;if(c.tagName=="DIV"){return}var a=this;if(typeof(FM.Grid.MenuClick)=="function"){FM.Grid.MenuClick(a,c)}else{FM.Grid.call_external(function(){FM.Grid.MenuClick(a,c)})}},action_click:function(f,c,b){var a=this;if(typeof(FM.Grid.ActionClick)=="function"){FM.Grid.ActionClick(a,f,c,b)}else{FM.Grid.call_external(function(){FM.Grid.ActionClick(a,f,c,b)})}},details_click:function(g,f,c,b){if(!f){return}var a=this;if(typeof(FM.Grid.LoadDetails)=="function"){FM.Grid.LoadDetails(a,g,f,c,b)}else{FM.Grid.call_external(function(){FM.Grid.LoadDetails(a,g,f,c,b)})}},autoopen:function(){FM.ProgressBar.Hide();var a=FM.Path+"DataViewer/Grid/Open.ashx?queryID="+this.queryID+"&id="+this.openid+"&filter="+this.filter;var b=$.ajax({url:a,async:false,dataType:"text"}).responseText;if(b=="1"){window.fmOpenHandler("GRID",this.queryID,"0","id="+this.openid,this._settings.getAttribute("openWnd"),$createDelegate(this.window_onclose,this))}},window_onclose:function(a){if(a!=null){this.Refresh(true,true)}},defineSearchMode:function(){var a=this._search.tagName;if(a=="DIV"){this.searchByForm=true;this.searchPanelHeight=$(this._search).height();return true}else{if(a=="TABLE"){this.searchPanelHeight=$(this._search).height();return true}}return false},initSearch:function(){var e=this;if(this.searchByForm){var b=function(){FM.GridSearchInitForm(e)};if(typeof(FM.GridSearchInitForm)=="function"){b()}else{window.setTimeout(function(f){Runtime_ResourceLoader.LoadResources([FM.Path+"DataViewer/Grid/JS/fm.grid.searchform.js"],b)},200)}}else{var c=this._search.rows[0].cells;var a=$(c[2].firstChild);var g=function(h){if(e.s_attached){return}e.s_attached=true;var i=$(c[1].firstChild);var f=$(c[3].firstChild);if(typeof(FM.GridSearch)=="function"){(new FM.GridSearch(e,i,a,f))}else{Runtime_ResourceLoader.LoadResources([FM.Path+"DataViewer/Grid/JS/fm.grid.search.js"],function(){new FM.GridSearch(e,i,a,f)})}};a.one("focus",g)}},info_addbtn:function(){var a=$(this._info);var c=a.attr("path");if(c){var b=$("<img src='/ASP.Net/System/Images/edit.gif' title='Edit' style='position:absolute;top:3px;right:3px;cursor:pointer;'/>");a.append(b);b.click(function(){AX.Window.createFrameWindow(App.SystemPath+"Admin/HtmlDesigner/?mode=WINDOW&path="+c,"Html Editor",1000,800)})}},loadFilters:function(b){var a=this;if(!a.GridFilters){if(typeof(FM.GridFilters)=="function"){new FM.GridFilters(a,b)}else{window.Runtime_ResourceLoader.LoadResources([FM.Path+"DataViewer/Grid/JS/fm.grid.filters.js"],function(){new FM.GridFilters(a,b)})}}else{a.GridFilters.Show(b)}},loadChart:function(){var b=this;if(!this.chart){if(typeof(FM.GridChart)=="function"){this.chart=new FM.GridChart(this)}else{var a=$createDelegate(function(){this.chart=new FM.GridChart(this)},this);window.Runtime_ResourceLoader.LoadResources(["/ASP.Net/Modules/AX.ChartDashboard/JS/Chart.min.js",FM.Path+"DataViewer/Grid/JS/fm.grid.chart.js"],a)}}else{this.chart.reload()}}};FM.GridSortHelper=function(b){this.grid=b;this.$h=b.$gridBar;this.sortData=[];var c=b.sort.split(";");for(var a=0;a<c.length;a++){d=c[a].split(":");this.sortData.push(d)}this.HandleClick=function(e,g){var p=e;var m=p.attr("f");var n=null;for(var k=0;k<this.sortData.length;k++){var o=this.sortData[k];if(o[0]==m){o[1]=(o[1]=="0")?"1":"0";n=o;break}}if(g){if(!n){this.sortData.push([m,"1"])}}else{this.sortData=[];if(n){this.sortData.push(n)}else{this.sortData.push([m,"1"])}}var x="";for(var k=0;k<this.sortData.length;k++){if(k>0){x+=";"}var r=this.sortData[k];x+=r[0]+":"+r[1]}var q=this.sortData;var w=$(".fm-dg-hdr",this.$h);for(var k=0;k<w.length;k++){var e=$(w[k]);var l=e.attr("f");var t=null;for(var j=0;j<q.length;j++){if(q[j][0]==l){t=q[j][1];break}}var u=null;var v=e.children();var h=null;if(v.length>0){u=v[0]}if(t){if(!u){u=document.createElement("i");e.append(u)}u.className="fm-ico fm-dg-"+(t=="1"?"up":"dn")}else{if(u){u.className=""}}}this.grid.sort=x;this.grid.page=1;this.grid.Refresh(false,false)}};FM.Grid.call_external=function(a){Runtime_ResourceLoader.LoadResources([FM.Path+"DataViewer/Grid/JS/fm.grid.resources.js.ashx?"+App.Settings.LCID,FM.Path+"DataViewer/Grid/JS/fm.grid.utils.js"],a)};FM.FrameControl=function(b,a,e,c){c.loadURL(b[0].firstChild.getAttribute("url"))};