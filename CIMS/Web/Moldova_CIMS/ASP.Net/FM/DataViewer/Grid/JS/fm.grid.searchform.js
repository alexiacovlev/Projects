FM.GridSearchInitForm=function(grid){this.dg=grid;this.$p=$(grid._search);var mas=this.$p.children();this.$container=$(mas[0]);this.$buttons=$(mas[1]);var $btn0=$(this.$buttons.children()[0]);var $btn1=$(this.$buttons.children()[1]);this.ticket=this.$container.attr("ticket");this.cookieFormKey=this.$container.attr("sf");this.initForm=function(){this.form=new FM.DataForm(this.$container,this.ticket);if(App.User.IsAdmin){this.form.addEditBtn(5,this)}var list=this.form._controlList;for(var i=0;i<list.length;i++){var o=list[i];if(o.Type=="DateTimePeriod"){o._control=new FM.DateTimePeriod(o)}}};this.scriptBeforeSearch=function(hasData,bReset){var script=this.form._scriptStorage.getAttribute("savescript");if(script){var frm=this.form.getScriptForm();frm.IsValid=true;frm.HasData=hasData;frm.IsReset=bReset;try{eval(script)}catch(e){alert("On Search Request\n"+e.description);return false}if(!frm.IsValid){return false}}return true};this.search=function(){var data="";var list=this.form._controlList;for(var i=0;i<list.length;i++){v=list[i].WriteFilterData();if(v){data+=v}}if(!this.scriptBeforeSearch(data!="",false)){return}if(data){this.dg.search="[FORM]:"+data}else{this.dg.search=""}this.dg.request();if(this.dg.hasChart){this.dg.loadChart()}if(data){$btn0.show()}else{$btn0.hide()}if(this.cookieFormKey){this.storeQuery(data)}};this.reset=function(){this.form.Reset();this.dg.search="";if(!this.scriptBeforeSearch(false,true)){if(!this.dg.loadOnInit){this.dg.$menu.css("visibility","hidden");this.dg.$gridPnl.css("visibility","hidden")}}else{this.dg.request();if(this.dg.hasChart){this.dg.loadChart()}}$btn0.hide();if(this.cookieFormKey){this.storeQuery(null)}};this.storeQuery=function(data){if(data){var c_value=escape(data);var exdate=new Date();exdate.setDate(exdate.getDate()+14);window.document.cookie=this.cookieFormKey+"="+c_value+";expires="+exdate.toUTCString()}else{var exdate=new Date();exdate.setDate(exdate.getDate()-1);window.document.cookie=this.cookieFormKey+"=;expires="+exdate.toUTCString()}};this.Redraw=function(){};if(typeof(FM.DataForm)=="function"){this.initForm()}else{window.Runtime_Library.loadObjectType("FM.DataForm","FORM",null,$.proxy(this.initForm,this))}$btn1.click($.proxy(this.search,this));this.$container.addHandler("keypress",function(e){if(e.keyCode==13){$btn1.focus();window.setTimeout(function(){$btn1.click()},50)}},this);$btn0.click($.proxy(this.reset,this))};FM.DateTimePeriod=function(e){this.base=e;this.base.useControlWriter=true;var a=e._ui.rows[0].cells;this.$chday=$(a[0].firstChild);this.$chday.addHandler("click",this.chday_click,this);var d=this.d1=new FM.DateTimeControl();d.base=new FM.FieldHolder(e.input,e.hostForm);d.base._control=d;d._ui=a[1].firstChild;d.$ui=$(d._ui);d.init();var c=this.d2=new FM.DateTimeControl();c.base=new FM.FieldHolder(e.input,e.hostForm);c.base._control=c;c._ui=a[2].firstChild;c.$ui=$(c._ui);c.init();d.base.$ui=c.base.$ui=e.$ui;if(this.base.value!=""){var b=this.base.value.split("--");d.setValue(b[0]);c.setValue(b[1])}};FM.DateTimePeriod.prototype={chday_click:function(){this.d2.$ui.css("visibility",this.$chday.is(":checked")?"hidden":"visible")},setValue:function(a){this.d1.setValue(a);this.d2.setValue(a)},getValue:function(){return""},WriteFilterData:function(){var e=this.$chday.is(":checked");var d=this.d1.base.value;var b=this.d2.base.value;if(e&&d!=""){var c=d.substr(0,d.indexOf("T"));d=c+"T00:00:00";b=c+"T23:59:59"}if(d==""&&b==""){return""}var a=this.base.Name+":"+this.base.Type;return"["+a+"]"+d+"--"+b+"[/"+a+"]"}};