FM.GridFilters=function(a,b){this.grid=a;this.grid.GridFilters=this;this.initialfilter=a.filter;this._onloaded=$createDelegate(this.onloaded,this);this.Show(b)};FM.GridFilters.prototype={Show:function(d){if(this.$column&&this.$column[0]==d){this.clear();return}var c=this.grid;this.field=d.getAttribute("f");var b=$(d);this.$column=b;var a=this.$popup;if(!a){a=this.$popup=$("<div class='fm-dg-menupopup'></div>");this.grid.$p.append(this.$popup);a.addHandler("blur",this.hide,this).addHandler("click",this.onclick,this);a.hide()}else{a.empty()}if(!this._vis){a.hide();$.ajax({url:FM.Path+"DataViewer/Grid/LoadGroups.ashx?queryID="+c.queryID+"&ff="+this.field+"&search="+jsonEncode(c.search)+"&filter="+this.initialfilter,dataType:"json",success:this._onloaded})}},onloaded:function(d){this._vis=true;this.data=d;var k="";if(d.error){k="<div style='font-weight:bold;margin:20px;line-height:20px;'>Load Data Error: <br/>"+d.error+"</div>"}else{if(d.ids.length>0){k+="<a class='fm-m-a' value=''> - all - </a>";for(var b=0;b<d.ids.length;b++){k+="<a class='fm-m-a' value='"+d.ids[b]+"'>"+d.texts[b]+" ("+d.values[b]+")</a>"}}else{k+="<div style='padding:10px 30px;'> - all - </div>"}if(d.ids.length>10){this.$popup.css({maxHeight:400,overflowY:"auto"})}else{this.$popup.css({maxHeight:"none",overflowY:"hidden"})}}this.$popup.html(k);var c=this.$popup;var e=this.$column;var f=e.position();var h=f.left;var g=f.top+e.outerHeight();var j=c.outerWidth();var a=this.grid.$p.outerWidth()-h-j-20;if(a<0){h+=a}c.css({left:h,top:g});c.slideDown("fast").attr("tabIndex",100).focus()},onclick:function(c){var d=c.target;if(d.tagName=="A"){var b=d.getAttribute("value");var a=this.initialfilter;if(this._active){this._active.title="";this._active.className="fm-ico fm-dg-ff";this._active=null}if(b){if(a!=""){a+=";"}a+=(this.field+":"+urlEncodeURI(b));var f=this.$column.find(".fm-dg-ff");if(f.length){f[0].title=$(d).text();f[0].className="fm-ico fm-dg-ff fm-dg-ffs";this._active=f[0]}}if(this.grid.filter!=a){this.grid.filter=a;this.grid.request()}this.hide()}},clear:function(){if(!this._active){return}this._active.title="";this._active.className="fm-ico fm-dg-ff";this._active=null;this.$column=null;this.grid.filter=this.initialfilter;this.grid.request()},hide:function(){if(this._vis){this._vis=false;this.$popup.hide().attr("tabIndex",-1)}}};