FM.GridSearch=function(b,d,a,c){this.grid=b;this.$clm=d;this.has_clm=(d!=null);this.$tb=a;this.$btn=c;this.$btn.addHandler("click",this.btn_click,this);this.$tb.addHandlers({blur:this.tb_focuslost,keydown:this.tb_keydown,keyup:this.tb_keyup},this)};FM.GridSearch.prototype={btn_click:function(){var a=(this.has_clm)?this.$clm.val():"";var b=this.$tb.val().trim();this.grid.search=(b!="")?(a+":"+urlEncodeURI(b)):"";this.grid.request();if(this.grid.hasChart){this.grid.loadChart()}},tb_focuslost:function(a){this.hidePanel()},tb_keydown:function(b){var a=b.keyCode;this.allowHandle=(a>40||a==8);if(this.isOpened){if(a==38||a==40){this.selectNext(a==40)}else{if(a==13){this.tb_onpressenter()}}}},tb_keyup:function(c){if(!this.allowHandle){return}var b=(this.has_clm)?this.$clm.val():"";var a=this.$tb.val().trim();if(a.length>1){this.showPanel();this.loadList(b,a)}else{this.hidePanel()}},showPanel:function(){if(!this.isOpened){this.isOpened=true;if(!this.$popup){this.$popup=$("<div class='fm-popup'></div>");this.$popup.addHandler("mousedown",this.panel_click,this)}else{this.$popup.empty()}var b=this.$tb.outerWidth();if(b<100){b=100}var d=this.$tb.offset();var a=d.left;var c=d.top+this.$tb.outerHeight();this.$popup.css({width:b+"px",left:a+"px",top:c+"px","z-index":5000,height:"22px"});document.body.appendChild(this.$popup[0])}},panel_click:function(a){a.preventDefault();if(a.target.tagName=="A"){this._selected=a.target;this.tb_onpressenter(a)}},hidePanel:function(){if(this.isOpened){this.isOpened=false;document.body.removeChild(this.$popup[0])}},loadList:function(a,b){if(this.runtime_loading||!b){return}this.runtime_loading=true;fmExecuteDataService("Grid_Suggestions",'{"queryID":"'+this.grid.queryID+'","column":"'+a+'","text":"'+jsonEncode(b)+'","filterData":"'+jsonEncode(this.grid.filter)+'"}',$createDelegate(this.loadList_Completed,this))},loadList_Completed:function(a){this.runtime_loading=false;if(this.isOpened){this.$popup.empty().css("height","22px")}this._selected=null;this.selectedIndex=-1;this.$popup.html(a.d);var c=this.$popup.children().length;var b=(c>=10)?220:c*22;if(b<22){b=22}this.$popup.css("height",b+"px")},tb_onpressenter:function(){this.hidePanel();var a=this._selected;if(!a){a=this.findInTheList()}if(a){this.$tb.val($(a).text())}this.$btn.click()},findInTheList:function(){var c=this.$tb.val().trim().toLowerCase();if(c!=""){var b=this.$popup.children();for(var a=0;a<b.length;a++){if(b[a].innerHTML.trim().toLowerCase()==c){return o=b[a]}}}return null},selectNext:function(a){var b=this.selectedIndex+(a?1:-1);var c=this.$popup.children();if(b>=c.length||b<0){return}this.selectedIndex=b;if(this._selected){this._selected.className=""}this._selected=c[this.selectedIndex];this._selected.className="fm-o-a fm-o-sel"}};