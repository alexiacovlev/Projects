FM.GridChart=function(a){Chart.defaults.global.maintainAspectRatio=false;Chart.defaults.global.defaultFontColor="#333";this.grid=a;this.panel=a._chart;this.chart=null;this.data=null;this.clicked_item=null;this.groupby=a._chart.getAttribute("groupby");this.type=a._chart.getAttribute("type");this.state=a._chart.getAttribute("state");this.allowMaximize=(this.state=="max");this.maximized=this.allowMaximize;this.initialfilter=a.filter;this.allowRequest=!this.maximized;this._clicked=null;this.reload()};FM.GridChart.prototype={reload:function(){$.ajax({url:FM.Path+"DataViewer/Grid/LoadChart.ashx?queryID="+this.grid.queryID+"&groupby="+this.groupby+"&search="+this.grid.search+"&filter="+this.initialfilter,dataType:"json",success:$createDelegate(this.onloaded,this)})},chart_click:function(c,d){if(!d||!d.length){return}var b=d[0];var a=b._index;var g="";if(this._clicked){this.dataset.backgroundColor[this._clicked_index]=this._clicked._view.backgroundColor=this._clicked_color}if(b!=this._clicked){this._clicked=b;this._clicked_index=a;this._clicked_color=b._view.backgroundColor;this.dataset.backgroundColor[a]=b._view.backgroundColor="#feaf44";g=this.data.ids[a]}else{this._clicked=null;g=null}this.chart.update(0);if(this.allowRequest){this.grid.filter=this.initialfilter;var f=(g!=null)?(this.groupby+":"+g):"";if(f&&this.initialfilter){this.grid.filter+=";"}this.grid.filter+=f;this.grid.request()}},createArray:function(c,d){var b=new Array();for(var a=0;a<d;a++){b.push(c)}return b},onloaded:function(c){this.clicked_item=null;this.data=c;var e=this.dataset={data:c.values};if(c.error){$(this.panel).html("<div style='font-weight:bold;margin:20px;line-height:20px;'>Chart Data Error: <br/>"+c.error+"</div>");return}var d=null;var a=$createDelegate(this.chart_click,this);var d={type:this.type.toLowerCase(),data:{labels:c.texts,datasets:[e]},options:{responsive:true,legend:{display:false},title:{display:false},layout:{padding:{left:5,right:0,top:10,bottom:0}},onClick:a}};if(d.type=="pie"){d.options.legend={display:true,position:"left"};e.backgroundColor=["#6bcded","#90ed7d","#434348","#f7a35c","#8085e9","#1862ab","#62ab17","#ff0080","#cfff33","#495c5c"];e.borderColor="#ffffff"}else{if(d.type=="line"){e.backgroundColor="#6bbced";e.borderColor="#1c97e1";e.borderWidth=1}else{d.options.scales={xAxes:[{barPercentage:0.7}],yAxes:[{ticks:{beginAtZero:true}}]};e.backgroundColor=this.createArray("#6bbced",c.values.length);e.borderColor="#1c97e1";e.borderWidth=1}}if(this.chart){this.$canvas.toggle(e.data.length>0);this.chart.data.datasets[0]=this.dataset;this.chart.update()}else{var b=$(this.panel);this.$canvas=$("<canvas></canvas>");b.append(this.$canvas);this.chart=new Chart(this.$canvas[0].getContext("2d"),d)}}};