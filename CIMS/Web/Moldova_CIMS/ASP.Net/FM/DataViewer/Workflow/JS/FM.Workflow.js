// Workflow Client Script Library
// Alfa-XP, Michael	Isipciuc,	2012.
//
FM.Workflow=function(i,e,c,b,g,f,a){this._window=b;this.$p=i;this.inputParameters=e;this.ticket=c;this.inputXmlData="";this.instanceKey="";this.invokeName=null;this.form=null;this.control=null;this.process=a?true:false;if(!b){if(!e&&location.search){this.inputParameters=location.search.substr(1)}var d=$("<div class='fm-p-form-nowindow'></div>");i.empty().append(d);this.$p=d}this.$p.html("<div class='fm-wf-container'></div><div class='fm-wf-info'></div><div class='fm-form-bottom'></div><b class='fm-b fm-ico-wf' style='display:none'/>");var h=this.$p.children();this.$container=$(h[0]);this.$roundtrip=$(h[1]);this.$buttons=$(h[2]);this._service_MoveCompleted=$.proxy(this.service_MoveCompleted,this);this.Run("forward");if(App.User.IsAdmin){this.$btn_w=$(h[3]);this.$btn_w.addHandler("click",function(){FM.ShowAdminWindow("WorkflowBuilder",1160,690,"ticket="+this.ticket,null)},this);this.$btn_w.css("display","")}};FM.Workflow.prototype={dispose:function(){if(this.form){this.form.dispose();this.form=null}else{if(this.control){if(this.control.dispose){this.control.dispose()}this.control=null}}},Run:function(a){if(this.invokeName){FM.ProgressBar.Show("")}this.service_MoveAsync(a,null,0)},service_MoveAsync:function(d,b,a){this.allowMove=false;var c='{"ticket":"'+this.ticket+'","instanceKey":"'+this.instanceKey+'","direction":"'+d+'","index":"'+(this._window?this._window.index:"")+'","input":"'+jsonEncode(this.inputParameters)+'","inputXml":"'+jsonEncode(this.inputXmlData)+'","saveXml":'+(b!=null?('"'+jsonEncode(b)+'"'):"null")+',"tabIndex":'+a+',"process":'+this.process+"}";fmExecuteDataService("Workflow_Move",c,this._service_MoveCompleted)},service_MoveCompleted:function(a){FM.ProgressBar.Hide();var b=this.info=a.d;this.dispose();this.$container.html(b.Html);if(b.HasErrors){this.initButtons();return}this.allowMove=false;if(this._window&&b.ReturnKeyValue!=null){this._window.returnValue=b.ReturnKeyValue}this.returnValue=b.ReturnKeyValue;this.invokeName=b.InvokeName;this.instanceKey=b.Key;if(this.invokeName!=null){if(this._window&&!this.IsNavigatorHost){this._window.setHeader(b.Title!=null?b.Title:this.invokeName)}if(b.Html!=""){if(b.Type=="FORM"){if(typeof(FM.DataForm)=="function"){this.initForm()}else{window.Runtime_Library.loadObjectType("FM.DataForm","FORM",null,$.proxy(this.initForm,this))}}else{this.initCustom(b.Type,this.$container[0].firstChild)}}if(b.Roundtrip!=null){this.$roundtrip.html(b.Roundtrip)}else{}}else{this.IsCompleted=true;if(this.OnComplete){this.OnComplete(b.OutputData)}else{if(this._window){this._window.close()}}}this.allowMove=true},Redraw:function(){this.Run("")},initForm:function(){this.form=new FM.DataForm(this.$container,this.ticket,this._window);this.initButtons();this.form.btn_click=$.proxy(this.btn_click,this);if(App.User.IsAdmin){this.form.addEditBtn(25,this)}},initButtons:function(){var b=this.info;var a="";if(b.Button_Prev){a+=this.buildButton(b.Button_Prev,"prev",65,"fm-btn-prev",false)}if(b.Button_Update){a+=this.buildButton(b.Button_Update,"save",65,"fm-btn-save",false)}if(b.Button_Next){a+=this.buildButton(b.Button_Next,"next",65,"fm-btn-next",false)}if(this._window){a+=this.buildButton(b.Button_Close,"X",65,"fm-btn-close",false)}this.$buttons.html(a);if(!this._initialized){this._initialized=true;this.$buttons.click($.proxy(this.btn_click,this))}},initCustom:function(type,o){if(type=="PROFILE"){this.$p.empty().append(o)}else{this.initButtons()}this.control_container=o;var code=o.getAttribute("loadscript");if(code){try{var $panel=$(o);eval(code)}catch(e){alert(e.description)}return}var typeName=o.getAttribute("typeName");if(!typeName){return}var libraryName=o.getAttribute("libraryName");var resources=o.getAttribute("resources").split(",");this.control_ticket=o.getAttribute("ticket");this.control_data=o.getAttribute("input");window.Runtime_Library.loadObjectType(typeName,libraryName,resources,$createDelegate(this.onReadyCustom,this))},onReadyCustom:function(a){this.control=new a($(this.control_container),this.control_data,this.control_ticket,this._window)},customBuildXml:function(c){var b="";for(var a=0;a<c.length;a++){var d=c[a].Name;if(!d){continue}b+="<"+d+">"+xmlEncode(c[a].Value)+"</"+d+">"}return b},Save:function(f,e){if(!this.allowMove){return}var d=this.form;var g=(f=="rollback");if(d!=null&&!d.Readonly){var c=d.buildXml(!g);if(c==null||(c==""&&g)){if(g){this.Run(f)}}else{var a=0;if(f=="forward"){FM.ProgressBar.Show("")}else{FM.ProgressBar.Show("",true)}this._bClose=e;this.service_MoveAsync(f,c,a)}}else{if(this.control!=null&&!g&&this.control.Workflow_SaveState){var b=this.control.Workflow_SaveState();if(b==null){return}var c=this.customBuildXml(b);this._bClose=e;this.service_MoveAsync(f,c,0)}else{this.Run(f)}}},buildButton:function(e,d,a,b,c){return"<a cmd='"+d+"' class='fm-btn "+b+"' style='min-width:"+a+"px;'>"+e+"</a>"},btn_click:function(b,a){if(b){a=_fm_getCommand(b)}switch(a){case"save":this.Save("",false);break;case"next":this.Save("forward",false);break;case"prev":this.Save("rollback",false);break;case"process-back":this.Save("",false);break;case"reload":this.Redraw();break;case"X":case"close":this.Close();break}},btn_toggle:function(a){$("A",this.$buttons).each(function(){this.disabled=!a?"disabled":""})},process_sendComplete:function(){fmExecuteDataService("Workflow_Clear",'{"ticket":"'+this.ticket+'","instanceKey":"'+this.instanceKey+'"}')},process_panel:function(b,a){this.$container.empty().append(b);this.$buttons.empty().append(a)},Close:function(){if(this._window){this._window.close()}}};