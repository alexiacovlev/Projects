FM.DateTimeControl=function(){};FM.DateTimeControl.prototype={init:function(){var b=this._ui;this.dbox=b.firstChild;this.$dbox=$(this.dbox);this.$dbtn=$(this.dbox.nextSibling);this.$ui.on("mousedown",$.proxy(this.date_click,this));this.base.initInputBox(this.$dbox,this.dbox);this.$dbox.blur($.proxy(this.date_onblur,this));this.$dbox.on("keydown",$.proxy(this.date_keyPress,this));this.$dbox.on("keyup",$.proxy(this.date_keyUp,this));this.calendar=null;this.d_isOpened=false;var a=this._ui.nextSibling;if(a){this.hasTime=true;this._tbox=a.firstChild;this._tbtn=this._tbox.nextSibling;this.$tbox=$(this._tbox);this.$tbox.addHandler("focus",this.time_onfocus,this);$(a).addHandler("mousedown",this.time_click,this)}else{this.hasTime=false}},date_onblur:function(a){this.date_hideCalendar()},date_keyPress:function(f){var c=f.which;var a=(c>=48&&c<=57||c>=96&&c<=105);this.correction=false;if(a){var b=this.dbox.value;if(this.dbox.selectionStart>=0&&this.dbox.selectionStart<b.length-1){this.correction=true}else{this.dbox.value=this.mask_formatValue(b)}}else{if(c==0||a||c==8||c==9||c==37||c==39||c==46||c==35||c==36){return}else{var d=App.Settings.DateSeparator;if(d=="/"&&(c==191||c==111)){return}if(d=="."&&(c==190||c==110)){return}f.preventDefault()}}},date_keyUp:function(b){if(!this.correction){return}this.correction=false;var a=this.dbox.selectionStart;this.dbox.value=this.mask_formatValue(this.dbox.value);this.dbox.selectionStart=this.dbox.selectionEnd=a},mask_formatValue:function(h){var c=App.Settings.NormalizedDatePattern.toLowerCase();var l=App.Settings.DateSeparator;var e="",d=0,f,g,a;var k=c.replace(/[^mdy]/g,"");var b=h.replace(/[^0-9]/g,"");for(i=0;i<b.length;i++){f=b.charAt(i);g=k.charAt(i);e+=f;a=(i<k.length-1)?k.charAt(i+1):g;if(g!=a){e+=l}}return e},parseTextValue:function(a){if(a==""){return""}try{var c=DT_parseDate(a);if(c&&this.hasTime){var d=this.getDate();if(d){c.setHours(d.getHours());c.setMinutes(d.getMinutes())}}this.dbox.value=DT_formatDate(c);return DT_formatUtcDate(c)}catch(b){this.base.showTooltip(b);this.dbox.value=this.base.prevValue;return null}},date_click:function(a){if(this.base.Readonly){return}if(a.target.tagName=="INPUT"&&a.target.value!=""){return}a.preventDefault();if(!this.d_isOpened){this.dateShow()}else{this.date_hideCalendar()}},dateShow:function(a){this.d_isOpened=true;if(!this.calendar){var c=$createDelegate(function(b){this.calendar=new b(this);this.$dbox.focus()},this);window.Runtime_Library.loadObjectType("FM.Calendar",null,["/ASP.Net/FM/Common/UI/Calendar/fm.calendar.js"],c)}else{this.$dbox.focus();this.calendar.Show()}},date_hideCalendar:function(a){this.d_isOpened=false;if(this.calendar){this.calendar.Hide()}},time_click:function(b){if(this.base.Readonly){return}if(b.target.tagName=="INPUT"&&b.target.value!=""){return}b.preventDefault();if(!this.timelist){var a=$createDelegate(function(){this.timelist=new FM.Timelist(this);this.timelist.show()},this);window.Runtime_Library.loadObjectType("FM.Timelist",null,["/ASP.Net/FM/Common/UI/Calendar/fm.timelist.js"],a)}else{this.timelist.toggle()}},time_onfocus:function(b){if(this.base.Readonly){return}if(!this.timelist){var a=$createDelegate(function(){this.timelist=new FM.Timelist(this)},this);window.Runtime_Library.loadObjectType("FM.Timelist",null,["/ASP.Net/FM/Common/UI/Calendar/fm.timelist.js"],a)}},setDateValue:function(c){var b=DT_formatUtcDate(c);var a=DT_formatDate(c);this.base.tb_setValue(b,a);this.base.prevValue=a},getDate:function(){return this.base.value!=""?DT_parseUtcValue(this.base.value):null},setValue:function(a){if(!a){this.base.tb_setValue("","");if(this.hasTime){this.$tbox.val("")}}else{if(typeof(a)=="string"){a=DT_parseUtcValue(a)}this.setDateValue(a);if(this.hasTime){this.$tbox.val(DT_pad(a.getHours())+":"+DT_pad(a.getMinutes()))}}},getText:function(){var a=this.dbox.value;if(this.hasTime){a+=" "+this._tbox.value}return a}};DT_parseDate=function(k,c){var h=App.Settings.NormalizedDatePattern;var l=App.Settings.DateSeparator;var g=0;var a=0;var f=1;var j=k.split(l);if(l=="."&&k.indexOf(",")>0){j=k.split(",")}var b=h.split(l);for(var e=0;e<b.length&&e<j.length;e++){if(j[e]==""||isNaN(j[e])){throw (fmres("Form__WrongDate","The date is wrong, please use format: ")+App.Settings.ShortDatePattern)}switch(b[e]){case"dd":f=parseInt(j[e],10);if(f>31){f=1}break;case"MM":a=parseInt(j[e],10);if(a>12){a=1}break;case"yyyy":g=parseInt(j[e],10);if(g<100){g=2000+g}else{if(g<1900){g=1900}else{if(g>2100){g=2100}}}break}}if(g==0){g=(new Date()).getFullYear()}if(a==0){a=(new Date()).getMonth()+1}return new Date(g,a-1,f)};DT_formatDate=function(a){var h=App.Settings.NormalizedDatePattern;var k=App.Settings.DateSeparator;var b=a.getMonth()+1;var f=a.getDate();var g=a.getFullYear();var c=h.split(k);var j="";for(var e=0;e<c.length;e++){if(e>0){j+=k}switch(c[e]){case"dd":j+=DT_pad(f);break;case"MM":j+=DT_pad(b);break;case"yyyy":j+=g;break}}return j};DT_formatUtcDate=function(a){return String(a.getFullYear())+"-"+DT_pad(a.getMonth()+1)+"-"+DT_pad(a.getDate())+"T"+DT_pad(a.getHours())+":"+DT_pad(a.getMinutes())+":00"};DT_parseUtcValue=function(a){if(a.length>10){return new Date(parseInt(a.substr(0,4),10),(parseInt(a.substr(5,2),10)-1),parseInt(a.substr(8,2),10),parseInt(a.substr(11,2),10),parseInt(a.substr(14,2),10),parseInt(a.substr(17,2),10))}else{if(a.length>0){return new Date(parseInt(a.substr(0,4),10),(parseInt(a.substr(5,2),10)-1),parseInt(a.substr(8,2),10))}else{return null}}};DT_pad=function(a){return(String(a).length==1)?("0"+a):a};var format=App.Settings.ShortDatePattern;if(format.length!=10){var sep=App.Settings.DateSeparator;var fmas=format.split(sep);for(var i=0;i<fmas.length;i++){if(fmas[i]=="d"){fmas[i]="dd"}else{if(fmas[i]=="M"){fmas[i]="MM"}else{if(fmas[i]=="yy"){fmas[i]="yyyy"}}}}format=fmas.join(sep)}App.Settings.NormalizedDatePattern=format;