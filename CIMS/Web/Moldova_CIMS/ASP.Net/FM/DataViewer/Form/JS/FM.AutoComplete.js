FM.AutoComplete=function(b,a){this.control=a;this.lookupMode=(b=="lookup-field");this.active=false;if(this.lookupMode){this.base=a.base;this.$lbox=a.$lbox;this.$ui=this.$lbox.parent();this.$ui.addHandlers({keydown:this.lbox_keydown,mouseup:this.lbox_mouseup},this);this.allow_input=false}else{this.base=a.base;this.$ui=this.$tb=a.$ui;this.$tb.addHandlers({blur:this.tb_focuslost,keydown:this.tb_keydown,keyup:this.tb_keyup},this)}};FM.AutoComplete.prototype={lbox_editMode:function(){this.allow_input=true;if(!this.active){window.status="";this.active=true;this._prevHtml=this.$lbox[0].innerHTML;this._prevText=this.$lbox.text();this.$tb=$("<input class='fm' style='background-color:#ffffd5' tabIndex='"+this.$lbox.prop("tabIndex")+"' />");this.$ui.hide();this.$tb.insertAfter(this.$ui);this.$tb.addHandlers({blur:this.tb_focuslost,keydown:this.tb_keydown,keyup:this.tb_keyup},this);this.$tb.val(this._prevText).focus().select()}},lbox_mouseup:function(a){var b=a.target;if(b.tagName=="DIV"||this.$lbox[0].className.indexOf("fm-off")>0){this.lbox_editMode()}},lbox_keydown:function(b){if(!this.allow_input){var a=b.keyCode;if(a>40||a==8||a==13){this.allow_request=true&&(a!=13);this.lbox_editMode()}}},tb_focuslost:function(a){this.hidePanel();if(this.lookupMode&&this.active){if(this._prevText!=""&&this.$tb.val()==""){this.lbox_removeTextBox();this.control.setLookupItems(null);this.base.event_change_fire()}else{this.lbox_removeTextBox();this.$lbox.html(this._prevHtml)}}},lbox_removeTextBox:function(){if(this.active){this.$tb.remove();this.$tb=null;this.active=false;this.$ui.show()}this.allow_input=false},list_onenter:function(){this.hidePanel();var c=this._selected;if(!c){c=this.findInTheList()}if(this.lookupMode){this.lbox_removeTextBox();var a=null;var b=(c)?c.getAttribute("oid"):null;if(b){a=[(new FM.LookupItem(b,"",c.innerHTML))]}this.control.setLookupItems(a);this.base.event_change_fire();this.$lbox.focus()}else{if(c&&c.innerHTML!="&nbsp;"){this.$tb.val(c.innerHTML)}}},tb_keydown:function(b){var a=b.keyCode;this.allow_request=(a>40||a==8);if(this.isOpened){b.stopPropagation();if(a==38||a==40){this.selectNext(a==40)}else{if(a==13){this.list_onenter()}}}else{if(a==13){b.stopPropagation();this.$lbox.focus()}}},tb_keyup:function(b){if(!this.allow_request){return}var a=this.$tb.val().trim();if(a.length>1){this.showPanel();this.loadList(a)}else{this.hidePanel()}},findInTheList:function(){var c=this.$tb.val().trim().toLowerCase();if(c!=""){var b=this.$popup.children();for(var a=0;a<b.length;a++){if(b[a].innerHTML.trim().toLowerCase()==c){return o=b[a]}}}return null},selectNext:function(a){var b=this.selectedIndex+(a?1:-1);var c=this.$popup.children();if(b>=c.length||b<0){return}this.selectedIndex=b;if(this._selected){this._selected.className="fm-o-a"}this._selected=c[this.selectedIndex];this._selected.className="fm-o-a fm-o-sel"},setSelectedValue:function(a,b){if(this.base.value!=a){this.base.value=a;$(this._label).text(b);this.base.event_change_fire()}},showPanel:function(){if(!this.isOpened){this.isOpened=true;if(!this.$popup){this.$popup=$("<div class='fm-popup'></div>");this.$popup.addHandler("mousedown",this.panel_click,this)}else{this.$popup.empty()}var b=this.$tb.outerWidth();if(b<100){b=100}var d=this.$tb.offset();var a=d.left;var c=d.top+this.$tb.outerHeight();this.$popup.css({width:b+"px",left:a+"px",top:c+"px","z-index":5000,height:"auto"});document.body.appendChild(this.$popup[0])}},panel_click:function(a){a.preventDefault();if(a.target.tagName=="A"){this._selected=a.target;this.list_onenter(a)}},hidePanel:function(){if(this.isOpened){this.isOpened=false;document.body.removeChild(this.$popup[0]);window.status=""}},loadList:function(c){if(this.runtime_loading||!c){return}window.status+=".";this.runtime_loading=true;var a=this.base.resolveBindings();var b=this.base.get("pn")+this.base.Name;fmExecuteDataService("Form_Suggestions",'{"ticket":"'+this.base.hostForm.ticket+'","name":"'+b+'","text":"'+jsonEncode(c)+'","filterData":"'+a+'"}',$createDelegate(this.runtime_onLoaded,this))},runtime_onLoaded:function(a){this.runtime_loading=false;this.clearList();this.$popup.html(a.d!=""?a.d:"<a class='fm-o-a' value=''>&nbsp;</a>");var c=this.$popup.children().length;var b=(c>8)?"250px":"auto";this.$popup.css("height",b)},clearList:function(){if(this.isOpened){this.$popup.empty().css("height","auto")}this._selected=null;this.selectedIndex=-1},};