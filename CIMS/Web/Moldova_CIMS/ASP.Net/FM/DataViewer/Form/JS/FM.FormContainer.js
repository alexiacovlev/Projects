// Form Client Script Library
// Alfa-XP, Michael Isipciuc, 2012.
//
FM.FormContainer=function(e,b,d,c){this._window=c;if(!c){var a=$("<div class='fm-p-form-nowindow'></div>");e.empty().append(a);this.$p=a}else{this.$p=e}this.inputParameters=b;this.ticket=d;this.form=null;this.loadContainer()};FM.FormContainer.prototype={dispose:function(){if(this.form){this.form.dispose();this.form=null}},loadContainer:function(){$.ajax({type:"GET",url:FM.Path+"DataViewer/Form/FormContainerData.aspx?ticket="+this.ticket+"&i="+(this._window?this._window.index:"")+"&"+this.inputParameters,contentType:"application/x-www-form-urlencoded; charset=utf-8",dataType:"html",success:$.proxy(this.onFormLoaded,this),error:function(c,a,b){alert("Load Script Module \n"+c.status+": "+b)}})},Redraw:function(){this.dispose();this.loadContainer()},onFormLoaded:function(b){if(this.form){this.form.dispose()}this.$p.html(b);var a=this.$p.children();this.$container=$(a[0]);this.$buttons=$(a[1]);this.form=new FM.DataForm(this.$container,this.ticket,this._window);this.initButtons();if(App.User.IsAdmin){this.form.addEditBtn(3,this)}if(this._window&&!this.IsNavigatorHost){this._window.setHeader(this.$container.attr("wnd_title"))}this.allowSave=true},initButtons:function(){var a=this.form.btn_click=$.proxy(this.btn_click,this);this.$buttons.click(a)},btn_click:function(b,a){if(b){a=_fm_getCommand(b)}switch(a){case"save":this.Save(false);break;case"saveclose":this.Save(true);break;case"reload":this.Redraw();break;case"close":this.Close(true);break}},Save:function(c){if(!this.allowSave){return}this.closeAfter=c;var a=this.form.buildXml(true);if(a==null){return}else{if(a==""){if(c){this.Close()}return}}this.allowSave=false;var b='{"ticket":"'+this.ticket+'","input":"'+jsonEncode(this.inputParameters)+'","xmlData":"'+jsonEncode(a)+'"}';fmExecuteDataService("Form_SaveData",b,$.proxy(this.service_OnSave,this))},service_OnSave:function(a){var c=a.d;if(c.HasError){var b=$("A",this.$buttons);$(b[0]).hide();$(b[1]).hide();this.$container.html(c.Html)}else{this.allowSave=true;var d=c.Html;if(this._window){this._window.returnValue=d}this.inputParameters="id="+d;if(this.closeAfter){this.Close()}else{if(this.OnChangeInput&&this.form.keyValue==""){this.OnChangeInput(this.inputParameters)}else{this.loadContainer()}}}},Close:function(){if(this._window){this._window.close()}}};