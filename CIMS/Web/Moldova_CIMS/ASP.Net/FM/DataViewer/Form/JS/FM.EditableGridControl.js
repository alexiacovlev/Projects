FM.EditableGridControl=function(){};FM.EditableGridControl.prototype={init:function(){this.base.useControlWriter=true;this._tableHeader=this._ui.firstChild;this._table=this._tableHeader.nextSibling;this._footer=this._ui.nextSibling;var d=this.base;this.allowModify=d.get("smartedit")=="1";this.allowSelect=d.get("select")=="1";this.allowNumbering=d.get("numbering")=="1";this.allowTotal=d.get("total")=="1";this.createHandler=d.get("create");this._isChanged=false;var b=this._table.rows.length;if(this.createHandler=="[ROW]"){this.$emptyRow=$(this._table.rows[b-1]);this.newRowHtml=this.$emptyRow.html();if(this.$emptyRow.css("display")=="none"){b=b-1}else{this.$emptyRow=null}$(this._footer.firstChild).addHandler("click",this.AddRowInGrid,this)}else{if(this.createHandler=="[WINDOW]"){$(this._footer.firstChild).addHandler("click",this.AddRowInWindow,this)}}this.totalIndex=this.allowTotal?parseInt(this._footer.getAttribute("totalIndex")):-1;this._img_onclick=$createDelegate(this.img_onclick,this);this._rows=[];for(var a=0;a<b;a++){this._rows.push(new FM.EditableGridRow(this,this._table.rows[a]))}var c=this._tableHeader.firstChild.nextSibling;if(c){$(c).addHandler("click",this.admin_click,this)}},WriteXmlData:function(d,a,f){var h="";var b=false;var e,g;for(var c=0;c<this._rows.length;c++){g=this._rows[c];e=g.buildXmlData(a,this.allowModify,f);if(e!=""){h+=e}if(g.hasData){b=true}}if(!b&&this.base.IsRequired){this.base.NotifyRequired(fmres("Form__AppendRowRequired","Please, add at least one row for")+" "+this.base.Title);return null}if(h==""){return""}return"<"+this.base.Name+"><records>"+h+"</records></"+this.base.Name+">"},dispose:function(){},focus:function(){this._ui.focus()},onchange:function(){},setValue:function(a,b){},set_readonly:function(a){},AddRowInGrid:function(a){if(this._table.nextSibling){this._table.nextSibling.style.display="none"}this.AddEditableRow()},AddRowInWindow:function(b){this.selectedRowIndex=-1;this.selectedRowID="";var a="_data="+this.base.get("createData");window.fmOpenHandler("EGRID/NEW",this.base.hostForm.ticket,this.base.Name,a,null,$.proxy(this.onAppendRowInWindow,this))},AddEditableRow:function(){var a;if(this.$emptyRow!=null){a=this.$emptyRow;this.$emptyRow=null;a.css("display","")}else{a=$("<tr class='fm-eg-row' state='added' keyValue=''>"+this.newRowHtml+"</tr>");$(this._table).append(a)}this._rows.push(new FM.EditableGridRow(this,a[0]));this.ReNumberingRows()},ReNumberingRows:function(){if(this.allowNumbering){for(var a=0;a<this._table.rows.length;a++){this._table.rows[a].innerHTML=(a+1)}}},DeleteRow:function(a){if(!a){return}if(!this.allowModify){var c=a.getAttribute("keyValue");var b=$.proxy(function(d){if(d.d){alert(d.d)}else{this.deleteRow_complete(a)}},this);this.server_rowCommand(c,"DELETE",b)}else{this.deleteRow_complete(a)}},deleteRow_complete:function(c){var a=c.getAttribute("state");if(a=="added"||!this.allowModify){var b=c._gridRow;c._gridRow=null;b.dispose();Array.removeItem(this._rows,b);$(c).remove()}else{c.style.display="none";c.setAttribute("state","deleted");this._isChanged=true}this.ReNumberingRows();this.Recalculate();this.base.event_change_fire()},OpenRowInWindow:function(b){var c=b._gridRow;if(!c.keyValue){return}this._modifyingRow=c;var a="id="+c.keyValue;this._appendRow=false;window.fmOpenHandler("EGRID/EDIT",this.base.hostForm.ticket,this.base.Name,a,null,$.proxy(this.reloadRow,this))},onAppendRowInWindow:function(a){if(!a){return}this._appendRow=true;this.reloadRow(a)},reloadRow:function(a){this.server_rowCommand(a,"RELOAD",$.proxy(this.reloadRow_complete,this))},server_rowCommand:function(c,a,b){if(!c){return}fmExecuteDataService("EGRID_Row",'{"cmd":"'+a+'","formID":"'+this.base.hostForm.ticket+'","name":"'+this.base.Name+'","gridName":"'+this.base.get("v")+'","keyValue":"'+c+'"}',b)},reloadRow_complete:function(a){var c=a.d;var g=$(c);if(this._appendRow){if(this._rows.length==0){var f=this._table.nextSibling;if(f&&f.tagName=="TABLE"){$(f).remove()}}$(this._table).append(g);this._rows.push(new FM.EditableGridRow(this,g[0]))}else{var e=this._modifyingRow;var b=this._rows.indexOf(e);e.dispose();this._modifyingRow=null;var d=$(e._htmlRow);d.replaceWith(g);this._rows[b]=new FM.EditableGridRow(this,g[0])}this.ReNumberingRows();this.Recalculate();this.base.event_change_fire()},Recalculate:function(){if(!this.allowTotal){return}var b=0;var c,e;for(var a=0;a<this._rows.length;a++){e=this._rows[a];if(e._htmlRow.getAttribute("state")=="deleted"){continue}b+=e.getTotalValue()}if(this.$totalBox==null){this.$totalBox=$(this._footer.lastChild.childNodes[1])}var d=(this._footer.getAttribute("int")=="1");this.$totalBox.text(Num_toString(b,d));return b},img_onclick:function(c){var f=c.target;var b=f.getAttribute("cmd");var d=f.parentNode.parentNode;if(b=="edit"){this.OpenRowInWindow(d)}else{if(b=="delete"&&!this.base.Readonly){var a=d.getAttribute("state");if(a=="added"){this.DeleteRow(d)}else{AX.Window.confirm(fmres("Grid__Confirmation","Confirmation"),fmres("Form__DeleteRow","Are you sure you want to delete this row?"),function(){this.DeleteRow(d)},this)}}}},admin_click:function(){var b=this.base.get("t");var a=this.base.get("v");FM.ShowAdminWindow("ViewBuilder",860,540,"t="+b+"/v="+a+"/mode=EGRID")}};FM.EditableGridRow=function(a,b){this._egrid=a;this._htmlRow=b;this._htmlRow._gridRow=this;this.keyValue=b.getAttribute("keyValue");this.isNewRow=(this.keyValue=="");this._controlList=new Array();this._controls=new Array();this._disposables=null;this.ticket=a.base.hostForm.ticket;this.$p=a.base.hostForm.$p;if(a.allowModify){this.initEditableMode()}else{this.initViewMode()}};FM.EditableGridRow.prototype={dispose:function(){if(this._disposables!=null){for(var a=0;a<this._disposables.length;a++){this._disposables[a].dispose()}this._disposables=null}},initEditableMode:function(){var d,c;var h=new Array();var g=this._egrid.totalIndex;var a=null;for(var b=0;b<this._htmlRow.cells.length;b++){d=this._htmlRow.cells[b];var e=d.firstChild;if(e.tagName=="INPUT"){var c=new FM.FieldHolder(e,this);this.registerControl(c.Name,c);if(c.bindings!=null){h.push(c)}if(b==g){this.totalControl=c._control;if(!a){a=$createDelegate(this._egrid.Recalculate,this._egrid)}c.event_change_add(a)}}else{if(e.tagName=="IMG"){$(e).click(this,this._egrid._img_onclick)}}}FM.DataForm.RegisterObservers(this,h)},initViewMode:function(){$(this._htmlRow).addHandler("click",this.view_mode_click,this);if(this._egrid.allowTotal){this.totalLabel=this._htmlRow.cells[this._egrid.totalIndex].firstChild}},getTotalValue:function(){if(this._egrid.allowModify){return this.totalControl.getNumber()}else{var a=this.totalLabel.getAttribute("value");return(a)?parseFloat(a,10):0}},view_mode_click:function(b){var c=b.target;if(c.tagName=="IMG"&&c.getAttribute("cmd")){return this._egrid._img_onclick(b)}else{if(c.tagName=="A"&&c.getAttribute("oid")&&c.parentNode.className.indexOf("fm-off")==-1){var d=c.parentNode;var a=d.getAttribute("pn")+d.getAttribute("n");window.fmOpenHandler("FORM/LOOKUP_RO",this._egrid.base.hostForm.ticket,a+"|"+c.getAttribute("otype"),"id="+c.getAttribute("oid"),null)}else{if(c.tagName=="A"&&c.getAttribute("href")){return}else{if(this._egrid.allowSelect){this._egrid.OpenRowInWindow(b.currentTarget)}}}}},registerControl:function(a,b){this._controls[a]=b;this._controlList.push(b);b.initialize()},getScriptForm:function(){var a=this._egrid.scriptForm;if(!a){this._egrid.scriptForm=a=new FM.FormScriptObject(this)}a.host=this;a.Readonly=this._egrid.base.Readonly;a.HostName=this._egrid.base.Name;return a},eval:function(script){var frm=this._egrid.base.hostForm.getScriptForm();var row=this.getScriptForm();try{eval(script)}catch(e){alert(e.description)}},buildXmlData:function(a,b,e){this.hasData=false;var d=this._htmlRow.getAttribute("state");if(d=="deleted"){return"<result keyValue='"+this.keyValue+"' state='deleted'/>"}if(!b){this.hasData=true;return""}var f="";for(var c=0;c<this._controlList.length;c++){o=this._controlList[c];if(d=="added"){e=true}res=o.WriteXmlData(false,a,e);if(res==null){return""}f+=res}if(f.length==0){if(d!="added"){this.hasData=true}return""}if(d==null||d==""){d="updated"}this.hasData=true;return"<result keyValue='"+this.keyValue+"' state='"+d+"'>"+f+"</result>"},showTab:function(){},getField:function(a){return this._controls[a]}};FM.ReadonlyEGridControl=function(){};FM.ReadonlyEGridControl.prototype={init:function(){this.base.useControlWriter=true;var a=this.base.input;this._tableHeader=this._ui.firstChild;this._table=this._tableHeader.nextSibling;$(this._table).addHandler("click",this.onclick,this);this.allowSelect=(this.base.get("select")=="1")},onclick:function(b){var c=b.target;if(c.tagName=="A"&&c.parentNode.className.indexOf("fm-off")==-1){if(c.href){return}var d=c.parentNode;var a=d.getAttribute("pn")+d.getAttribute("n");window.fmOpenHandler("FORM/LOOKUP_RO",this.base.hostForm.ticket,a+"|"+c.getAttribute("otype"),"id="+c.getAttribute("oid"),null)}else{if(this.allowSelect){if(c.tagName=="LABEL"){c=c.parentNode}if(c.tagName=="DIV"||(c.tagName=="IMG"&&c.getAttribute("cmd"))){c=c.parentNode}if(c.tagName=="TD"){c=c.parentNode}if(c.tagName=="TR"){window.fmOpenHandler("EGRID/EDIT_RO",this.base.hostForm.ticket,this.base.Name,"id="+c.getAttribute("keyValue"),null,null)}}}},WriteXmlData:function(){return""},setValue:function(a){},focus:function(){},event_change_add:function(){}};