// Profile Client Script Library
// Alfa-XP,	Michael	Isipciuc,	2012,2017.
//
FM.Navigator=function(g,a,e,c){this.$p=g;this._window=c;this.inputParameters=a;this.ticket=e;this.groupName="";this.tabIndex=0;this._selected="";this._sid=null;if(!c&&App.nodeData){var d=App.nodeData;var b=d.indexOf("/");if(b>0){this._sid=d.substr(b+1);d=d.substr(0,b)}this._selected=d}this.allowChangeUri=false;this.Reload(false);this._onLoadContent=$.proxy(this.onLoadContent,this);this._onReadyContent=$.proxy(this.onReadyContent,this);this.contentHandler=null;this._create_handler=$.proxy(function(f){this.contentHandler=f},this);this._RefreshCounting=$createDelegate(this.counting_Refresh,this);this._ChangeInput=$createDelegate(this.ChangeInput,this)};FM.Navigator.prototype={dispose:function(){this.disposeContent();if(this._counting){this._counting.dispose();this._counting=null}},disposeContent:function(){if(this.contentHandler&&typeof(this.contentHandler.dispose)=="function"){this.contentHandler.dispose()}this.contentHandler=null},Reload:function(b){this.tree=null;var a='{"ticket":"'+this.ticket+'","groupName":"'+this.groupName+'","selected":"'+this._selected+'","input":"'+jsonEncode(this.inputParameters)+'","uid":""}';fmExecuteDataService("Navigator_Generate",a,$.proxy(this._reloadComplete,this));if(this._counting){this._counting.Stop()}},_reloadComplete:function(a){var b=a.d;this.$p.html(b.Html);if(b.HasError){return}this.initNavigator();if(this._window){this._window.setHeader(b.Header)}},initNavigator:function(){var b=this.$p.children();this.$left=$(b[0]);this.$sp=$(b[1]);this.$content=$(b[2]);b=this.$left.children();this.$cmdBar=$(b[0]);this.$leftInner=$(b[1]);this.$tabs=$(b[2]);this._tabs=this.$tabs.children();this._tabTrees=this.$leftInner.children();this.bStart=true;var a=this.$tabs.attr("index");var c=this.$tabs.attr("folder");if(this._tabs.length>a){this.selectTab(a,$(this._tabs[a]),c)}this.allowChangeUri=(!this._window);this.$leftInner.addHandler("mousedown",this.OnNodeClick,this);this.$cmdBar.click($.proxy(this.toolbar_click,this));this.$sp.addHandler("mousedown",this.splitter_mdown,this);if(this._tabs.length>1||b[2].style.display!="none"){this.$tabs.click($.proxy(this.OnTabClick,this));this.resizePanel()}},OnTabClick:function(d){var f=d.target;var b=(f.tagName=="IMG"||f.tagName=="LABEL")?$($(f).parent()):$(f);this.clearTabs();var c=parseInt(b.attr("i"));this.selectTab(c,b,"");if(this._counting){this._counting.Stop()}},OnNodeClick:function(c){var d=c.target;if(d.tagName=="SPAN"){var a=$(d);var b=a.next().next();var f=d.className;if(f=="fm-b fm-p-plus"){d.className="fm-b fm-p-minus";b.css({display:"block",opacity:0});b.animate({opacity:1},200)}else{if(f=="fm-b fm-p-minus"){d.className="fm-b fm-p-plus";b.css({display:"none"})}}}else{if(d.tagName=="IMG"||d.tagName=="I"){d=d.parentNode}else{if(d.tagName=="LABEL"){d=d.parentNode}}if(d.tagName=="A"){this.selectNode($(d))}}},selectNode:function(d){if(this._loading){return}this._loading=true;this.disposeContent();if(this._node){this._node.removeClass("fm-p-sel")}if(d.length==0){this._node=null;this._loading=false;return}this._node=d;d.addClass("fm-p-sel");var a=d.attr("n");var b=d.attr("data");this._selected=a;var c=this.inputParameters;if(b){c+=(c!=""?",":"")+b}this.attributes=c;$.ajax({type:"POST",url:FM.Path+"DataViewer/ScriptModuleService.asmx/Navigator_Content",contentType:"application/json; charset=utf-8",dataType:"json",data:'{"ticket":"'+this.ticket+'","groupName":"'+this.groupName+'","folderName":"'+a+'","data":"'+c+'"}',success:this._onLoadContent,error:_fm_onHandlerError});if(d[0].changed){this._counting.resetNode(d[0])}if(this.allowChangeUri){App.UI.ChangeUriData(a)}},onLoadContent:function(a){var b=a.d;if(b.Html){this.$content.html(b.Html)}if(!b.typeName){this._loading=false;return}this.node_ticket=b._ticket;window.Runtime_Library.loadObjectType(b.typeName,b.libraryName,b.resources,this._onReadyContent)},onReadyContent:function(a){this._loading=false;var b=this.attributes;var c=this.node_ticket;var d=new a(this.$content,b,c,this._window,null,this._sid);this._sid=null;d.IsNavigatorHost=true;d.OnChangeInput=this._ChangeInput;d.OnRefresh=this._RefreshCounting;this.contentHandler=d;if(!this._bcounting){this._bcounting=true;this.counting_Prepare()}},getSelected:function(){return this._selected?this._selected:this._tab.attr("n")},ChangeInput:function(a){this.inputParameters=a;this.Reload(true)},clearTabs:function(){if(this._tab==null){return}this._tab.removeClass("fm-nav-a-sel");var a=$(this._tabTrees[this._index]);a.css({height:0,display:"none"});this.$content.html("")},selectTab:function(b,d,e){this._index=b;this._tab=d;d.addClass("fm-nav-a-sel");$(this.$cmdBar[0].firstChild).text($("label:first",d).text());var a=$(this._tabTrees[b]);this.$tree=a;if(this.bStart){this.bStart=false;a.css({display:"block",top:0})}else{a.css({display:"block",top:"50px",opacity:0});a.animate({top:0,opacity:1},200,"swing")}var c;if(e!=""){c=$('a[n="'+e+'"]:first',a)}if(e==""||c.length==0){c=$("a:first",a)}this._bcounting=false;this.selectNode(c)},resizePanel:function(){this.$leftInner[0].style.bottom=this.$tabs.height()+"px"},splitter_mdown:function(b){var a=this;Background_ResourceLoader.LoadResources([FM.Path+"DataViewer/Profile/JS/FM.NavUtils.js"],function(){FM.NavUtils_OnSplitterMouseDown(a,b)})},toolbar_click:function(d){var f=d.target;var b=f.tagName;if(b=="B"){var c=$(f);if(c.attr("cmd")=="refresh"){this.Reload(true)}else{var a=this;Background_ResourceLoader.LoadResources([FM.Path+"DataViewer/Profile/JS/FM.NavUtils.js"],function(){FM.NavUtils_OnCmdClick(a,c)})}}},counting_Refresh:function(){if(this._counting){this._counting.Start()}},counting_Prepare:function(){var b=this;var a=function(){if(typeof(FM.NavCount)=="undefined"){Background_ResourceLoader.LoadResources([FM.Path+"DataViewer/Profile/JS/FM.NavCount.js"],function(){FM.NavCount.Init(b)})}else{FM.NavCount.Init(b)}};window.setTimeout(a,200)}};FM.NavPanel=function(g,a,e,c){this.$p=g;this._window=c;this.inputParameters=a;this.ticket=e;this.groupName="";this.tabIndex=0;this._selected="";this._sid=null;if(!c&&App.nodeData){var d=App.nodeData;var b=d.indexOf("/");if(b>0){this._sid=d.substr(b+1);d=d.substr(0,b)}this._selected=d}this.allowChangeUri=false;this.Reload(false);this._onLoadContent=$.proxy(this.onLoadContent,this);this._onReadyContent=$.proxy(this.onReadyContent,this);this.contentHandler=null;this._create_handler=$.proxy(function(f){this.contentHandler=f},this);this._RefreshCounting=$createDelegate(this.counting_Refresh,this);this._ChangeInput=$createDelegate(this.ChangeInput,this)};FM.NavPanel.prototype={dispose:function(){this.disposeContent()},disposeContent:function(){if(this.contentHandler&&typeof(this.contentHandler.dispose)=="function"){this.contentHandler.dispose()}this.contentHandler=null},Reload:function(b){this.tree=null;var a='{"ticket":"'+this.ticket+'","groupName":"'+this.groupName+'","selected":"'+this._selected+'","input":"'+jsonEncode(this.inputParameters)+'","uid":""}';fmExecuteDataService("NavPanel_Generate",a,$.proxy(this._reloadComplete,this));if(this._counting){this._counting.Stop()}},_reloadComplete:function(a){var b=a.d;this.$p.html(b.Html);if(b.HasError){return}this.initNavigator();if(this._window){this._window.setHeader(b.Header)}},initNavigator:function(){this.allowChangeUri=(!this._window);this.$navpanel=$(this.$p.children()[0]);this.$navpanel.addHandler("mousedown",this.OnNodeClick,this);this.$content=null},OnNodeClick:function(a){var b=a.target;if(b.tagName=="IMG"||b.tagName=="I"){b=b.parentNode}else{if(b.tagName=="LABEL"){b=b.parentNode}}if(b.tagName=="A"){this.selectNode($(b))}},selectNode:function(e){if(this._loading){return}if(e.length==0){this._node=null;this._loading=false;return}this._loading=true;if(this.$content==null){this.$contenthdr=$("<div class='fm-nav-contenthdr'></div>");this.$content=$("<div class='fm-nav-content'></div>");this.$p.append(this.$contenthdr).append(this.$content);this.$contenthdr.addHandler("click ",this.back,this)}else{this.disposeContent();this.$contenthdr.show()}this.$content.css("opacity",0).css("display","");var f=e[0].parentNode;while(f.tagName!="DIV"){f=f.parentNode}var b=$(f.previousSibling).find("label").text();this.$contenthdr.html("<i class='fm-ico fm-nav-back'></i><label class='fm-nav-text'> "+b+": "+e.html()+"</label>");this.$navpanel.hide();this._node=e;var a=e.attr("n");var c=e.attr("data");this._selected=a;var d=this.inputParameters;if(c){d+=(d!=""?",":"")+c}this.attributes=d;$.ajax({type:"POST",url:FM.Path+"DataViewer/ScriptModuleService.asmx/Navigator_Content",contentType:"application/json; charset=utf-8",dataType:"json",data:'{"ticket":"'+this.ticket+'","groupName":"'+this.groupName+'","folderName":"'+a+'","data":"'+d+'"}',success:this._onLoadContent,error:_fm_onHandlerError});if(this.allowChangeUri){App.UI.ChangeUriData(a)}},back:function(){this.disposeContent();this.$contenthdr.hide();this.$content.hide();this.$navpanel.fadeIn(200)},onLoadContent:function(a){var b=a.d;if(b.Html){this.$content.html(b.Html)}if(!b.typeName){this._loading=false;return}this.node_ticket=b._ticket;window.Runtime_Library.loadObjectType(b.typeName,b.libraryName,b.resources,this._onReadyContent)},onReadyContent:function(a){this._loading=false;var b=this.attributes;var c=this.node_ticket;var d=new a(this.$content,b,c,this._window,null,this._sid);this._sid=null;d.IsNavigatorHost=true;d.OnChangeInput=this._ChangeInput;this.contentHandler=d;this.$content.hide().css("opacity",1);this.$content.fadeIn(100)},getSelected:function(){return this._selected?this._selected:this._tab.attr("n")},ChangeInput:function(a){this.inputParameters=a;this.Reload(true)},};window.Background_ResourceLoader=new PortalResourceLoader();