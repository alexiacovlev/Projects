var canvas,ctx,canPanel,labels,flag=false,prevX=0,currX=0,prevY=0,currY=0,dot_flag=false;var x="red",lastColorId="red";y=2;var txtPanel=null,txtBox=null,txtSubject,txtDescription;var dx=2,dy=80;var txt_labels=[];function init(){canPanel=document.getElementById("canPanel");canvas=document.getElementById("can");ctx=canvas.getContext("2d");w=canvas.width;h=canvas.height;canvas.addEventListener("mousemove",function(c){findxy("move",c)},false);canvas.addEventListener("mousedown",function(c){findxy("down",c)},false);canvas.addEventListener("mouseup",function(c){findxy("up",c)},false);canvas.addEventListener("mouseout",function(c){findxy("out",c)},false);labels=document.getElementById("labels");if(window.frameElement){window.frameElement._window.setHeader(labels.getAttribute("hdr"));var b=window.frameElement._window.screenshot;var a=new Image();a.onload=function(){ctx.drawImage(this,3,3)};a.src=b;canvas.width=a.width+6;canvas.height=a.height+6;document.getElementById("btnOK").addEventListener("click",save,false);document.getElementById("btnClose").addEventListener("click",close,false)}txtSubject=document.getElementById("Subject");txtDescription=document.getElementById("Description");txtSubject.focus()}function color(a){switch(a.id){case"green":x="#00f000";break;case"blue":x="#06c1ff";break;case"red":x="red";break;case"brown":x="#804040";break;case"black":x="black";break;case"white":x="white";break}if(x=="white"){y=14}else{y=2}document.getElementById(lastColorId).className="c";document.getElementById(a.id).className="c selected";lastColorId=a.id}function draw(){ctx.beginPath();ctx.moveTo(prevX,prevY);ctx.lineTo(currX,currY);ctx.strokeStyle=x;ctx.lineWidth=y;ctx.stroke();ctx.closePath()}function erase(){ctx.clearRect(0,0,w,h)}function findxy(a,b){if(a=="down"){prevX=currX;prevY=currY;currX=b.clientX+canPanel.scrollLeft-dx;currY=b.clientY+canPanel.scrollTop-dy;flag=true;dot_flag=true;if(dot_flag){ctx.shadowBlur=0;ctx.beginPath();ctx.fillStyle=x;ctx.fillRect(currX,currY,2,2);ctx.closePath();dot_flag=false}}else{if(a=="up"||a=="out"){flag=false;if(a=="up"){showTextBox()}}else{if(a=="move"&&flag){prevX=currX;prevY=currY;currX=b.clientX+canPanel.scrollLeft-dx;currY=b.clientY+canPanel.scrollTop-dy;draw()}}}}function showTextBox(){if(!txtPanel){txtPanel=document.getElementById("txtPanel");txtBox=document.getElementById("txtBox");document.getElementById("btnAddText").addEventListener("click",addText,false);document.getElementById("btnCancelText").addEventListener("click",function(){txtPanel.style.display="none"},false)}txtBox.value="";txtPanel.style.left=currX-canPanel.scrollLeft+dx-50+"px";txtPanel.style.top=currY-canPanel.scrollTop+dy+10+"px";txtPanel.style.display="block";txtBox.focus()}function addText(){if(txtBox.value!=""){var a=txtBox.value.split("\n");ctx.fillStyle="blue";ctx.font="bold 16px Tahoma";ctx.shadowColor="white";ctx.shadowBlur=5;for(var b=0;b<a.length;b++){ctx.fillText(a[b],currX,b*18+currY-3)}if(txtSubject.value==""){txtSubject.value=txtBox.value}txt_labels.push((txt_labels.length+1).toString()+". "+txtBox.value);if(txt_labels.length>1){txtDescription.value=txt_labels.join("\n")}}txtPanel.style.display="none"}function showMsg(a){document.getElementById("msg").style.display="block";document.getElementById("msg").textContent=a;window.setTimeout(function(){document.getElementById("msg").style.display="none"},3000)}var is_submit=false;function save(){if(is_submit){return}var a=document.getElementById("Subject").value;if(a==""){showMsg(labels.getAttribute("subject_msg"));return}var c=canvas.toDataURL("image/png");var b=c.replace("data:image/png;base64,","");document.getElementById("screenshot_data").value=b;is_submit=true;document.getElementById("btnOK").style.color="gray";document.forms[0].submit()}function close(a){if(window.frameElement){window.frameElement._window.returnValue=a;window.frameElement._window.close()}};