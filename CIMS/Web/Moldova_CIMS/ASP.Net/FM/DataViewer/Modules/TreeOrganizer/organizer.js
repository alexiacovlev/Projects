FM.TreeOrganizer=function(d,a,c,b){this.$tree=$(d.children()[0]);this.$tree.addHandler("mousedown",this.OnNodeClick,this)};FM.TreeOrganizer.prototype={OnNodeClick:function(f){var g=f.target;if(g.tagName=="SPAN"){var c=$(g);var d=c.next().next();var h=c.attr("class");if(h=="plus"){c.removeClass(h).addClass("minus");d.css({display:"block"})}else{if(h=="minus"){c.removeClass(h).addClass("plus");d.css({display:"none"})}}}else{if(g.tagName=="IMG"){g=g.parentNode}if(g.tagName=="LABEL"){g=g.parentNode}if(g.tagName=="A"){f.stopPropagation();f.preventDefault();var b=$(g);if(this._node!=null&&this._node[0]==g){this.startMoving(f,b)}else{this.selectNode(b)}}}},selectNode:function(b){if(this._node){this._node.removeClass("sel")}this._node=b;this._node.addClass("sel");this.folderName=b.attr("n");var d=$(b.children()[0]);var c=$(d.children()[0]);this.nodeTitle=d.text();this.nodeIcon=c.attr("src").replace("/ASP.Net/Images/ico/","");this.nodeData=b.attr("data")},Close:function(){var a=window.frameElement?window.frameElement._window:window;a.close()},appendNodeUI:function(a,d){var c=a.children();var b=c[0];if(c.length==3){ul=$(c[2])}else{ul=$("<ul></ul>");a.append(ul)}ul.append(d).show();b.className="minus"},addNode:function(){if(!this._node){return}var d=$('<div><div style="white-space:nowrap;margin:10px 20px;"><label style="width:90px" class="fm-lbl">Title:</label><input class="fm" style="width:230px;height:22px;" /></div><div style="white-space:nowrap;margin:10px 20px;"><label style="width:90px" class="fm-lbl">Name:</label><input class="fm" style="width:230px;height:22px;" /></div></div>');var b=d.find("INPUT");var c=$(b[0]);var a=$(b[1]);c.blur(function(){if(a.val()==""){a.val(c.val().replace(/ /g,"_"))}});AX.Window.dialog("Add folder",d,function(){var e=a.val().trim();var f=c.val().trim();if(e==""){e=f.replace(/ /g,"_")}if(e==""||f==""){return false}this.service_handleNode("ADD",e+"|"+f);return true},this);c.focus()},deleteNode:function(){if(!this._node||this.folderName==""||this.folderName==null){return}AX.Window.confirm("Delete Folder","Are you sure you want to delete this folder?",function(){this.service_handleNode("DELETE")},this)},startMoving:function(c,b){if(!this._dragElement){this._dragElement=$("<li style='position:absolute;z-Index:1000;background-color:gray;color:white;padding:4px;width:250px;' class='fm-shadow'></li>");this.$tree.append(this._dragElement);this._dragPointer=$("<div style='height:16px;width:16px;background-image:url(/ASP.Net/FM/Explorer/Images/arrow.gif);position:absolute;left:0;z-Index:1000;display:none;' />");this.$tree.append(this._dragPointer)}this.dy=this.$tree.offset().top;window.status=this.dy;this._dragMoveIn=false;this._dragToNode=null;this._dragNode=b.parent();this._dragElement.html("<a>"+b.html()+"</a><ul></ul>");this.$tree.focus();this.$tree.on({keypress:$.proxy(this.onkeypress,this),mousemove:$.proxy(this.treeOnMove,this),mouseup:$.proxy(this.treeOnMoveEnd,this),mouseover:$.proxy(this.treeOnMoveOver,this)});this._dragNode.css("opacity",0.2);this._dragNode.on("mouseover",$.proxy(this.dragNodeOnMoveOver,this));this.treeOnMove(c);this._dragElement.css("display","")},onkeypress:function(a){if(a.keyCode==27){this._dragToNode=null;this.treeOnMoveEnd()}},treeOnMove:function(a){var b=a.pageY;this._dragElement.css({left:"2px",top:(15+b-this.dy)+"px"})},dragNodeOnMoveOver:function(a){a.stopPropagation();a.preventDefault();var b=$(this._dragElement.children()[1]);b.text("");this._dragPointer.css("display","none");this._dragToNode=null},treeOnMoveOver:function(f){var i=this._dragElement;var c=f.target;if(c.tagName=="IMG"){c=c.parentNode}if(c.tagName=="LABEL"){c=c.parentNode}if(c.tagName=="A"){c=c.parentNode}if(c.tagName=="LI"){var g=$(c);var l=$(g.children()[1]).text();if(l=="Root"){this.dragNodeOnMoveOver(f)}else{var b=g.position();var h=b.top-9;var j=(b.left-2);var k=$(this._dragElement.children()[1]);if(f.shiftKey){this._dragMoveIn=true;h+=15;j-=14;k.text("Move into "+l)}else{this._dragMoveIn=false;k.text("Insert before "+l)}this._dragPointer.css({left:j+"px",top:h+"px",display:""});this._dragToNode=g}}else{if(c.tagName=="SPAN"&&c.className=="plus"){c.className="minus";var d=$(c).next().next();d.css({display:"block"})}}},treeOnMoveEnd:function(b){this.$tree.off("keypress").off("mouseup").off("mousemove").off("mouseover");this._dragElement.css("display","none");this._dragPointer.css("display","none");this._dragNode.off("mouseover");this._dragNode.css("opacity",1);if(this._dragToNode){var a=$(this._dragToNode.children()[1]).attr("n");this.service_handleNode(this._dragMoveIn?"MOVE-IN":"MOVE-BEFORE",a)}},service_handleNode:function(b,a){alert("service_handleNode");return;if(this.folderName==null){return}var a='{"query_ticket":"'+this.query_ticket+'","folderName":"'+this.folderName+'","command":"'+b+'","data":"'+a+'"}';ExecuteService(a,FM.Path+"Modules/TreeOrganizer/SupportService.asmx/HandleNode",$.proxy(this.onHandleComplete,this),_fm_onHandlerError)},onHandleComplete:function(j){var f=j.d;if(f.Error!=null){AX.Window.alert("Operation Cancelled",f.Error);return}var c=f.Value;var g=this.$infoLabel;switch(c){case"ADD":var i=this._node.parent();this.appendNodeUI(i,f.Data);g.text("Folder has been created.");break;case"DELETE":var i=this._node.parent();this.folderName=this._node=this.mapNode=null;var e=i.parent();i.remove();this.checkForChildren(e);if(e.children().length==0){var d=e.parent();e.remove();e=d}g.text("Folder has been deleted.");var h=$("a:first",e);if(!$isNull(h)){this.selectNode(h)}break;case"MOVE-BEFORE":g.text("Folder has been moved.");if(this._dragToNode){var b=this._dragNode.parent();this._dragNode.insertBefore(this._dragToNode);this._dragToNode=null;this.checkForChildren(b)}break;case"MOVE-IN":g.text("Folder has been moved.");if(this._dragToNode){var b=this._dragNode.parent();this.appendNodeUI(this._dragToNode,this._dragNode);g.text("Folder has been moved.");this._dragToNode=null;this.checkForChildren(b)}break}g.show().css({opacity:1}).animate({opacity:0},2000)}};