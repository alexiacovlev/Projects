AX.Timeline=function(b){var a=b.children()[0];this.url=a.getAttribute("source");this.singlemode=(a.getAttribute("mode")=="single");this.handlerName=a.getAttribute("handler");this.p=a;this.$p=$(a);this.group_w=this.singlemode?0:170;this.startPos=this.group_w;this.load();if(this.handlerName){this.$p.addHandler("click",this.onclick,this)}};AX.Timeline.prototype={load:function(){$.getJSON(this.url,$.proxy(function(a){this.data=a;this.redraw()},this))},redraw:function(){this.$p.empty();if(this.data.length==0){this.$p.html("<div style='padding:20px;font-style:italic'>no data</div>");return}this.leftMonth=2;this.rightMonth=4;var h=new Date();var k=h.getFullYear();var e=h.getMonth();var g=h.getDate();var c=new Date(k,e,g);c.setMonth(e-this.leftMonth);this.start=c;var c=new Date(k,e,g);c.setMonth(e+this.rightMonth);this.end=c;this.date=new Date(k,e,g);this.totalDays=Math.round((this.end.getTime()-this.start.getTime())/(1000*3600*24));this.currentDay=Math.round((this.date.getTime()-this.start.getTime())/(1000*3600*24));var l=this.p.offsetWidth;this.panelWidth=l-this.startPos-21;this.k=this.panelWidth/this.totalDays;this.kpx=this.panelWidth/(this.totalDays*1000*3600*24);this.currentPos=Math.round(this.currentDay*this.k);var o=this.start.getMonth();var a=(g==1)?this.start:new Date(k,o,1);var b=this.leftMonth+this.rightMonth;var p="<div class='ax-tm-header'>";for(var f=0;f<b+1;f++){o++;if(o==12){o=0;a.setFullYear(a.getFullYear()+1)}a.setMonth(o);var n=Math.round((a.getTime()-this.start.getTime())/(1000*3600*24));var j=this.startPos+Math.round(this.k*n);p+="<b style='position:absolute;top:5px;left:"+(j)+"px'>"+this.ShortMonths[a.getMonth()]+" "+a.getFullYear()+"</b>";this.$p.append("<div class='ax-tm-line' style='left:"+j+"px'/>")}p+="</div>";this.$p.append("<div class='ax-tm-cur' style='left:"+(this.startPos+this.currentPos)+"px' title='"+this.DateToString(this.date)+"'/>");this.$p.append(p);for(var f=0;f<this.data.length;f++){this.drawGroup(this.$p,this.data[f])}},drawGroup:function(k,p){var t="";t+="<div class='ax-tm-group'>";if(!this.singlemode){t+="<label class='ax-tm-grouptitle' style='width:"+this.group_w+"px'>"+p.Title+"</label>"}var c=this.ParseUtcDate(p.Start);if(c==null||c<this.start){c=this.start}var j=p.Items.length;for(var f=0;f<j;f++){var r=p.Items[f];var a=this.ParseUtcDate(r.Date);var l=a;t+="<div class='ax-tm-row' style='margin-left:"+this.group_w+"px;"+((f==j-1)?"border-bottom:0;":"")+"' title='"+r.Title+"'>";if(c!=null&&a!=null){var n=0;var o=0;var b="";var g="";if(a<=this.start){if(this.singlemode){b+="border-bottom-left-radius:0;border-top-left-radius:0;";g=this.DateToString(l)}else{b+="display:none;"}}else{if(c>this.end){n=this.panelWidth;o=6;b+="border-bottom-right-radius:0;border-top-right-radius:0;background-color:#7cb5ec;border-color:#368ce2;"}else{if(c<this.start){c=this.start;b+="border-bottom-left-radius:0;border-top-left-radius:0;"}if(a>this.end){a=this.end;b+="border-bottom-right-radius:0;border-top-right-radius:0;background-color:#7cb5ec;border-color:#368ce2;"}var h=c.getTime()-this.start.getTime();var e=a.getTime()-c.getTime();n=Math.round(h*this.kpx);o=Math.round(e*this.kpx);if(n>=this.panelWidth){n=this.panelWidth-5}if(this.currentPos>n&&this.currentPos<=n+o){b+="background-color:#feaf44;border-color:#ff9900;"}else{if(n+o>this.currentPos){b+="background-color:#7cb5ec;border-color:#368ce2;"}}if(n+o+100<this.panelWidth){g=this.DateToString(l);if(this.currentPos>n&&this.currentPos<=n+o){g="(+"+Math.round((a.getTime()-this.date.getTime())/(1000*3600*24))+") "+g}}}}if(this.handlerName){b+="cursor:pointer;"}if(o<6){o=6}var q=r.Title;var m="";if(o<30){m="title='"+q+"'";q=""}else{if(o<100){}}t+="<div style='left:"+n+"px;width:"+o+"px;"+b+"' class='ax-tm-box' "+m+" oid='"+r.ID+"'>";t+="<i>"+q+"</i>";t+="<b class='ax-tm-p'></b>";t+="</div>";if(g){t+="<i style='left:"+(n+5)+"px' class='ax-tm-right'>"+g+"</i>"}}t+="</div>";c=a||this.start}t+="</div>";k.append(t)},DateToString:function(b){if(!b){return""}var a=b.getDate();var d=b.getMonth();var c=b.getFullYear();return a+" "+this.ShortMonths[d]+" "+c},ParseUtcDate:function(a){if(a){return new Date(parseInt(a.substr(0,4),10),(parseInt(a.substr(5,2),10)-1),parseInt(a.substr(8,2),10))}else{return null}},onclick:function(a){var b=a.target;if(b.tagName=="I"){b=b.parentNode}if(b.className=="ax-tm-box"){window.fmOpenHandler("CUSTOM/HANDLER",this.handlerName,"open","id="+b.getAttribute("oid"),"1000,700",null)}},ShortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]};