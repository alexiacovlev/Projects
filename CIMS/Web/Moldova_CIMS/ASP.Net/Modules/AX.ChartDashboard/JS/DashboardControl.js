AX.DashboardChartControl=function(f){Chart.defaults.global.maintainAspectRatio=false;Chart.defaults.global.defaultFontColor="#333";var c=f.children()[0];if(!c){return}var b=c.getAttribute("ticket");if(!b){return}var e=c.getAttribute("d");this.panels=f.find("DIV");this.charts=[];for(var a=0;a<this.panels.length;a++){this.charts.push(new AX.Chart(this.panels[a],b,e))}this.dispose=function(){for(var d=0;d<this.charts.length;d++){this.charts[d]._active=false}}};AX.Chart=function(a,b,c){this.panel=a;this.ticket=b;this.d=c;this.name=a.getAttribute("n");this._loaded=false;this._active=true;this.load()};AX.Chart.prototype={load:function(){if(!this._active){return}var a="/ASP.Net/Modules/AX.ChartDashboard/Data.ashx?ticket="+this.ticket+"&n="+this.name;$.get(a).done($createDelegate(this.OnChartLoaded,this)).fail($createDelegate(this.OnChartFailed,this))},OnChartLoaded:function(k,c){if(!k){return}var b=this.panel;b.container=b.parentNode;var h=$(b);if(!this._loaded){h.empty().css("position","relative")}var a="5px";var d=null;try{d=new Function("return "+k)();if(d.error){throw {description:d.error}}var l=d.title;d.options={title:{text:l,display:true,fontSize:16,fontFamily:"'Lucida Grande','Helvetica','Arial',sans-serif"},legend:{display:(d.data.datasets.length>1)}};this.groups=d.data.groups;var f=d.type.indexOf(":");d.subtype="";if(f>0){d.subtype=d.type.substr(f+1);d.type=d.type.substr(0,f)}if(d.type=="custom"){switch(d.subtype){case"value":this.renderValueControl(h,d);break;case"list":this.renderListControl(h,d);break;case"panel":this.renderPanelControl(h,d);break;default:h.empty().append(d.type+" is not supported");break}}else{this.initVisualSettings(d);if(!this._loaded){var j=this.$canvas=$("<canvas></canvas>");h.append(j);this.chart=new Chart(j[0].getContext("2d"),d)}else{if(d.data.labels.length==this.chart.data.labels.length&&d.data.datasets.length==this.chart.data.datasets.length&&d.data.datasets.length==1){this.chart.data.datasets[0].data=d.data.datasets[0].data}else{this.chart.data=d.data}this.chart.update()}if(!this._loaded){this.$btn_max=$("<b class='ax-ico' title='Maximize' style='position:absolute;top:5px;right:5px;cursor:pointer'>&#xa201</b>");a="28px";h.append(this.$btn_max);this.$btn_max.addHandler("click",this.maximize,this)}}if(!this._loaded&&App.User.IsAdmin){this.$btn_edit=$("<b class='ax-ico' title='Modify' style='position:absolute;top:4px;right:"+a+";cursor:pointer'>&#xa081</b>");h.append(this.$btn_edit);this.$btn_edit.addHandler("click",this.openDesigner,this)}this._loaded=true;if(d.interval&&d.interval!="0"){if(!this._reload){this._reload=$createDelegate(this.load,this)}window.setTimeout(this._reload,1000*parseInt(d.interval))}}catch(g){h.empty();this.appendHtmlHeader(h,d);h.append("<div style='padding:10px;'>"+g.description+"</div>")}},OnChartFailed:function(c,b,a){$(this.panel).empty().html("<div style='padding:10px;color:red'>Error loading chart data</div>")},appendHtmlHeader:function(a,b){if(!b||!b.title){return}a.parent().css("text-align","inherit");a.append('<div style="text-align:center;color:#4b4b4b;padding:9px 9px 2px 9px;font-weight:bold;font-family:'+b.options.title.fontFamily+";font-size:"+b.options.title.fontSize+'px;">'+b.title+"</div>")},initVisualSettings:function(c){var a=c.options;var k=c.type;switch(k){case"halfdoughnut":c.type=k="doughnut";a.rotation=1*Math.PI;a.circumference=1*Math.PI;a.legend={display:true,position:"bottom"};break;case"circle":c.type=k="doughnut";a.cutoutPercentage=90;a.legend={display:false};break;case"doughnut":a.legend={display:true,position:"right"};break;case"pie":a.legend={display:true,position:"right"};break}var e=c.data.datasets;var d=c.bgcolors||AX.Chart.bg_colors;var f=d.length;var h=c.bordercolors||AX.Chart.border_colors;var j=h.length;var l=(e.length>1&&k!="bar"||k=="radar");for(var g=0;g<e.length;g++){var b=e[g];b.borderWidth=1;if(k=="pie"||k=="doughnut"){b.backgroundColor=d;b.borderColor="#ffffff"}else{b.backgroundColor=(g<f)?d[g]:d[0];b.borderColor=(g<j)?h[g]:h[0]}if(k=="line"){if(c.subtype=="dashed"){b.borderDash=[5,5];b.fill=false}else{if(c.subtype==""){b.fill=false}}}else{if(k=="bar"){c.options.scales={yAxes:[{ticks:{beginAtZero:true}}]}}}if(l){b.backgroundColor=this.utils_transparentize(b.backgroundColor)}}if(c.allowClick){c.options.onClick=$createDelegate(this.chart_onclick,this)}},chart_onclick:function(h,c){var d=this.chart.getElementAtEvent(h);if(!d||!d.length){return}d=d[0];var g=d._datasetIndex;var b=d._index;var f=d._model.datasetLabel;var a=d._model.label;this.openGrid(a,f,g,this.groups[b],"")},utils_transparentize:function(a,b){var c=b===undefined?0.5:1-b;return Chart.helpers.color(a).alpha(c).rgbString()},maximize:function(b){var a=$(this.panel);if(this._maximized){this._maximized=false;a.remove();this.$parent.append(a);a.css({position:"relative","z-index":"inherit"});a.css({width:this._width+"px",height:this._height+"px"});this.$btn_max.html("&#xa201")}else{this._maximized=true;this.$parent=a.parent();this._width=this.$parent.width();this._height=this.$parent.height();a.remove();a.css({"background-color":"#FFF",position:"absolute",left:0,right:0,"z-index":1000,display:"none",width:"100%",height:"100%"});document.body.appendChild(this.panel);this.$btn_max.html("&#xa202");a.fadeIn(300);a.addHandler("keypress",this.maximize,this);a.focus()}this.$btn_max.addHandler("click",this.maximize,this);if(this.$btn_edit){this.$btn_edit.addHandler("click",this.openDesigner,this)}},renderListControl:function(g,b){if(this._loaded){g.empty()}this.appendHtmlHeader(g,b);var e=b.data;var j=AX.Chart.bg_colors.length;var k=e.datasets[0].data;var l="<div class='ax-chart-custom'>";var a=0;for(var f=0;f<e.labels.length&&f<k.length;f++){var d=(a<j)?AX.Chart.bg_colors[a]:AX.Chart.bg_colors[0];var c=(a<j)?AX.Chart.txt_colors[a]:AX.Chart.txt_colors[0];if(e.labels[f]==""||e.labels[f]=="||"){l+="<div>&nbsp;</div>";continue}var h=this.parseComplexTitle(e.labels[f]);l+="<div class='ax-chart-li' i='"+f+"'>";l+="<div class='ax-chart-lt'>";if(h.ico){l+="<i class='ax-ico ax-chart-lico' style='color:"+h.ico_color+"'>&#x"+h.ico+"</i>"}l+=h.title;l+="</div>";l+="<div class='ax-chart-lv' style='background-color:"+d+";color:"+c+"'>"+k[f]+"</div>";l+="</div>";a++}l+="</div>";g.append(l);if(!this._loaded){g.addHandler("click",this.list_onclick,this)}},list_onclick:function(b){var c=b.target;if(c.className=="ax-chart-lt"||c.className=="ax-chart-lv"){c=c.parentNode}if(c.className=="ax-chart-li"){var a=$(c.firstChild).text();this.openGrid(a,"",c.getAttribute("i"),"","")}},renderValueControl:function(c,e){var h=e.data;var a=AX.Chart.bg_colors.length;var b=h.datasets[0].data;var g=b[0];if(!this._loaded){this.appendHtmlHeader(c,e);var f=this.parseComplexTitle(h.labels[0]);var d="<div class='ax-chart-custom'>";if(f.ico){d+="<i class='ax-ico ax-chart-vico' style='color:"+f.ico_color+"'>&#x"+f.ico+"</i>"}d+="<div class='ax-chart-vdata'>";d+="<div class='ax-chart-vtitle'>"+f.title+"</div>";d+="<div class='ax-chart-vvalue' id='pvalue'>"+g+"</div>";d+="</div>";d+="</div>";c.append(d);c.addHandler("click",this.list_onclick,this)}else{if(this.value!=g){c.find("#pvalue").fadeOut(function(){$(this).text(g).fadeIn()})}}this.value=g},parseComplexTitle:function(d){var b=d.split("|");var e=b[2];var f=null;var a=e.indexOf(":");if(a>0){f=e.substr(a+1);e=e.substr(0,a)}return{title:b[0],description:b[1],ico:e,ico_color:f}},renderPanelControl:function(h,c){if(this._loaded){h.empty()}this.appendHtmlHeader(h,c);var g=c.data;var j=AX.Chart.bg_colors.length;var l="<div class='ax-chart-custom'>";for(var a=0;a<g.datasets.length;a++){if(a>0){l+="<div>&nbsp;</div>"}var b=g.datasets[a];var k=b.data;var f=(a<j)?AX.Chart.bg_colors[a]:AX.Chart.bg_colors[0];var d=(a<j)?AX.Chart.txt_colors[a]:AX.Chart.txt_colors[0];l+="<table class='ax-chart-p' cellpadding='0' cellspacing='0'>";l+="<colgroup>";for(var e=0;e<g.labels.length&&e<k.length;e++){l+="<col/>"}l+="</colgroup>";l+="<tr><td colspan='"+g.labels.length+"' class='ax-chart-ptop' style='background-color:"+f+";color:"+d+"'><div class='ax-chart-phdr'>"+b.label+"</div>"+(b.desc?("<div class='ax-chart-pdesc'>"+b.desc+"</div>"):"")+"</td></tr>";l+="<tr>";for(var e=0;e<g.labels.length&&e<k.length;e++){l+="<td class='ax-chart-pcell'>";l+="<div class='ax-chart-pv'>"+k[e]+"</div>";l+="<div class='ax-chart-pt'>"+g.labels[e]+"</div>";l+="</td>"}l+="</tr>";l+="</table>"}l+="</div>";h.append(l)},openGrid:function(a,g,f,c,b){if(a==null){return}var d=AX.Window.create(null,a+(g!=""?" ("+g+")":""),1000,500);this.$gridPanel=d.$content;var e={ticket:this.ticket,name:this.name,dataset:f,groupvalue:c,filter:b};_fmLoadScriptModule("DashboardDialog_Grid",JSON.stringify(e),this.$gridPanel,null,"",$.proxy(this.onGridCreated,this));d.show()},onGridCreated:function(a){},openDesigner:function(){var a=this;if(!AX.ChartDesigner||AX.ChartDesigner.Open){var b=AX.Window.create(null,"Chart Designer",800,500,true);b.loadASCX("/ASP.Net/Modules/AX.ChartDashboard/Designer.ascx",["/ASP.Net/Modules/AX.ChartDashboard/JS/Designer.js"],function(){new AX.ChartDesigner(b);AX.ChartDesigner.Open(a)})}else{AX.ChartDesigner.Open(a)}}};AX.Chart.bg_colors=["#1aaada","#90ed7d","#434348","#f7a35c","#8085e9","#fe716d"];AX.Chart.border_colors=["#1862ab","#2b9614","#2c2c30","#f37712","#3e46dd","#95004a"];AX.Chart.txt_colors=["#fff","#4b834d","#fff","#fff","#fff","#fff"];