// Core Portal Schell Client Script Library
// Alfa-XP, Michael Isipciuc, 2016.
//
App.SystemPath="/ASP.Net/System/";PortalShell=function(){this.Path="";this.contentObject=null};$(document).ready(function(){App.UI=new PortalShell();App.UI.Init()});PortalShell.prototype={Init:function(){this.Content=$("#content");this.Footer=$("#footer");App_ResizeWindow();App_LoadTabContent();this.manualChange=false;$(window).on("resize",App_ResizeWindow);$(window).on("hashchange",App_LoadTabContent);this.InitMenu($("#appMenu"),$("#appLinks"));$("#loginButton").click(App_Login);$(document.body).preventSelection();if(App.User.IsSiteAdmin){$("#adminButton").click(App_Admin)}this.lastAction=null;this._m_Ping_complete=$createDelegate(this.m_Ping_complete,this);if(App.Settings.PoolingInterval>0){this.timerID=window.setInterval($createDelegate(this.m_Tick,this),App.Settings.PoolingInterval*1000)}else{this.timerID=null}if(App.Settings.Notification){$("#appEvents").append("<i class='ax-ico app-ico-email'></i>");window.setTimeout(function(){Runtime_ResourceLoader.LoadScript(App.SystemPath+"Controls/Notify/ax.notify.js")},2000)}window.setTimeout(function(){$("#shader").fadeOut(300,function(){$("#shader").remove()})},800)},m_Tick:function(){$.ajax({type:"POST",url:App.SystemPath+"PortalService.asmx/Ping",contentType:"application/json;charset=utf-8",dataType:"json",data:'{"a":'+this.lastAction+"}",success:this._m_Ping_complete});this.lastAction=null},m_Ping_complete:function(b){var d=b.d;if(d==null){return}for(var c=0;c<d.length;c++){var a=d[c];switch(a.Type){case"ERROR":this.m_Stop();if(this.m_$bg){this.m_$bg.remove();this.m_$bg=null}App.UI.Content.empty();$("body").children("div.mwnd").hide();AX.Window.alert("System Message",a.Text,App_Reload);break;case"ALERT":AX.Window.alert(a.Hdr,a.Text);break;case"MESSAGE":AX.Window.alert(a.Hdr,a.Text);break;case"NOTIFY":AX.Window.notify(a.Hdr,a.Text);break;case"LOCK":this.isLocked=true;this.m_Lock(a.Text,0);break;case"LOGOUT":this.m_Stop();ExecuteService(null,App.SystemPath+"Auth/Service.asmx/SignOut",null);App.UI.Content.empty();this.m_Lock(a.Text,1);return}}},m_Stop:function(){if(this.timerID){window.clearInterval(this.timerID)}this.timerID=null},m_Lock:function(b,a){this.lockMode=a;if(this.m_$bg){this.m_$bg.remove()}this.m_$bg=$("<div style='position:absolute;z-index:10000;width:100%;height:100%;top:0;'><div style='position:absolute;width:100%;height:100%;background-color:#000;opacity:0.4;'></div><h1 style='position:relative;text-align:center;color:white;top:45%;font-family:Comic Sans MS;font-size:18pt;'>"+b.replace(/&lt;/g,"<").replace(/&gt;/g,">")+"</h1></div>");document.body.appendChild(this.m_$bg[0]);this.m_$bg.click((a==1)?function(){App_Reload()}:App_Reload)},Notify:function(b){this.lastAction='"'+b+'"'},InitMenu:function(e,h){var a="/#"+App.nodeName;var g=null;var f=e.children();for(var c=0;c<f.length;c++){if(f[c].getAttribute("href")==a){g=f[c];break}}if(!g){f=h.children();for(var c=0;c<f.length;c++){if(f[c].getAttribute("href")==a){g=f[c];break}}}if(g){this.menu_selected=g;$(g).addClass("selected")}var d=e.attr("loadscript");var b=$createDelegate(this.menuClick,this);e.click(b);h.click(b)},menuClick:function(a){var b=a.target;if(b.tagName=="SPAN"||b.tagName=="I"){b=b.parentNode}if(b.tagName=="A"){if(this.menu_selected){$(this.menu_selected).removeClass("selected")}this.menu_selected=b;$(b).addClass("selected")}},ChangeUriData:function(a){if(App.nodeData==a){return}App.nodeData=a;App.manualChange=true;window.location.href="#"+App.nodeName+"/"+a}};function App_ResizeWindow(){}function App_Notify(b){App.lastAction='""'}function App_LoadTabContent(){if(App.manualChange){App.manualChange=false;return}var href=this.location.href;var i=href.indexOf("#");var name=(i>0)?href.substr(i+1):App.Settings.Page;i=name.indexOf("/");App.nodeName=name;App.nodeData="";if(i>0){App.nodeName=name.substr(0,i);App.nodeData=name.substr(i+1)}if(App.UI.contentHandler&&typeof(App.UI.contentHandler.dispose)=="function"){App.UI.contentHandler.dispose()}App.UI.contentHandler=null;App.UI.Content.empty();$.ajax({type:"POST",url:App.SystemPath+"ScriptModuleService.asmx/ResolveTabHandler",contentType:"application/json; charset=utf-8",dataType:"json",data:'{"name":"'+App.nodeName+'"}',success:function(result){var res=result.d;if(res.Html){App.UI.Content.html(res.Html)}if(res.ErrorCode==0&&res.typeName){var ticket=res._ticket;var oncreate=function(_typeReference){App.UI.contentHandler=new _typeReference(App.UI.Content,"",ticket,null)};window.Runtime_Library.loadObjectType(res.typeName,res.libraryName,res.resources,oncreate)}else{if(res.ErrorCode==2){if(!App.User.IsAuthenticated){App_Login(true,false)}}}},error:function(xhr,status,thrownError){var err=eval("("+xhr.responseText+")");App.UI.Content.html("<div style='margin:50px;font-size:16px'>"+err.Message+"</div>")}})}function _CreateFramePanel(b,e,a,c){var d=$("<div class='dialogWithDropShadow' style='position:relative;padding:4px;width:"+a+"px;height:"+c+"px;margin:0 auto;'></div>");d.html("<iframe src='"+b+"' style='width:100%;height:100%;background-color:#FFF;' frameborder='0' scrolling='auto'></iframe>");return d}function App_Admin(a){var b=(a=="AddContent")?function(){Portal.AddContentDialog()}:function(){new Portal.AppManager()};Runtime_ResourceLoader.LoadResources(["/ASP.Net/WebAdmin/AppManager/Portal.AppManager.js"],b)}function App_Login(a,d){if(typeof(a)=="object"){a=!App.User.IsAuthenticated}if(a){App.UI.Content.empty();var c=$("<div></div>");App.UI.Content.append(c);c.load(App.SystemPath+"Component.aspx?path=Auth/LoginWindow.ascx")}else{App_SignOut()}}function App_Role(){Runtime_ResourceLoader.LoadResources([App.SystemPath+"Auth/ChangeRoles.js"],function(){AX.Auth_ChangeRoles()})}function App_SignIn(b,d,a,c){ExecuteService("{userName:'"+b+"', password:'"+d+"', persistent: '"+a+"'}",App.SystemPath+"Auth/Service.asmx/Authenticate",App_Reload,c)}function App_SignOut(){ExecuteService(null,App.SystemPath+"Auth/Service.asmx/SignOut",App_Reload)}function App_SetLanguage(a){ExecuteService("{lcid:'"+a+"'}",App.SystemPath+"Auth/Service.asmx/SetLanguage",App_Reload)}function App_Reload(){window.location.reload()}function App_PostIncident(a,b){Runtime_ResourceLoader.LoadResources(["/ASP.Net/FM/DataViewer/Modules/PostIncident.js"],function(){AX.Incident.OpenWindow(a,b)})}App_PortalMenu=function(c,j,o,e){this.settings=e;this.$back=$('<li class="back"><div class="left"></div></li>').appendTo(c);var l=$("li",c[0]);var p=null;var k=$("a",l);for(var h=0;h<k.length;h++){var m=k[h];var b=m.href.substr(m.href.indexOf("#")+1);if(b==o){p=$(m).parent()[0];break}}if(o==""){p=$("li.current",this)[0]||$(l[0]).addClass("current")[0]}var g=$.proxy(this.move,this);l.not(".back").hover(g,null);var f=$.proxy(this.move_out,this);c.hover(null,f);l.click($.proxy(function(a){this.setCurr(a.currentTarget)},this));var d=$.proxy(function(){this.setCurr(null)},this);j.click(d);this.setCurr(p)};App_PortalMenu.prototype={setCurr:function(c){var a=(c)?c.offsetLeft:0;var b=(c)?c.offsetWidth:0;this.$back.css({left:a+"px",width:b+"px"});this.curr=c},move_out:function(a){this.move(null)},move:function(d){var c=(d)?d.currentTarget:this.curr;var a=(c)?c.offsetLeft:0;var b=(c)?c.offsetWidth:0;this.$back.each(function(){$(this).dequeue()}).animate({width:b,left:a},this.settings.speed,this.settings.fx)}};AX.HtmlViewer=function(h,b,g,e){h.html("<div id='HtmlViewer' style='height:100%;overflow-y:auto;'/>");var a=$(h.children()[0]);var f="id="+g+"&lcid="+App.Settings.LCID;a.load("/ASP.Net/System/HtmlLoader.ashx?"+f);if(App.User.IsSiteAdmin){var d=$("<img src='/ASP.Net/System/Images/edit.gif' title='Edit' style='position:absolute;top:3px;right:3px;cursor:pointer;'/>");h.append(d);var c="/ASP.Net/WebAdmin/HtmlDesigner/?mode=PAGE&"+f;d.click(function(){h.html("<iframe src='"+c+"' style='width:100%;height:100%;' frameborder='0'></iframe>")})}this.dispose=function(){}};